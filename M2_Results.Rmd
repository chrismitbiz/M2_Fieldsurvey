---
title: "A preliminary field survey indicated that carbon quality is a driver for the metabolic capacity of soils to biodegrade persistant organic pollutants"
subtitle: "Associations of organic matter quality and soil diversity to long term dieldrin loss"
output: 
 bookdown::html_document2:
  fig_caption: yes
  toc: yes
  toc_float: true
  number_sections: false
 bookdown::word_document2:
    reference_docx: "M2_Results_template.docx"
 bookdown::pdf_document2:
   keep_tex: true
editor_options: 
  chunk_output_type: inline
always_allow_html: true
bibliography: "library.bib"
biblio-style: "apalike"
link-citations: yes
nocite: |
  @Baldock2013
  @Karp2002a
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
  encoding=encoding,
  output_file=file.path(dirname(input_file), out_dir, 'index.html'))})

---

```{r load-packages, include=TRUE, echo=FALSE,warning=FALSE, message=FALSE}
#knit: (function(input_file, encoding) {
#  out_dir <- 'docs';
#  rmarkdown::render(input_file,
#  encoding=encoding,
#  output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
library(ggrepel)
library(qiime2R)
library(tidyverse)
library(stringr)
library(ggplot2)
theme_set(theme_bw())  
library(vegan)
library(ggpubr)
library(phyloseq)
library(psych)
library(reshape2)
library(ggfortify)
library(factoextra)
library(knitr)
library(microbiome)
library(SpiecEasi)
library(bookdown)
library(tinytex)
library(metagMisc)
options(kableExtra.auto_format = FALSE)
library(kableExtra)
library(magick)
library(picante)
#library(flextable)
```



Note: Graphs are intended to be informational only and are not 'publication quality'. Typos and errors definitely included.  
  
  
  

# Summary of results
- We investigated two soils with differing abilities to degrade dieldrin after 30 years.
- The soil better able to degrade dieldrin (Kurosol) was phylogenetically and metabolically more heterogeneous (Fig. \@ref(fig:pcoa)) and contained less carbon and a lower proportion of resistant organic carbon (Fig. \@ref(fig:carbonquality)).
  - The genetic potential of metabolic pathways in this soil was more associated to relative amounts of resistant organic carbon (ROC) and humus (HUM) than to particulate organic carbon (POC) (Fig. \@ref(fig:plsheatmapsku)) . In other words, the genetic potential of more metablic pathways coincided with having relatively more ROC and HUM indicating that the Kurosol metabolism was adapted to processing ROC and HUM.
  - The results suggest, that a soil that has a higher turnover of ROC and HUM will also degrade persistent pollutants faster.
- Alpha diversity was not different between the two soils (Fig. \@ref(fig:alphadloss)).
  - However, given the markedly lower total carbon and energy resources in the Kurosol (which contained less total carbon), this soil in fact had a higher diversity per unit of total carbon (and energy sources).
  - Furthermore figure \@ref(fig:alphaperD17) shows that alpha diversity relative to dieldrin concentrations in the soil was significantly higher in the Kurosol compared to the Chromosol.
  - Some potentials of metabolic pathways, known to be involved with xenobiotic degradation such as phenolic-compound-degradation or toluene degradation are actually similar or greater in the Chromosol, the soil that evidently did not degrade dieldrin as fast as the Kurosol. But when this potential is normalised to total carbon, then the Kurosol had a greater potential. 
  - This study therefore suggests that the ability of a soil to degrade persistant pollutants is not associated with a measure of total diversity or metabolic potential but instead with greater diversity and metatbolic potential relative to the available carbon sources (here measured as total carbon). In effect, there was a greater 'efficiency' of the soil diversity.
- Phylogenetic composition of bacteria was similar on phylum level between the Kurosol and Chromosol but there were differences in the distribution of unique ASVs that were present only in samples with either high or low dieldrin loss (Fig. \@ref(fig:trees)).
  - In the Kurosol a clade of Firmicutes, Bacteriodetes, Actinobacteria, Chloroflexi and the genus Geobacter were all more likely to be found in high-loss samples than in low loss samples.
  - There were no clades found in the Chromosol that could be associated with samples that had higher dieldrin losses in this soil.
- The association network of bacteria and fungi in the Kurosol (Fig \@ref(fig:networkallpictureKUROSOLlowhigh)) revealed a clear separation of associations that cluster around ASVs that were unique in the high-loss samples and ASVs that were unique in low-loss samples, indicating those unique ASVs were driven by different environmental conditions and where an integral part in mediating associations.
- There was no such clear grouping in the Chromosol.
  
# Hypothesis
Quality of soil organic matter is associated with the phylogenetic and metabolic capacity of soils to degrade persistent organic pollutants - here dieldrin.
  
# Materials and Methods
## Site and soil description, dieldrin and total carbon measurements
Site location and details, sampling procedure and soil physicochemical characteristics were described previously [@Krohn2019]. Briefly, we sampled two agricultural surface soils (0 - 10 cm, n = 36), a Kurosol and a Chromosol [@Isbell1996], which comprised of twelve grazed pastures that were subject to the Australian National Organochlorine Residue Management Plan [@DepartmentofNaturalResourcesandEnvironment1996] of which we obtained detailed records of dieldrin concentrations since 1987. 
  
It was found that both surface soils consisted of a similar texture which were classified as loam [@InternationalSocietyofSoilScienceISSS1929]. Furthermore, they had the same average pH (4.55 ± 0.04 SE) and were both in high-rainfall zones with similar annual maximum temperatures (20.9 - 21.9 ˚C). However, they differed in total carbon (TC) concentrations, in that the Kurosol measured just over half the carbon concentrations compared to the Chromosol (33.3 and 61.8 mg g^-1^, ± 1.05 and 1.72 SE).
  
The long-term dieldrin loss (%) per paddock was calculated using the average dieldrin concentrations from 2015/2017 and the earliest available concentrations (1987- 1995). The two soils differed in their apparent ability to degrade dieldrin as the Kurosol lost 1.7 times more dieldrin compared to the Chromosol (73 and 42 %, ± 0.07 and 0.04 SE) and it was found that the TC, the carbon-to-nitrogen ratio (C:N), the microbial-carbon-to-total-carbon ratio (MBC:TC) and soil diversity were associated with final dieldrin concentrations and dieldrin loss (%) [@Krohn2019].
  
## Estimation of soil fractions
Soil processing and acquisitions of infrared spectra followed the method set out in @Madhavan2017. Briefly, sieved (≤ 2 mm) and air dried soils were finely ground in a ball mill (Retsch MM400, Germany) at 25 rounds per second for 30 seconds. Diffuse reflectance spectra in the mid-and near-infrared (MNIRS) spectra (7800  - 450 cm-1 at 8 cm-1 resolution) were acquired for all samples using a PerkinElmer Frontier FT-NIR-MIR Spectrometer (PerkinElmer Inc., Waltham, MA, USA) equipped with a KBr beam-splitter, a DTGS detector and AutoDiff automated diffuse reflectance accessory (Pike Technologies, Madison, WI, USA). 
  
Spectra were pre-processed as described in @Madhavan2017 and concentrations of total organic carbon (TOC), particulate organic carbon (POC), resistant organic carbon (ROC) and humus (HOC) were predicted from MNIRS spectra of the Australian Soil Carbon Research Project (ScaRP, Baldock et al. 2013) using partial least squares (PLS) regression. To assess prediction accuracy the TOC concentrations from the PLS predictions were correlated with TC measurements of the same samples using a dry combustion analyzer (Perkin Elmer 2400 Series Ⅱ, R^2^ = 0.98). For all downstream analyses, POC, ROC and HOC were transformed into percentages or centered log ratios [@Bruckner2017a]. 

## Diversity measurements
DNA of 0.25 g fresh soil was extracted using Powersoil DNA isolation kit (MoBio, Calsbad, USA) and stored at -20 ˚C. Marker genes were sequenced with 15% phiX control on a Illumina MiSeq platform (2 × 300) to determine bacterial and fungal diversity. For bacteria the V4 hypervariable region of the 16S-rRNA gene was targeted with primers 515F (GTGYCAGCMGCCGCGGTAA) / 806R (GGACTACNVGGGTWTCTAAT) [@Apprill2015; @Caporaso2012; @Walters2016] and for fungi the Internal Transcrined Spacer (ITS) region 2 [@Blaalid2013] with primers FITS7 (GTGARTCATCGAATCTTTG)/ITS4 (TCCTCCGCTTATTGATATGC) [@Egidi2019; @Katarina2012]. 
  
The default settings of Qiime2 (v2020.2) [@Bolyen2019b] were used to assess quality of paired end reads, trim primers [@Martin2011], denoise and dereplicate sequences and filter chimeras (dada2) [@Callahan2016]. Sequences with number of expected errors >2 were discarded and 66% (bacteria) and 52% (fungi) of sequences were retained after filtering. Moreover a total of 19,918 and 4,712 unique amplicon sequence variants (ASVs) (bacteria and fungi respecively) were identified. Qiime2 was then used to train primer-specific classifiers using silva reference sequences (v132 at 99% similarity) for bacteria [@Quast2013a] and unite reference sequences (v8 dynamic) for fungi [@Community2019] and the classifiers were then used to assign taxonomic classifications to ASVs with qiime feature-classifier classify-sklearn [@Bokulich2018].
  
For bacterial ASVs a phylogenetic tree was created using the SATé-enabled phylogenetic placement (SEPP) technique [@Janssen2018] with the silva128 SEPP reference. By default sequences < 75% similarity by sequence identity to any record in the tree were not inserted into the tree.


## Metacyc pathway associations to carbon fractions and dielrin concentrations
The Picrust2 (Phylogenetic Investigation of Communities by Reconstruction of Unobserved States 2) software  [@Douglas2019] was used to predict metabolic pathways (Metacyc, Karp 2002) based on the sequenced bacterial ASVs. Briefly, the picrust pipeline placed ASVs into a open-source reference tree based on prokaryotic genomes from the Integrated Microbial Genomes database [@Barbera2018; @Czech2020a; @Markowitz2012], inferred gene abundances per ASV [@Louca2018] and then predicted sample pathway abundances using MinPath [@Ye2009]. The full pipeline (https://github.com/picrust/picrust2/wiki/Full-pipeline-script) was run with default settings, except that the maximum Nearest Sequence Taxon Index (NSTI) was set to 0.65 in favour of greater accuracy of predictions. Prior to analysis, the ASV table was filtered to those ASVs that were present in at least two samples and with a minimum frequency of 10 reads. The final table output of pathway abundances represented the predicted metabolic potential.  
  
  
Sparse partial least squares (sPLS) analysis of the mixOmics package [@Rohart2017] was chosen to explore associations between metabolic pathway potentials and soil variables (ROC, HUM, POC, C:N ratio, H:C ratio and average dieldrin concentrations of 2015/2017). sPLS is a dimension reduction technique that integrates two high-dimensional data sets acquired from the same samples (here predicted pathway potentials and soil variables) to highlight general patterns of associations [@Meng2016b; @LeCao2008]. This method performs well when the number of samples (*n*) is smaller than the measured variables (*p*) and when variables exhibit multicollinearity.  
  
The analysis was done in regression mode, whereby components of pathway potentials were regressors for components of soil variables under the assumption that metabolic pathways can be predictive of soil variables. The first two components were selected as they had sufficient predictive power based on the Q^2^ cutoff of 0.0975 [@LeCao2008; @Tenehaus1998]. Finally, a heatmap with Ward clustering was created from the first two components of sPLS to display pair-wise associations between pathways and soil variables. Only associations scores >= 0.50 were shown.

<br/> 

# Data set
  
Note: This section gives an overview of metadata and the data of bacterial and fungal amplicon sequence variants (ASVs) used as basis for all analyses. It not intendet for publication but may be supplementary.
  
## Metadata
```{r metadata, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE}
metadata<-read_tsv("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/M2_Qiime_output_Bacteria2020run/metadata.tsv") #requires tidyverse
metadata2 <- metadata[c(2:37),]
# Converting columns to numeric using "tidyverse"
metadata2 <- metadata[c(2:37),] %>%
  rownames_to_column("spl")%>%
  mutate_all(type.convert) %>%
  mutate_if(is.factor, as.character)%>%
  column_to_rownames("spl")
# Add clr transformed carbon composition
# Compute percentage frequencies of carbon fractions including dieldrin and ddt
percentData <- data.frame(metadata2[c(33:35,37)])
sum_c <- apply(percentData, 1, sum) #Equates to TOC
percentData <- 100*percentData/sum_c 
percentData <- round(percentData, 2) # Round the sorted output to 1 digit
percentData$`#SampleID` <- metadata2$`#SampleID`
percentData <- percentData %>% rename(HUM.pct = HUM) %>% rename(POC.pct = POC ) %>% rename(ROC.pct = ROC) %>% rename(Delta.C.Frac.pct = Delta.C.Frac)
metadata2 <- metadata2 %>% left_join(percentData, by = "#SampleID") #add percent data

require(compositions)
c_comp <- data.frame(clr(percentData)) %>% dplyr::select(- X.SampleID)
c_comp$`#SampleID` <- metadata2$`#SampleID`
c_comp  <- c_comp %>% rename(HUM.clr = HUM.pct) %>% rename(POC.clr = POC.pct ) %>% rename(ROC.clr = ROC.pct) %>% rename(Delta.C.Frac.clr = Delta.C.Frac.pct)  
metadata2 <- metadata2 %>% left_join(c_comp, by = "#SampleID")

#defining factors
metadata2$Soil <- factor(metadata2$Soil, levels=c("Kurosol", "Chromosol"))
metadata2$Paddock <- factor(metadata2$Paddock, 
                            levels=c("1", "2", "3", "4","5", "6","7", "8","9", "10","11", "12"))
metadata2$Dloss_fct <-  factor(metadata2$Dloss_fct, 
                               levels=c("<=30%", "<=50%", "<=70%", ">70%"))
metadata2$Dloss_fct2 <-  factor(metadata2$Dloss_fct2, 
                               levels=c("<=43%", ">43%", "<72%", ">=72%"))
kable(metadata2[c(1:5,33:36),c("Soil","Paddock", "Farm", "Dloss", "D1517", "ROC", "HUM", "POC", "CN", "HC")], booktabs=TRUE) %>% kable_styling(latex_options="scale_down")
```

## Bacteria
```{r physeqb object,include=TRUE, echo=FALSE, warning=FALSE,message=FALSE, cache=TRUE}
#SVs <-read_qza("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/M2_Qiime_output_Bacteria2020run_200317/feature_table_insertfilt_min10readsmin2spls.qza")
SVs <-read_qza("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/M2_Qiime_output_Bacteria2020run_200317/feature_table_insertiontreefiltered_gg.qza")
taxonomy <- read_tsv("/Users/christiankrohn/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/M2_Qiime_output_Bacteria2020run_200317/taxonomy_gg.tsv") %>% filter(Taxon != "categorical")  %>% rename(Feature.ID = `Feature ID`)
#taxonomy <- read_qza("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/M2_Qiime_Bacteria/Re_runwithCutadapt2019_28Nov/taxonomy_gg_M2.qza")
taxtable <- taxonomy %>% as_tibble() %>% separate(Taxon, sep=";", c("Kingdom","Phylum","Class","Order","Family","Genus","Species")) 
tree <- read_qza("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/M2_Qiime_output_Bacteria2020run_200317/insertion-tree_gg.qza")

physeqB <- phyloseq(
  otu_table(SVs$data, taxa_are_rows = T), 
  phy_tree(tree$data), 
  tax_table(as.data.frame(taxtable) %>% dplyr::select(-Confidence) %>% column_to_rownames("Feature.ID") %>% as.matrix()), 
  sample_data(metadata2 %>% as.data.frame() %>% column_to_rownames("#SampleID")))
#take out sample C20 as it failed in this run. 
physeqB <- prune_samples(samples = (sample_names(physeqB)!= c("C20")), physeqB )
physeqB <- prune_taxa(taxa_sums(physeqB) != 0, physeqB)
#adding diversity measures (with ps object) to metadata and re-create ps object 
#here a decision has to be made on sample size. Look at feature-table.qzv to see how many samples are lost with x sample size or how many features are lost with minimum sample size. This is used ONLY for diversity metrics (not differentially abundance anaylyis which I filter separately. So I generally use the minimum samples size if different between min/max is within 10fold. 

rare_Bac <- rarefy_even_depth(physeqB, sample.size = min(colSums(otu_table(physeqB))),  rngseed = TRUE, replace = TRUE, trimOTUs = TRUE)
ps.div <- estimate_richness(rare_Bac)
ps.div$`#SampleID` <- sample_names(physeqB)
meta.df <- data.frame(sample_data(physeqB))
meta.df <- meta.df %>% rownames_to_column("#SampleID") %>% 
  left_join(ps.div, by = "#SampleID") %>% column_to_rownames("#SampleID")
meta.df$pielou_ev <- ps.div$Shannon/log(ps.div$Observed)      #Pielou eveness
#adding carbon ratios
meta.df <- meta.df %>% rownames_to_column("OTUID") %>%
  mutate(observed_C = Observed / TC) %>%
  mutate(shannon_C = Shannon / TC) %>%
  mutate(simpson_C = InvSimpson / TC) %>% 
  mutate(evenness_C = pielou_ev / TC) %>% 
  mutate(bcop_C = b_copies_ngDNA / TC) %>% 
  mutate(fcop_C  = f_copies_ngDNA / TC) %>% 
  mutate(observed_D17 = Observed / D17) %>%
  mutate(shannon_D17 = Shannon / D17) %>%
  mutate(simpson_D17 = InvSimpson / D17) %>% 
  mutate(evenness_D17 = pielou_ev / D17) %>% 
  mutate(ROC_D17 =ROC / D17) %>% 
  mutate(HUM_D17 = HUM / D17) %>% 
  mutate(POC_D17 = POC / D17) %>% 
  mutate(TC_P = TC / P) %>% 
  mutate(TC_D17 = TC / D17)  %>% column_to_rownames("OTUID")
physeqB@sam_data <- sample_data(meta.df)

#filter 
#minimum of reads per feature
physeqB.flt = prune_taxa(taxa_sums(physeqB) >= 10, physeqB) #minimum reads per feature
physeqB.flt = filter_taxa(physeqB.flt , function(x) sum(x > 0) > (0.06*length(x)), TRUE) #minimum presense in x% of samples
#filter any phyla that have not been classified i.e. are "NA"
physeqB.flt = subset_taxa(physeqB.flt, !is.na(Phylum) & !Phylum %in% c("", "uncharacterized"))

#rarefaction curve
rarecurve(t(otu_table(physeqB.flt)), step=200, sample = min(colSums(otu_table(physeqB.flt))), label = FALSE, xlab = "Sample Size after filtering") 

#taxatables for reference
taxtableB.fltr <- data.frame(phyloseq::tax_table(physeqB.flt)@.Data)
taxtableB.fltr <- taxtableB.fltr %>% rownames_to_column(var = "Id")
# Make a data frame with a column for the read counts of each sample
sample_sum_df <- data.frame(sum = sample_sums(physeqB.flt))
summary(sample_sum_df$sum)

#histograms
# Histogram of sample read counts
ggplot(sample_sum_df, aes(x = sum)) + 
  geom_histogram(color = "black", fill = "indianred") +
  ggtitle("Distribution of sample sequencing depth (filtered)") + 
  xlab("Read counts") +
  theme(axis.title.y = element_blank())

# barplot with red line through median value
dat2 <- t(otu_table(physeqB.flt)) %>% melt(.) %>% arrange(desc(value))
ggbarplot(data = dat2, x = "Var2", y = "value",xlab = "Filtered", order = unique(dat2$Var2)) + geom_hline(yintercept=median(rowSums(otu_table(physeqB.flt))), color="red")

physeqB.flt

summary(taxa_sums(physeqB.flt))

print(paste("The minimum and maximum number of quality bacterial sequences before filtering (per sample) in this data set is",min(colSums(otu_table(physeqB))),"and", max(colSums(otu_table(physeqB))),". After filtering this changed to", min(colSums(otu_table(physeqB.flt))),"and",max(colSums(otu_table(physeqB.flt))) ))

print(paste("The number of reads and ASVs left after filtering is",round(sum(taxa_sums(physeqB.flt)) / sum(taxa_sums(physeqB))*100,2),"% and",round(ntaxa(physeqB.flt) / ntaxa(physeqB) *100,2),"%, a change from",round(sum(taxa_sums(physeqB))),"to",round(sum(taxa_sums(physeqB.flt))), "reads and", ntaxa(physeqB),"to",ntaxa(physeqB.flt),"ASVs. The median changed from", median(rowSums(otu_table(physeqB))),"to",median(rowSums(otu_table(physeqB.flt))),"reads per ASV."))

```
## Fungi
```{r physeqf object,include=TRUE, echo=FALSE, warning=FALSE,message=FALSE, cache=TRUE}
#FUNGI
SVs <- read_qza("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Fungi/M2_Qiime_Fungi/feature_table_M2Fungi.qza")
# Renaming samples to match the second run
SVs <- SVs$data %>% as.data.frame %>% rename("C01" = "C-1") %>% rename("C02" = "C-2") %>% rename("C03" = "C-3") %>% rename("C04" = "C-4") %>% rename("C05" = "C-5") %>% rename("C06" = "C-6") %>% rename("C07" = "C-7") %>% rename("C08" = "C-8") %>% rename("C09" = "C-9") %>% rename("C10" = "C-10") %>% rename("C11" = "C-11") %>% rename("C12" = "C-12") %>% rename("C13" = "C-13") %>% rename("C14" = "C-14") %>% rename("C15" = "C-15") %>% rename("C16" = "C-16") %>% rename("C17" = "C-17") %>% rename("C18" = "C-18") %>% rename("C19" = "C-19") %>% rename("C20" = "C-20") %>% rename("C21" = "C-21") %>% rename("C22" = "C-22") %>% rename("C23" = "C-23") %>% rename("C24" = "C-24") %>% rename("C25" = "C-25") %>% rename("C26" = "C-26") %>% rename("C27" = "C-27") %>% rename("C28" = "C-28") %>% rename("C29" = "C-29") %>% rename("C30" = "C-30") %>% rename("C31" = "C-31") %>% rename("C32" = "C-32") %>% rename("C33" = "C-33") %>% rename("C34" = "C-34") %>% rename("C35" = "C-35")%>% rename("C36" = "C-36")
    
taxonomy<-read_qza("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Fungi/M2_Qiime_Fungi/taxonomy_unite-ver8_M2Fungi.qza")
taxtable <- taxonomy$data %>% as_tibble()%>% dplyr::select(-Confidence) %>% separate(Taxon, sep=";", c("Kingdom","Phylum","Class","Order","Family","Genus","Species")) 
physeqF<-phyloseq(
  otu_table(SVs, taxa_are_rows = T), 
  tax_table(as.data.frame(taxtable)  %>% column_to_rownames("Feature.ID") %>% as.matrix()), 
  sample_data(metadata2 %>% as.data.frame() %>% column_to_rownames("#SampleID")))

#adding diversity measures (with ps object) to metadata and re-create ps object 
#here a decision has to be made on sample size. Look at feature-table.qzv to see how many samples are lost with x sample size or how many features are lost with minimum sample size. This is used ONLY for diversity metrics (not differentially abundance anaylyis which I filter separately. So I generally use the minimum samples size if different between min/max is within 10fold. 

rare_Fun <- rarefy_even_depth(physeqF, sample.size = min(colSums(otu_table(physeqF))),  rngseed = TRUE, replace = TRUE, trimOTUs = TRUE)
ps.div <- estimate_richness(rare_Fun)

ps.div$`#SampleID` <- sample_names(physeqF)
meta.df <- data.frame(sample_data(physeqF))
meta.df <- meta.df %>% rownames_to_column("#SampleID") %>% 
  left_join(ps.div, by = "#SampleID") %>% column_to_rownames("#SampleID")
meta.df$pielou_ev <- ps.div$Shannon/log(ps.div$Observed)      #Pielou eveness
#adding carbon ratios
meta.df <- meta.df %>% rownames_to_column("OTUID") %>%
  mutate(observed_C = Observed / TC) %>%
  mutate(shannon_C = Shannon / TC) %>%
  mutate(simpson_C = InvSimpson / TC) %>% 
  mutate(evenness_C = pielou_ev / TC) %>% 
  mutate(bcop_C = b_copies_ngDNA / TC) %>% 
  mutate(fcop_C  = f_copies_ngDNA / TC) %>% 
  mutate(observed_D17 = Observed / D17) %>%
  mutate(shannon_D17 = Shannon / D17) %>%
  mutate(simpson_D17 = InvSimpson / D17) %>% 
  mutate(evenness_D17 = pielou_ev / D17) %>% 
  mutate(ROC_D17 =ROC / D17) %>% 
  mutate(HUM_D17 = HUM / D17) %>% 
  mutate(POC_D17 = POC / D17) %>% 
  mutate(TC_D17 = TC / D17)  %>% column_to_rownames("OTUID")
physeqF@sam_data <- sample_data(meta.df)

#filter 
#minimum of reads per feature
physeqF.flt = prune_taxa(taxa_sums(physeqF) >= 10, physeqF) #minimum reads per feature
physeqF.flt = filter_taxa(physeqF.flt , function(x) sum(x > 0) > (0.06*length(x)), TRUE) #minimum presense in x% of samples
#filter any phyla that have not been classified i.e. are "NA"
physeqF.flt = subset_taxa(physeqF.flt, !is.na(Phylum) & !Phylum %in% c("", "uncharacterized"))

#rarefaction curve
rarecurve(t(otu_table(physeqF.flt)), step=200, sample = min(colSums(otu_table(physeqF.flt))), label = FALSE, xlab = "Sample Size after filtering") 

#taxatables for reference
taxtableF.fltr <- data.frame(phyloseq::tax_table(physeqF.flt)@.Data)
taxtableF.fltr <- taxtableF.fltr %>% rownames_to_column(var = "Id")
# Make a data frame with a column for the read counts of each sample
sample_sum_df <- data.frame(sum = sample_sums(physeqF.flt))
summary(sample_sum_df$sum)

#histograms
# Histogram of sample read counts
ggplot(sample_sum_df, aes(x = sum)) + 
  geom_histogram(color = "black", fill = "indianred") +
  ggtitle("Distribution of sample sequencing depth (filtered)") + 
  xlab("Read counts") +
  theme(axis.title.y = element_blank())

# barplot with red line through median value
dat2 <- t(otu_table(physeqF.flt)) %>% melt(.) %>% arrange(desc(value))
ggbarplot(data = dat2, x = "Var2", y = "value",xlab = "Filtered", order = unique(dat2$Var2)) + geom_hline(yintercept=median(rowSums(otu_table(physeqF.flt))), color="red")

physeqF.flt

summary(taxa_sums(physeqF.flt))

print(paste("The minimum and maximum number of quality fungal sequences before filtering (per sample) in this data set is",min(colSums(otu_table(physeqF))),"and", max(colSums(otu_table(physeqF))),". After filering this changed to", min(colSums(otu_table(physeqF.flt))),"and",max(colSums(otu_table(physeqF.flt))) ))

print(paste("The number of reads and ASVs left after filtering is",round(sum(taxa_sums(physeqF.flt)) / sum(taxa_sums(physeqF))*100,2),"% and",round(ntaxa(physeqF.flt) / ntaxa(physeqF) *100,2),"%, a change from",round(sum(taxa_sums(physeqF))),"to",round(sum(taxa_sums(physeqF.flt))), "reads and", ntaxa(physeqF),"to",ntaxa(physeqF.flt),"ASVs. The median changed from", median(rowSums(otu_table(physeqF))),"to",median(rowSums(otu_table(physeqF.flt))),"reads per ASV."))


```
  
## Predicted enzyme metagenome
```{r physeqE object,include=TRUE, echo=FALSE, warning=FALSE,message=FALSE, cache=TRUE}
#Enzyme metagenome (picrust predictions)
#Run picrust2 on hpc or on home computer and import as phyloseq object
#Manually create a category file which can be used as 'taxonomy' to aid graphs and colours. 

#export qiime2 qza sequence and feature table into fasta (fna) and biome file to run with picrust2 on python environment
#in this case used the min10 frequency present in >2 samples filtered in qiime2

#qiime tools export --input-path rep_sequences_filteredtofeaturetable.qza  --output-path exports_for_picrust
#qiime tools export --input-path feature_table_insertfilt_min10readsmin2spls.qza  --output-path exports_for_picrust
 
#conda activate picrust2 or source activate on hpc environment
#picrust2_pipeline.py -s dna-sequences.fasta --max_nsti 0.65 --stratified -i feature-table.biom -o picrust2_out_pipeline -p 4

EC_metagenome <- read_tsv("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/Picrust/2020_0319_picrust10minfreq2minspls_newrun/picrust2_out_pipeline/EC_metagenome_out/pred_metagenome_unstrat.tsv") %>%  column_to_rownames("function")

EC_names <- read_tsv("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/Picrust/2020_0113_picrust_ASVminfreq10minspl2_2551ASV_0.65minNSTI/picrust2_out_pipeline/EC_metagenome_out/pred_metagenome_unstratEC_desc.tsv") %>% dplyr::select(matches("function|description|Class|Class2")) %>% column_to_rownames("function")
### create ps object ####
physeqE <-phyloseq(
        otu_table(EC_metagenome, taxa_are_rows = T), 
        tax_table(as.data.frame(EC_names) %>% as.matrix()),
        sample_data(metadata2 %>% as.data.frame() %>% column_to_rownames("#SampleID")))
physeqE <- prune_samples(samples = (sample_names(physeqE)!= c("C20")), physeqE)
physeqE <- prune_taxa(taxa_sums(physeqE) != 0, physeqE)

#adding diversity measures (with ps object) to metadata and re-create ps object 
rare_EC <- rarefy_even_depth(physeqE, sample.size = min(colSums(otu_table(physeqE))),  rngseed = TRUE, replace = TRUE, trimOTUs = TRUE)
ps.div <- estimate_richness(rare_EC)
ps.div$`#SampleID` <- sample_names(physeqE)
meta.df <- data.frame(sample_data(physeqE))
meta.df <- meta.df %>% rownames_to_column("#SampleID") %>% 
  left_join(ps.div, by = "#SampleID") %>% column_to_rownames("#SampleID")
meta.df$pielou_ev <- ps.div$Shannon/log(ps.div$Observed)      #Pielou eveness
#adding carbon ratios
meta.df <- meta.df %>% rownames_to_column("OTUID") %>% 
  mutate(observed_C = log1p(Observed / TC)) %>%
  mutate(shannon_C = log1p(Shannon / TC)) %>%
  mutate(simpson_C = log1p(InvSimpson / TC)) %>% 
  mutate(evenness_C = log1p(pielou_ev / TC)) %>% 
  mutate(bcop_C = log1p(b_copies_ngDNA / TC)) %>% 
  mutate(fcop_C  = log1p(f_copies_ngDNA / TC)) %>% 
  mutate(observed_D17 = log1p(Observed / D17)) %>%
  mutate(shannon_D17 = log1p(Shannon / D17)) %>%
  mutate(simpson_D17 = log1p(InvSimpson / D17)) %>% 
  mutate(evenness_D17 = log1p(pielou_ev / D17))  %>% column_to_rownames("OTUID")
physeqE@sam_data <- sample_data(meta.df)
physeqE
```
  
<br/>


```{r physeqpw object,include=TRUE, echo=FALSE, warning=FALSE,message=FALSE, cache=TRUE}
# now for the pathway file
pathway.pred <- read_tsv("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/Picrust/2020_0319_picrust10minfreq2minspls_newrun/picrust2_out_pipeline/pathways_out/path_abun_unstrat.tsv", col_names = TRUE)  %>% column_to_rownames("pathway")
pw.names <- read_tsv("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/Picrust/metacyc_pathway_info_full.tsv") %>% column_to_rownames("Id")  %>% dplyr::select(-ALTERNATIVE) %>% dplyr::select(-`SUPER-PATHWAYS`)%>% dplyr::select(-NAMES) %>% dplyr::select(-CLASS2)
physeq.pw <- phyloseq(otu_table(
             pathway.pred, taxa_are_rows = T), 
              tax_table(as.data.frame(pw.names) %>% as.matrix()),
             sample_data(metadata2 %>% as.data.frame() %>% column_to_rownames("#SampleID"))) 
```

 
```{r headmetadata, warning=FALSE,message=FALSE,echo=FALSE, include=FALSE}
# Metadata, otu and taxtables
sample_data(physeqB)[c(1:6,30),c("Soil","Paddock","D1517","TC","POC","ROC", "HUM","Shannon")]
summary(sample_data(physeqB)$Dloss_fct2)

#Bacteria
physeqB
summary(colSums(otu_table(physeqB)))
kable(otu_table(physeqB)[1:5,1:7], booktabs=TRUE) %>% 
  kable_styling(latex_options="scale_down")

kable(head(tax_table(physeqB)), booktabs=TRUE) %>% 
  kable_styling(latex_options="scale_down")

#Fungi
physeqF
summary(colSums(otu_table(physeqF)))
kable(otu_table(physeqF)[1:5,1:7], booktabs=TRUE) %>% 
  kable_styling(latex_options="scale_down")
kable(head(tax_table(physeqF)), booktabs=TRUE) %>% 
  kable_styling(latex_options="scale_down")

#Enzyme metagenome
physeqE
summary(colSums(otu_table(physeqE)))
kable(otu_table(physeqE)[1:5,1:7], booktabs=TRUE) %>% 
  kable_styling(latex_options="scale_down")
kable(head(tax_table(physeqE)), booktabs=TRUE) %>% 
  kable_styling(latex_options="scale_down")

kable(tax_table(physeqE)@.Data %>% data.frame %>%  dplyr::select(Class)  %>% unique)

#Pathway metagenome
physeq.pw
summary(colSums(otu_table(physeq.pw)))
kable(otu_table(physeq.pw)[1:5,1:7], booktabs=TRUE) %>% 
  kable_styling(latex_options="scale_down")
kable(head(tax_table(physeq.pw)), booktabs=TRUE) %>% 
  kable_styling(latex_options="scale_down")
```

  
# Results
## Carbon quality
```{r carbonquality, fig.cap = "Comparisons of carbon quality variables between samples of low and high dieldrin loss. Samples are grouped by long-term dielrin loss (%) where the loss is either below or above the median loss in each soil type. Significance of global Kruskal-Wallis tests and Wilcoxon tests for each soil type are shown.", message=FALSE, warning=FALSE,echo=FALSE, fig.width=8, fig.asp = 0.85}
my_comparisons <- list( c("<=43%", ">43%"), c("<72%", ">=72%") )

#data.frame(sample_data(physeqB)) %>% reshape2::melt(., measure.var = c("D1517", "TC","TC_D17","CN","HC", "ROC.pct", "HUM.pct", "POC.pct"))  %>%
#  ggbarplot(., x = "Dloss_fct2", y = "value", add = c("mean_se"), facet.by = c("variable"), scales = "free",fill = "Soil", ylab = "", xlab = "Dieldrin loss",position = position_dodge(0.9), width = 0.6, panel.labs = list(variable = c("Dieldrin (µg/g)", "Total Carbon (TC)", "TC:Dieldrin ratio", "C:N ratio", "H:C ratio", "ROC (%)", "HUM (%)", "POC (%)"))) + stat_compare_means(comparisons = my_comparisons,label = "p.signif") +
#  stat_compare_means( method = "kruskal",label = "p.signif")
test <- data.frame(sample_data(physeqB))
p1 <- sample_data(physeqB) %>% ggbarplot(., x = "Dloss_fct2", y = "D1517", add = c("mean_se"), scales = "free",fill = "Soil", ylab = "Dieldrin (µg/g)", xlab = "Dieldrin loss",position = position_dodge(0.9), width = 0.6 ) + stat_compare_means(comparisons = my_comparisons,label = "p.signif", label.y = c(1.5)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(1.7)) + theme_bw() 

p2 <- sample_data(physeqB) %>% ggbarplot(., x = "Dloss_fct2", y = "TC", add = c("mean_se"), scales = "free",fill = "Soil", ylab = "Total Carbon (g/kg)", xlab = "Dieldrin loss",position = position_dodge(0.9), width = 0.6 ) + stat_compare_means(comparisons = my_comparisons,label = "p.signif",label.y = c(75)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(80)) + theme_bw()

p3 <- sample_data(physeqB) %>% ggbarplot(., x = "Dloss_fct2", y = "TC_D17", add = c("mean_se"), scales = "free",fill = "Soil", ylab = "TC:Dieldrin ratio", xlab = "Dieldrin loss", position = position_dodge(0.9), width = 0.6 ) + stat_compare_means(comparisons = my_comparisons, label = "p.signif", label.y = c(490)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(525)) + theme_bw()

p4 <- sample_data(physeqB) %>% ggbarplot(., x = "Dloss_fct2", y = "CN", add = c("mean_se"), scales = "free",fill = "Soil", ylab =  "C:N ratio", xlab = "Dieldrin loss", position = position_dodge(0.9), width = 0.6 ) + stat_compare_means(comparisons = my_comparisons, label = "p.signif", label.y = c(15.6)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(17)) + theme_bw()

p5 <- sample_data(physeqB) %>% ggbarplot(., x = "Dloss_fct2", y = "HC", add = c("mean_se"), scales = "free",fill = "Soil", ylab =  "H:C ratio", xlab = "Dieldrin loss", position = position_dodge(0.9), width = 0.6 ) + stat_compare_means(comparisons = my_comparisons, label = "p.signif", label.y = c(0.4)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(0.45)) + theme_bw()

p6 <- sample_data(physeqB) %>% ggbarplot(., x = "Dloss_fct2", y = "ROC.pct", add = c("mean_se"), scales = "free",fill = "Soil", ylab =  "ROC (%)", xlab = "Dieldrin loss", position = position_dodge(0.9), width = 0.6 ) + stat_compare_means(comparisons = my_comparisons, label = "p.signif", label.y = c(35)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(40)) + theme_bw()+ ylim(0,60)

p7 <- sample_data(physeqB) %>% ggbarplot(., x = "Dloss_fct2", y =  "HUM.pct", add = c("mean_se"), scales = "free",fill = "Soil", ylab =  "HUM (%)", xlab = "Dieldrin loss", position = position_dodge(0.9), width = 0.6 ) + stat_compare_means(comparisons = my_comparisons, label = "p.signif", label.y = c(56)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(60)) + theme_bw() + ylim(0,60)

p8 <- sample_data(physeqB) %>% ggbarplot(., x = "Dloss_fct2", y = "POC.pct", add = c("mean_se"), scales = "free",fill = "Soil", ylab =  "POC (%)", xlab = "Dieldrin loss", position = position_dodge(0.9), width = 0.6 ) + stat_compare_means(comparisons = my_comparisons, label = "p.signif", label.y = c(18)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(27)) + theme_bw()+ ylim(0,60)

p9 <- sample_data(physeqB) %>% ggbarplot(., x = "Dloss_fct2", y = "TC_P", add = c("mean_se"), scales = "free",fill = "Soil", ylab =  "C:P ratio", xlab = "Dieldrin loss", position = position_dodge(0.9), width = 0.6 ) + stat_compare_means(comparisons = my_comparisons, label = "p.signif", label.y = c(7)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(10)) + theme_bw()

pdf(NULL)
p <- ggarrange(p1, p2, p3,  p6, p7, p8, p4, p5, p9, nrow = 3, ncol = 3, common.legend = TRUE)
x = dev.off()
p 
```

Overall the two soils contained a different carbon quantity and quality. Figure \@ref(fig:carbonquality) shows that the Kursol, the soil with greater long-term dieldrin losses, contained significantly less total carbon (TC). Although it was less rich in organic matter, it was composed of more humus (HUM) and particulate organic carbon (POC) relative to the resistant organic carbon (ROC). Furthermore, a high-loss soil environments coincided with a low carbon-to-nitrogen ration (C:N), and higher hydrogen-to-carbon ration (H:C) and a higher proportion of humus in the Kurosol. 
There was also a trend that indicated that a higher proportion of POC was associated with more dieldrin loss. 

A separate correlation analysis showed:
 
- CN, POC proportions and total ROC were correlated to dieldrin loss. 
  - low C:N = high dieldrin losses
  - more POC in organic matter = more dieldrin loss
  - more ROC = less dieldrin loss.
- The soils with the highest aromatic carbon fraction (H:C) also had highest dieldrin losses


## Alpha diversity
```{r alphadloss, fig.cap = "Alpha diversity of bacteria and fungi. Samples are grouped by long-term dielrin loss (%) where the loss is either below or above the median loss in each soil type. Significance of global Kruskal-Wallis tests and Wilcoxon tests for each soil type are shown.", message=FALSE, warning=FALSE,echo=FALSE, fig.width=10, fig.asp = 0.75}
my_comparisons <- list( c("<=43%", ">43%"), c("<72%", ">=72%") )

#p1 <- data.frame(sample_data(physeqB)) %>% melt(., measure.var =c("Observed", "Shannon", "pielou_ev"))  %>%
# ggbarplot(., x = "Dloss_fct2", y = "value", add = c("mean_se"), facet.by = c("variable"), scale = "free",fill = "Soil", ylab = "", xlab = "Dieldrin loss",position = position_dodge(0.9), width = 0.6, panel.labs = list(variable = c("ASV number", "Shannon index", "Pielou Evenness"))) + ggtitle("Bacteria") + stat_compare_means(comparisons = my_comparisons,label = "p.signif") +
#  stat_compare_means( method = "kruskal",label = "p.signif")

#my_comparisons <- list( c("<=43%", ">43%"), c("<72%", ">=72%") )
#p2 <- data.frame(sample_data(physeqF)) %>% melt(., measure.var =c("Observed", "Shannon", "pielou_ev"))  %>%
#  ggbarplot(., x = "Dloss_fct2", y = "value", add = c("mean_se"), facet.by = c("variable"), scale = "free",fill = "Soil", ylab = "", xlab = "Dieldrin loss",position = position_dodge(0.9), width = 0.6, panel.labs = list(variable = c("ASV number", "Shannon index", "Pielou Evenness"))) +   ggtitle("Fungi") + stat_compare_means(comparisons = my_comparisons,label = "p.format") +
#  stat_compare_means( method = "kruskal",label = "p.signif")


p1 <- data.frame(sample_data(physeqB)) %>% ggboxplot(., x = "Dloss_fct2", y = "Observed", add = c("jitter"), scales = "free",fill = "Soil", ylab = "ASV number", xlab = "Dieldrin loss") + stat_compare_means(comparisons = my_comparisons,label = "p.signif", label.y = c(2300)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(2500)) + theme_bw() 

p2 <- data.frame(sample_data(physeqB)) %>% ggboxplot(., x = "Dloss_fct2", y = "Shannon", add = c("jitter"), scales = "free",fill = "Soil", ylab = "Shannon index", xlab = "Dieldrin loss" ) + stat_compare_means(comparisons = my_comparisons,label = "p.signif", label.y = c(7)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(7.25)) + theme_bw() 

p3 <- data.frame(sample_data(physeqB)) %>% ggboxplot(., x = "Dloss_fct2", y = "InvSimpson", add = c("jitter"), scales = "free",fill = "Soil", ylab = "Simpson index", xlab = "Dieldrin loss") + stat_compare_means(comparisons = my_comparisons,label = "p.signif", label.y = c(525)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(550)) + theme_bw() 

p4 <- data.frame(sample_data(physeqB)) %>% ggboxplot(., x = "Dloss_fct2", y = "pielou_ev", add = c("jitter"), scales = "free",fill = "Soil", ylab ="Pielou evenness", xlab = "Dieldrin loss" ) + stat_compare_means(comparisons = my_comparisons,label = "p.signif", label.y = c(0.94)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(0.95)) + theme_bw() 

p5 <- data.frame(sample_data(physeqF)) %>% ggboxplot(., x = "Dloss_fct2", y = "Observed", add = c("jitter"), scales = "free",fill = "Soil", ylab = "ASV number", xlab = "Dieldrin loss") + stat_compare_means(comparisons = my_comparisons,label = "p.signif", label.y = c(520)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(560)) + theme_bw()

p6 <- data.frame(sample_data(physeqF)) %>% ggboxplot(., x = "Dloss_fct2", y = "Shannon", add = c("jitter"), scales = "free", fill = "Soil", ylab = "Shannon index", xlab = "Dieldrin loss") + stat_compare_means(comparisons = my_comparisons,label = "p.signif", label.y = c(5.5)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(6)) + theme_bw() 

p7 <- data.frame(sample_data(physeqF)) %>% ggboxplot(., x = "Dloss_fct2", y = "InvSimpson", add = c("jitter"), scales = "free",fill = "Soil", ylab = "Simpson index", xlab = "Dieldrin loss" ) + stat_compare_means(comparisons = my_comparisons,label = "p.signif", label.y = c(89)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(100)) + theme_bw() 

p8 <- data.frame(sample_data(physeqF)) %>% ggboxplot(., x = "Dloss_fct2", y = "pielou_ev", add = c("jitter"), scales = "free",fill = "Soil", ylab ="Pielou evenness", xlab = "Dieldrin loss" ) + stat_compare_means(comparisons = my_comparisons,label = "p.signif", label.y = c(0.85)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(0.9)) + theme_bw() 

p9 <- data.frame(sample_data(physeqE)) %>% ggboxplot(., x = "Dloss_fct2", y = "Observed", fill = "Soil", add = "jitter", ylab = "ASV number", xlab = "Dieldrin loss") + stat_compare_means(comparisons = my_comparisons,label = "p.signif", label.y = c(2120)) + stat_compare_means(method = "kruskal",label = "p.signif", label.y = c(2150)) + theme_bw()
p10 <- data.frame(sample_data(physeqE)) %>% ggboxplot(., x = "Dloss_fct2", y = "Shannon", add = c("jitter"), scales = "free",fill = "Soil", ylab = "Shannon index", xlab = "Dieldrin loss" ) + stat_compare_means(comparisons = my_comparisons,label = "p.signif", label.y = c(6.76)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(6.77)) + theme_bw() 

p11 <-  data.frame(sample_data(physeqE)) %>% ggboxplot(., x = "Dloss_fct2", y = "InvSimpson", add = c("jitter"), scales = "free",fill = "Soil", ylab = "Simpson index", xlab = "Dieldrin loss") + stat_compare_means(comparisons = my_comparisons,label = "p.signif", label.y = c(558)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(570)) + theme_bw() 

p12 <-  data.frame(sample_data(physeqE)) %>% ggboxplot(., x = "Dloss_fct2", y = "pielou_ev", add = c("jitter"), scales = "free",fill = "Soil", ylab ="Pielou evenness", xlab = "Dieldrin loss" ) + stat_compare_means(comparisons = my_comparisons,label = "p.signif", label.y = c(0.890)) + stat_compare_means( method = "kruskal",label = "p.signif", label.y = c(0.8925)) + theme_bw() 


pdf(NULL)
p <- ggarrange(p1, p2, p3,p4, nrow = 1, common.legend = TRUE) 
p <- annotate_figure(p, fig.lab  = "    Bacteria",fig.lab.pos	= "top.left",fig.lab.size = 14)

pp <- ggarrange(p5, p6, p7,p8, nrow = 1, common.legend = TRUE) 
pp <- annotate_figure(pp, fig.lab  = "    Fungi",fig.lab.pos	= "top.left",fig.lab.size = 14)

ppp <- ggarrange(p9, p10, p11,p12, nrow = 1, common.legend = TRUE) 
ppp <- annotate_figure(ppp, fig.lab  = "    Enzyme potential",fig.lab.pos	= "top.left",fig.lab.size = 14)

pppp <- ggarrange(p,pp,ppp, nrow = 3, common.legend = TRUE, labels = "auto")
x = dev.off()
pppp


```


  
```{r alphadlossenzymes, message=FALSE, warning=FALSE, echo=FALSE, include=FALSE, eval=FALSE}

my_comparisons <- list( c("<=43%", ">43%"), c("<72%", ">=72%") )
data.frame(sample_data(physeqE)) %>% melt(., measure.var =c("Observed", "Shannon", "pielou_ev"))  %>%
  ggboxplot(., x = "Dloss_fct2", y = "value", add = "jitter", facet.by = c("variable"), scale = "free",fill = "Soil", ylab = "", xlab = "Dieldrin loss", panel.labs = list(variable = c("Number of enzymes", "Shannon index", "Pielou Evenness"))) + stat_compare_means(comparisons = my_comparisons,label = "p.format") +
  stat_compare_means( method = "kruskal",label = "p.signif")


```


### Diversity per unit dieldrin
```{r alphaperD17, fig.cap = "Shannon:dieldrin ratio to compare diversity of bacteria (a), fungi (b) and the predicted enzyme abundances (c) per unit dieldrin (µg/g). This is to demonstrate the effect of normalisting alpha diversity by the total carbon content or dieldrin concentration of a soil. Samples are grouped by long-term dielrin loss (%) where the loss is either below or above the median loss in each soil type. Significance of global Kruskal-Wallis tests and Wilcoxon tests for each soil type are shown.", message=FALSE, warning=FALSE,echo=FALSE, fig.width=8, fig.asp = 0.45}
my_comparisons <- list( c("<=43%", ">43%"), c("<72%", ">=72%") )

p1 <- as.data.frame(sample_data(physeqB)) %>% melt(., measure.var = c("shannon_D17"))  %>%
ggboxplot(., x = "Dloss_fct2", y = "value", add = c("jitter"), facet.by = "variable", scales = "free", fill = "Soil", ylab = "Shannon:dieldrin ratio", xlab = "Dieldrin loss", panel.labs= list(variable = c("shannon:dieldrin (bacteria)" ))) + stat_compare_means( method = "kruskal",label = "p.signif") + stat_compare_means(comparisons = my_comparisons)

p2 <- as.data.frame(sample_data(physeqF)) %>% melt(., measure.var = c("shannon_D17"))  %>%
ggboxplot(., x = "Dloss_fct2", y = "value", add = c("jitter"), facet.by = "variable", scales = "free", xlab = "Dieldrin loss", ylab = "", fill= "Soil",panel.labs= list(variable = c("shannon:dieldrin (fungi)" ))) + stat_compare_means( method = "kruskal",label = "p.signif") + stat_compare_means(comparisons = my_comparisons)

p3 <- as.data.frame(sample_data(physeqE)) %>% melt(., measure.var = c("shannon_D17"))  %>%
ggboxplot(., x = "Dloss_fct2", y = "value", add = c("jitter"), facet.by = "variable", scales = "free", xlab = "Dieldrin loss", ylab = "", fill = "Soil",panel.labs= list(variable = c("shannon:dieldrin (enzymes)" ))) + stat_compare_means( method = "kruskal",label = "p.signif") + stat_compare_means(comparisons = my_comparisons)
pdf(NULL)
p <- ggarrange(p1,p2,p3, nrow = 1, labels = "auto", common.legend = TRUE)
#p <-  annotate_figure(p, fig.lab  = "Shannon:dieldrin ratio",fig.lab.pos	= "top.left",fig.lab.size = 14)
x = dev.off()
p

```

<br/>

ASV richness of bacteria and fungi were greater in samples with high long-term dieldrin losses (Fig. \@ref(fig:alphadloss) a and b). Bacterial richness was highest in the samples with highest dieldrin loss (>=72% dieldrin loss in the Kurosol). A higher ASV richness coincided with increases in other diversity indices, especially an increased bacterial Simpson index which was 1.27 times greater in the Kurosol. Consequently, in a high-loss environment there were more ASVs that were differently abundant, particularly the more dominant bacterial ASVs.  
  
    
Samples with greatest long-term loss of dieldrin contained the greatest potential of different enzymes (Fig. \@ref(fig:alphadloss)c). Moreover in the Kurosol, Shannon's index  was greater in the high-loss samples while Pilou's evenness remained the same. Shannon's index accounts for both, abundance and evenness, so an increase of this index without an increase in evenness, indicated that more enzymes with differential potentials (abundances) were present in the high-loss environment of this soil, while maintaining the spread of different types of enzymes.  
  
The diversity of enzyme potentials in the Chromosol was more similar between samples of low and high dieldrin loss compared to the Kurosol. Only Pilou's evenness was different. This soil was thus composed of the same metabolic richness but the potentials (abundances) of enzymes in high-loss samples of this soil were unevenly distributed or were more concentrated in fewer enzymes.  
  
Soil diversity was further compared on a per-unit-dieldrin (µg/g) basis (Fig \@ref(fig:alphaperD17)). It showed that the Kurosol, which contained less organic matter and dieldrin, had significantly higher diversity for each µg/g of dieldrin compared to the Chromosol. Hence, there was greater diversity for each molecule of dieldrin in the high-loss environment. 
  
<br/>


## Betadiversity

### pcoa and nmds
```{r pcoa, echo= FALSE,  fig.cap="Ordinations of two different dissimilarity indices are compared for each composition of bacteria, their enzyme predictions and fungi (n = 36). Symbols represent samples and their proximity to each other indicates compositional similarity. The colour of symbols indicate the long-term dieldrin loss (%) of samples. The shape of symbols indicate soil type.", fig.width=10, fig.asp= 0.7,message=FALSE, warning=FALSE, results=FALSE}

ord_pcoa <- phyloseq::ordinate(rare_Bac, "PCoA",  "unifrac",weighted=TRUE)
p.pcoa1 <- phyloseq::plot_ordination(rare_Bac, ord_pcoa , color = "Dloss", shape = "Soil") + geom_point(aes(size = log(D1517))) +
  ggtitle("Bacteria, PCoA")+  scale_colour_gradient(low = "cadetblue1", high = "navy")+ guides(alpha = F)  + annotate(geom = 'text', label = "weighted unifrac", x = -Inf, y = -Inf, hjust = -0.05, vjust = -1)


ord_pcoa <- phyloseq::ordinate(rare_Bac, "PCoA", "unifrac",weighted=FALSE)
p.pcoa2 <- phyloseq::plot_ordination(rare_Bac, ord_pcoa , color = "Dloss", shape = "Soil") + geom_point(aes(size =  POC.pct)) +
  ggtitle("Bacteria, PCoA")+  scale_colour_gradient(low = "cadetblue1", high = "navy")+ guides(alpha = F) + annotate(geom = 'text', label = "unweighted unifrac", x = -Inf, y = -Inf, hjust = -0.05, vjust = -1)


ord_nmdsF <- phyloseq::ordinate(rare_Fun, "PCoA", "bray")
#label <- round(ord_nmdsF$stress,3)
p.nmdsF1 <- phyloseq::plot_ordination(rare_Fun, ord_nmdsF , color = "Dloss", shape = "Soil") +
    geom_point(aes(size =  POC.pct)) +
    scale_colour_gradient(low = "cadetblue1", high = "navy")+
  ggtitle("Fungi PCoA") + annotate(geom = 'text', label = "Bray-Curtis", x = -Inf, y = -Inf, hjust = -0.05, vjust = -1)

ord_nmdsF <- phyloseq::ordinate(rare_Fun, "PCoA", "jaccard", binary=TRUE)
#label <- round(ord_nmdsF$stress,3)
p.nmdsF2 <- phyloseq::plot_ordination(rare_Fun, ord_nmdsF , color = "Dloss", shape = "Soil") +
    geom_point(aes(size =  POC.pct)) +
    scale_colour_gradient(low = "cadetblue1", high = "navy")+
  ggtitle("Fungi PCoA") + annotate(geom = 'text', label = "Jaccard", x = -Inf, y = -Inf, hjust = -0.05, vjust = -1)


ord_pcoabrayE <- phyloseq::ordinate(rare_EC, "NMDS", "bray")
label <- round(ord_pcoabrayE$stress,3)
p.pcoa3 <- phyloseq::plot_ordination(rare_EC, ord_pcoabrayE , color = "Dloss", shape = "Soil") +
    geom_point(aes(size =  POC.pct)) +
    scale_colour_gradient(low = "cadetblue1", high = "navy")+
  ggtitle("Enzyme predictions, nMDS") + annotate(geom = 'text', label = paste("Bray-Curtis, Stress = ", label), x = -Inf, y = -Inf, hjust = -0.05, vjust = -1)


ord_pcoaJE <- phyloseq::ordinate(rare_EC, "NMDS", "jaccard",binary=TRUE)
label <- round(ord_pcoaJE$stress,3)
p.pcoa4 <- phyloseq::plot_ordination(physeqE, ord_pcoaJE , color = "Dloss", shape = "Soil") +
    geom_point(aes(size =  POC.pct)) +
    scale_colour_gradient(low = "cadetblue1", high = "navy")+
  ggtitle("Enzyme predictions, nMDS") + annotate(geom = 'text', label = paste("Jaccard, Stress = ", label), x = -Inf, y = -Inf, hjust = -0.05, vjust = -1)

pdf(NULL)
p <- ggarrange(p.pcoa1,  p.pcoa3, p.nmdsF1, p.pcoa2,p.pcoa4,p.nmdsF2, common.legend = TRUE, nrow = 2, ncol = 3, labels = "auto")
x = dev.off()
p

```


(Fig. \@ref(fig:pcoa))  

- Compositional comparisons were made between phylogenetic abundance and presence:absence distance metrics (weighted and unweighted unifrac) and non-phylogenetic abundance and presence:absence distance metrics (Bray Curtis and Jaccard).  
  
- Bacteria (a & d)
  - Overall, a greater community dispersion was seen in the Kurosol. 
  - This is in contrast to the Chromosol, which contained a more homogenous pool of ASVs. 
  - As unifrac included phylogenetic information this implied that the Kurosol was phylogenetically more dispersed and contained a more broad gene pool.
- Enzyme metagenome (functional potential of bacteria) (b & e)
  - Bray-Curtis (abundance) was compared to Jaccard distance (presence absence)
  - There were similar genes present in each soil but their estimated abundances differed.
  - While a higher dispersion of gene abundances was observed in the Kurosol, the gene abundances in the Chromosol were homogenous. This meant that the metabolic potentials were more differentially abundant in the soil with high dieldrin loss.  
- Fungi (c & f)
  - Fungal ASVs cluster into three destinct groups, wherby the Kurosol splits into two groups and the Chromosol into one. Hence, the Chromsol contained one homogenous pool of similar ASVs.  

<br/>

```{r cca, echo=FALSE, include=FALSE, fig.cap="Ordinations of two different dissimilarity indices are compared for each composition of bacteria, their enzyme predictions and fungi.", fig.width=10, fig.asp= 0.9,message=FALSE, warning=FALSE, results=FALSE}

#Bacteria
physeq.pw.flt <- prune_samples(sample_data(rare_Bac)$Soil == "Kurosol", rare_Bac)
physeq.pw.flt = filter_taxa(physeq.pw.flt, function(x) sum(x > 0) > (0.10*length(x)), TRUE) #must be present in x percent of samples
physeq.pw.flt  <-   prune_samples(sample_data(physeq.pw.flt)$Farm != "C", physeq.pw.flt)
ord_ccaB <- phyloseq::ordinate(physeq.pw.flt, "CCA", "bray",formula = ~ HUM.clr + POC.clr + ROC.clr)
p.ccaB  <- phyloseq::plot_ordination(rare_Bac, ord_ccaB , color = "Dloss", shape = "Dloss_fct2") +
    geom_point(aes(size =  Dloss)) +
   scale_colour_gradient(low = "cadetblue1", high = "navy")+
  ggtitle("Bacteria, Kurosol") 

# Now add the environmental variables as arrows to either of these p1 or p2
arrowmat <- vegan::scores(ord_ccaB, display = "bp")
arrowmat <- data.frame(arrowmat)
rownames(arrowmat) <- c("HUM (%)", "POC (%)", "ROC (%)")
# Add labels, make a data.frame
arrowdf <- data.frame(labels = rownames(arrowmat), arrowmat)
# Define the arrow aesthetic mapping
arrow_map <- aes(xend = CCA1, 
                 yend = CCA2, 
                 x = 0, 
                 y = 0, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

label_map <- aes(x = 1.2 * CCA1, 
                 y = 1.2 * CCA2, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

arrowhead = arrow(length = unit(0.02, "npc"))
# Make a new graphic
p1 <- p.ccaB + 
  geom_segment(
    mapping = arrow_map, 
    size = .5, 
    data = arrowdf, 
    color = "gray", 
    arrow = arrowhead)  +
  geom_text(
   mapping = label_map, 
  size = 4,  
  data = arrowdf, 
  show.legend = FALSE)

#Fungi
physeq.pw.flt <- prune_samples(sample_data(rare_Fun)$Soil == "Kurosol", rare_Fun)
physeq.pw.flt = filter_taxa(physeq.pw.flt, function(x) sum(x > 0) > (0.20*length(x)), TRUE) #must be present in x percent of samples
physeq.pw.flt  <-   prune_samples(sample_data(physeq.pw.flt)$Farm != "C", physeq.pw.flt)
ord_ccaB <- phyloseq::ordinate(physeq.pw.flt, "CCA", "bray",formula = ~ HUM.clr + POC.clr + ROC.clr)
p.ccaB  <- phyloseq::plot_ordination(rare_Fun, ord_ccaB , color = "Dloss", shape = "Dloss_fct2") +
    geom_point(aes(size =  Dloss)) +
    scale_colour_gradient(low = "cadetblue1", high = "navy")+
  ggtitle("Fungi, Kurosol") 

# Now add the environmental variables as arrows to either of these p1 or p2
arrowmat <- vegan::scores(ord_ccaB, display = "bp")
arrowmat <- data.frame(arrowmat)
rownames(arrowmat) <- c("HUM (%)", "POC (%)", "ROC (%)")
# Add labels, make a data.frame
arrowdf <- data.frame(labels = rownames(arrowmat), arrowmat)
# Define the arrow aesthetic mapping
arrow_map <- aes(xend = CCA1, 
                 yend = CCA2, 
                 x = 0, 
                 y = 0, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

label_map <- aes(x = 1.2 * CCA1, 
                 y = 1.2 * CCA2, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)
arrowhead = arrow(length = unit(0.02, "npc"))
# Make a new graphic
p2 <- p.ccaB + 
  geom_segment(
    mapping = arrow_map, 
    size = .5, 
    data = arrowdf, 
    color = "gray", 
    arrow = arrowhead)  +
  geom_text(
   mapping = label_map, 
  size = 4,  
  data = arrowdf, 
  show.legend = FALSE)

#Chromosol
#Bacteria
physeq.pw.flt <- prune_samples(sample_data(rare_Bac)$Soil == "Chromosol", rare_Bac)
physeq.pw.flt = filter_taxa(physeq.pw.flt, function(x) sum(x > 0) > (0.10*length(x)), TRUE) #must be present in x percent of samples
ord_ccaB <- phyloseq::ordinate(physeq.pw.flt, "CCA", "bray",formula = ~ HUM.clr + POC.clr + ROC.clr)
p.ccaB  <- phyloseq::plot_ordination(rare_Bac, ord_ccaB , color = "Dloss", shape = "Dloss_fct2") +
    geom_point(aes(size = Dloss)) +
    scale_colour_gradient(low = "cadetblue1", high = "navy")+
  ggtitle("Bacteria, Chromosol") 

# Now add the environmental variables as arrows to either of these p1 or p2
arrowmat <- vegan::scores(ord_ccaB, display = "bp")
arrowmat <- data.frame(arrowmat)
rownames(arrowmat) <- c("HUM (%)", "POC (%)", "ROC (%)")
# Add labels, make a data.frame
arrowdf <- data.frame(labels = rownames(arrowmat), arrowmat)
# Define the arrow aesthetic mapping
arrow_map <- aes(xend = CCA1, 
                 yend = CCA2, 
                 x = 0, 
                 y = 0, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

label_map <- aes(x = 1.2 * CCA1, 
                 y = 1.2 * CCA2, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

arrowhead = arrow(length = unit(0.02, "npc"))
# Make a new graphic
p3 <- p.ccaB + 
  geom_segment(
    mapping = arrow_map, 
    size = .5, 
    data = arrowdf, 
    color = "gray", 
    arrow = arrowhead)  +
  geom_text(
   mapping = label_map, 
  size = 4,  
  data = arrowdf, 
  show.legend = FALSE)

#Fungi
physeq.pw.flt <- prune_samples(sample_data(rare_Fun)$Soil == "Chromosol", rare_Fun)
physeq.pw.flt = filter_taxa(physeq.pw.flt, function(x) sum(x > 0) > (0.20*length(x)), TRUE) #must be present in x percent of samples
ord_ccaB <- phyloseq::ordinate(physeq.pw.flt, "CCA", "bray",formula = ~ HUM.clr + POC.clr + ROC.clr)
p.ccaB  <- phyloseq::plot_ordination(rare_Fun, ord_ccaB , color = "Dloss", shape = "Dloss_fct2") +
    geom_point(aes(size =  Dloss)) +
    scale_colour_gradient(low = "cadetblue1", high = "navy")+
  ggtitle("Fungi, Chromosol") 

# Now add the environmental variables as arrows to either of these p1 or p2
arrowmat <- vegan::scores(ord_ccaB, display = "bp")
arrowmat <- data.frame(arrowmat)
rownames(arrowmat) <- c("HUM (%)", "POC (%)", "ROC (%)")
# Add labels, make a data.frame
arrowdf <- data.frame(labels = rownames(arrowmat), arrowmat)
# Define the arrow aesthetic mapping
arrow_map <- aes(xend = CCA1, 
                 yend = CCA2, 
                 x = 0, 
                 y = 0, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

label_map <- aes(x = 1.2 * CCA1, 
                 y = 1.2 * CCA2, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)
arrowhead = arrow(length = unit(0.02, "npc"))
# Make a new graphic
p4 <- p.ccaB + 
  geom_segment(
    mapping = arrow_map, 
    size = .5, 
    data = arrowdf, 
    color = "gray", 
    arrow = arrowhead)  +
  geom_text(
   mapping = label_map, 
  size = 4,  
  data = arrowdf, 
  show.legend = FALSE)
```
  
<br/>

### Redundancy analysis on Aitchison distances
```{r rda, echo=FALSE,  fig.cap="Redundancy analysis of bacterial and fungal abundances using the proportions of resistant organic carbon (ROC), humus (HUM) and particulate organic carbon (POC) as constraining variables. ASVs were filtered and the abundances were transformed to Aitchison distances prior to analysis. Symbols represent samples and their proximity to each other indicates compositional similarity. The size and shape of symbols indicate the long-term dieldrin loss (%) of samples. Three samples from the Kurosol were removed as outliers (Kurosol n = 18, Chromosol n = 15)", fig.width=10, fig.asp= 0.9,message=FALSE, warning=FALSE}


#Bacteria
physeq.pw.flt <- prune_samples(sample_data(physeqB)$Soil == "Kurosol", physeqB)
physeq.pw.flt  <-   prune_samples(sample_data(physeq.pw.flt)$Farm != "C", physeq.pw.flt)
physeq.pw.flt = filter_taxa(physeq.pw.flt, function(x) sum(x > 0) > (0.15*length(x)), TRUE) #must be present in x percent of samples
physeq.pw.flt <-  microbiome::transform(physeq.pw.flt, "clr") #clr transform

ord_ccaB <- phyloseq::ordinate(physeq.pw.flt, "RDA", "bray",formula = ~ HUM.clr + POC.clr + ROC.clr)
p.ccaB  <- phyloseq::plot_ordination(rare_Bac, ord_ccaB , color = "Dloss", shape = "Dloss_fct2") +
    geom_point(aes(size =  Dloss)) +
   scale_colour_gradient(low = "cadetblue1", high = "navy")+
  ggtitle("Bacteria, Kurosol") 

# Now add the environmental variables as arrows to either of these p1 or p2
arrowmat <- vegan::scores(ord_ccaB, display = "bp")
arrowmat <- data.frame(arrowmat)
rownames(arrowmat) <- c("HUM (%)", "POC (%)", "ROC (%)")
# Add labels, make a data.frame
arrowdf <- data.frame(labels = rownames(arrowmat), arrowmat)
# Define the arrow aesthetic mapping
arrow_map <- aes(xend = 1 * RDA1, 
                 yend = 1 * RDA2, 
                 x = 0, 
                 y = 0, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

label_map <- aes(x = 2.5 * RDA1, 
                 y = 2.5 * RDA2, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

arrowhead = arrow(length = unit(0.02, "npc"))
# Make a new graphic
p1 <- p.ccaB + 
  geom_segment(
    mapping = arrow_map, 
    size = .5, 
    data = arrowdf, 
    color = "gray", 
    arrow = arrowhead)  +
  geom_text(
   mapping = label_map, 
  size = 4,  
  data = arrowdf, 
  show.legend = FALSE)

psKbac <- physeq.pw.flt


#Fungi
physeq.pw.flt <- prune_samples(sample_data(physeqF)$Soil == "Kurosol", physeqF)
physeq.pw.flt  <-   prune_samples(sample_data(physeq.pw.flt)$Farm != "C", physeq.pw.flt)
physeq.pw.flt = filter_taxa(physeq.pw.flt, function(x) sum(x > 0) > (0.2*length(x)), TRUE) #must be present in x percent of samples
physeq.pw.flt <-  microbiome::transform(physeq.pw.flt, "clr") #clr transform

ord_ccaB <- phyloseq::ordinate(physeq.pw.flt, "RDA", "bray",formula = ~ HUM.clr + POC.clr + ROC.clr)
p.ccaB  <- phyloseq::plot_ordination(rare_Fun, ord_ccaB , color = "Dloss", shape = "Dloss_fct2") +
    geom_point(aes(size =  Dloss)) +
    scale_colour_gradient(low = "cadetblue1", high = "navy")+
  ggtitle("Fungi, Kurosol") 

# Now add the environmental variables as arrows to either of these p1 or p2
arrowmat <- vegan::scores(ord_ccaB, display = "bp")
arrowmat <- data.frame(arrowmat)
rownames(arrowmat) <- c("HUM (%)", "POC (%)", "ROC (%)")
# Add labels, make a data.frame
arrowdf <- data.frame(labels = rownames(arrowmat), arrowmat)
# Define the arrow aesthetic mapping
arrow_map <- aes(xend = 1 * RDA1, 
                 yend = 1 * RDA2, 
                 x = 0, 
                 y = 0, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

label_map <- aes(x = 1.8 * RDA1, 
                 y = 1.8 * RDA2, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

arrowhead = arrow(length = unit(0.02, "npc"))
# Make a new graphic
p2 <- p.ccaB + 
  geom_segment(
    mapping = arrow_map, 
    size = .5, 
    data = arrowdf, 
    color = "gray", 
    arrow = arrowhead)  +
  geom_text(
   mapping = label_map, 
  size = 4,  
  data = arrowdf, 
  show.legend = FALSE)

psKfun <- physeq.pw.flt


#Chromosol
#Bacteria
physeq.pw.flt <- prune_samples(sample_data(physeqB)$Soil == "Chromosol", physeqB)
physeq.pw.flt = filter_taxa(physeq.pw.flt, function(x) sum(x > 0) > (0.15*length(x)), TRUE) #must be present in x percent of samples
physeq.pw.flt <-  microbiome::transform(physeq.pw.flt, "clr") #clr transform

ord_ccaB <- phyloseq::ordinate(physeq.pw.flt, "RDA", "bray",formula = ~ HUM.clr + POC.clr + ROC.clr)
p.ccaB  <- phyloseq::plot_ordination(rare_Bac, ord_ccaB , color = "Dloss", shape = "Dloss_fct2") +
    geom_point(aes(size = Dloss)) +
    scale_colour_gradient(low = "cadetblue1", high = "navy")+
  ggtitle("Bacteria, Chromosol") 

# Now add the environmental variables as arrows to either of these p1 or p2
arrowmat <- vegan::scores(ord_ccaB, display = "bp")
arrowmat <- data.frame(arrowmat)
rownames(arrowmat) <- c("HUM (%)", "POC (%)", "ROC (%)")
# Add labels, make a data.frame
arrowdf <- data.frame(labels = rownames(arrowmat), arrowmat)
# Define the arrow aesthetic mapping
arrow_map <- aes(xend = 1 * RDA1, 
                 yend = 1 * RDA2, 
                 x = 0, 
                 y = 0, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

label_map <- aes(x = 1.8 * RDA1, 
                 y = 1.8 * RDA2, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

arrowhead = arrow(length = unit(0.02, "npc"))
# Make a new graphic
p3 <- p.ccaB + 
  geom_segment(
    mapping = arrow_map, 
    size = .5, 
    data = arrowdf, 
    color = "gray", 
    arrow = arrowhead)  +
  geom_text(
   mapping = label_map, 
  size = 4,  
  data = arrowdf, 
  show.legend = FALSE)

psCbac <- physeq.pw.flt

#Fungi
physeq.pw.flt <- prune_samples(sample_data(physeqF)$Soil == "Chromosol", physeqF)
physeq.pw.flt = filter_taxa(physeq.pw.flt, function(x) sum(x > 0) > (0.20*length(x)), TRUE) #must be present in x percent of samples
physeq.pw.flt <-  microbiome::transform(physeq.pw.flt, "clr") #clr transform

ord_ccaB <- phyloseq::ordinate(physeq.pw.flt, "RDA", "bray",formula = ~ HUM.clr + POC.clr + ROC.clr)

p.ccaB  <- phyloseq::plot_ordination(rare_Fun, ord_ccaB , color = "Dloss", shape = "Dloss_fct2") +
    geom_point(aes(size =  Dloss)) +
    scale_colour_gradient(low = "cadetblue1", high = "navy")+
  ggtitle("Fungi, Chromosol") 

# Now add the environmental variables as arrows to either of these p1 or p2
arrowmat <- vegan::scores(ord_ccaB, display = "bp")
arrowmat <- data.frame(arrowmat)
rownames(arrowmat) <- c("HUM (%)", "POC (%)", "ROC (%)")
# Add labels, make a data.frame
arrowdf <- data.frame(labels = rownames(arrowmat), arrowmat)
# Define the arrow aesthetic mapping
arrow_map <- aes(xend = 1 * RDA1, 
                 yend = 1 * RDA2, 
                 x = 0, 
                 y = 0, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

label_map <- aes(x = 1.8 * RDA1, 
                 y = 1.8 * RDA2, 
                 shape = NULL, 
                 color = NULL, 
                 label = labels)

arrowhead = arrow(length = unit(0.02, "npc"))
# Make a new graphic
p4 <- p.ccaB + 
  geom_segment(
    mapping = arrow_map, 
    size = .5, 
    data = arrowdf, 
    color = "gray", 
    arrow = arrowhead)  +
  geom_text(
   mapping = label_map, 
  size = 4,  
  data = arrowdf, 
  show.legend = FALSE)

psCfun <- physeq.pw.flt


pdf(NULL)
g1 <- ggarrange( nrow = 2, ncol = 1, p1,p2,  common.legend = TRUE, legend = "right")
g2 <- ggarrange(nrow = 2, ncol = 1, p3, p4, common.legend = TRUE, legend = "right")
g3 <- ggarrange(nrow = 1, ncol = 2,g1,g2)
x = dev.off()
g3

print(paste("After filtering the analysis included", ntaxa(psKbac),"and", ntaxa(psKfun),
            "bacterial and fungal taxa in the Kurosol and ", ntaxa(psCbac), "and", ntaxa(psCfun), "in the Chromosol"))
```

<br/>

Fungal community composition in the Kurosol was more driven by organic matter composition compared to both, bacteria overall and fungi in the Chromosol. In the Kurosol, the variance explained in RDA1 and RDA2 was approximately twice as high for fungi (21.6% and 5.9%) compared to bacteria (9.8% and 5.9%). This was different to the Chromosol where the explained variation for RDA1 and RDA2 was similar for bacteria and fungi.  
In the Kurosol, there was some grouping of samples where the composition of bacteria and fungi associated with ROC which coincided with the lowest long-term dieldrin loss (%). On the other hand, the highest dieldrin loss (%) was observed in samples where the community composition associated with HUM. POS had little to no importance for bacterial and fungal composition in the Kurosol.   
By contrast, the community in the Chromosol was more driven by POC. However, no association of the community and organic matter composition to long-term dieldrin loss (%) could be inferred.  
    
(Fig \@ref(fig:rda))  
  
<br/>

## Metabolic potential
### Comparison of xenobiotic degradation potentials
```{r xenobgraphs, fig.cap = "Comparison of all xenobiotic degradation pathways predicted to be present.", message=FALSE, warning=FALSE, echo=FALSE, fig.width=9, fig.asp = 0.45, cache = TRUE}
physeq.pw.flt  <-   prune_samples(sample_data(physeq.pw)$Farm != "C", physeq.pw)
#physeq.pw.flt = filter_taxa(physeq.pw.flt , function(x) sum(x > 0) > (0.25*length(x)), TRUE)
#replace pw numbers with common name
#taxtable <- data.frame(`COMMON.NAME` = (tax_table(physeq.pw.flt)@.Data[,c("COMMON-NAME")]))
#taxa_names(physeq.pw.flt) <- taxtable$COMMON.NAME
x <- as.data.frame(t(otu_table(physeq.pw.flt))) 
TSS.divide = function(x){
 x/sum(x)
  }
data.TSS = t(apply(x + 0.65, 1, TSS.divide))
# ratio ####
TC <- sample_data(physeq.pw.flt) %>% data.frame %>% rownames_to_column("OTUID") %>% dplyr::select(OTUID, TC)
#add to TSS
data.TSS.TC <- x %>% as.data.frame %>%  rownames_to_column("OTUID") %>% left_join(TC) %>% column_to_rownames("OTUID")
#then devide by TC or Dieldrin and remove Dieldrin
data.TSS.TC.ratio <- data.TSS.TC %>% rownames_to_column("OTUID") %>% 
  mutate_at(vars(- TC, - OTUID), ~ . / TC) %>% column_to_rownames("OTUID") %>% dplyr::select(-TC)
data.TSS.TC.ratio <- log1p(data.TSS.TC.ratio)
data.TSS_TCratio.phyl <- data.TSS.TC.ratio %>% t
physeq.pw_TCratio <-phyloseq(otu_table(
            data.TSS_TCratio.phyl, taxa_are_rows = T), 
              tax_table(as.data.frame(pw.names) %>% as.matrix()),
             sample_data(metadata2 %>% as.data.frame() %>% column_to_rownames("#SampleID")))
ps_clr <- microbiome::transform(physeq.pw_TCratio, "log10p")

physeq.pw.melt.TCratio <- psmelt(physeq.pw_TCratio)
my_comparisons <- list( c("<=43%", ">43%"), c("<72%", ">=72%") )
# figure                
physeq.pw.melt.TCratio  %>% filter( str_detect(tolower(COMMON.NAME), pattern =  "chloros") | str_detect(tolower(COMMON.NAME), pattern =  "superpathway of aerobic toluene") | str_detect(tolower(COMMON.NAME), pattern =  "biphenyl") | str_detect(tolower(COMMON.NAME), pattern =  "benze") ) %>% filter(Abundance != 0) %>% ggboxplot(., x = "Dloss_fct2", y = "Abundance", add = c("jitter"), scales = "free", facet.by = "COMMON.NAME", fill = "Soil", ylab = "Metacyc pathway (Logratio to total carbon)", xlab = "Dieldrin loss", nrow = 10, ncol = 4) + stat_compare_means( method = "kruskal",label = "p.signif") + stat_compare_means(comparisons = my_comparisons)

# wilcoxon test
#physeq.pw.melt.TCratio %>% filter( str_detect(tolower(COMMON.NAME), pattern =  "chloros") | str_detect(tolower(COMMON.NAME), pattern =  "superpathway of aerobic toluene") | str_detect(tolower(COMMON.NAME), pattern =  "biphenyl") | str_detect(tolower(COMMON.NAME), pattern =  "benze") ) %>% filter(Abundance != 0) %>%  ggpubr::compare_means(Abundance ~ Soil, data = ., group.by = "COMMON.NAME", method = "wilcox.test", paired = FALSE, symnum.args = list(), p.adjust.method = "holm") %>% as.data.frame() %>% dplyr::filter(p.adj <= 1)

# "2-chloroacrylate", tetrachloroethene degradation, pentachlorophenol degradation, γ-hexachlorocyclohexane degradation, 1,4-dichlorobenzene degradation pathway, 1,2-dichloroethane degradation pathway, phenol degradation, cyclohexanol oxidation, 2,4,6-trichlorophenol degradation, toluene degradation to 2-hydroxypentadienoate (via 4-methylcatechol), 3,4,6-trichlorocatechol degradation, 4,5-dichlorocatechol degradation, pentachlorophenol degradation, 4-chloronitrobenzene degradation, ethene and chloroethene degradation
```
  
<br/>

### Partial least squares regression
**Metacyc pathways**  
  
Go [here](https://metacyc.org/pwy-search.shtml) to search for metacyc pathways  
Go [here](https://mixomicsteam.github.io/Bookdown/index.html) to see mixOmics bookdown vignette
  
```{r plsheatmapsall, fig.cap = "Ward clustered heatmap of similarity scores obtained from sparse partial least squares analysis in regression mode (R package mixOmics) for pathway potentials (rows) and soil variables (columns) accross both soils (n = 33). Soil variabels included the average dieldrin concentrations from 2015 and 2017 (log D1517), C:N ratio (log CN), H:C ratio (log HC), ROC, HUM and POC. The pathway potentials and ROC, HUM and POC were clr transformed before analysis. Only associations scores >= 0.50 are shown." , message=FALSE, warning=FALSE, echo=FALSE, fig.width=10, fig.asp = 1, cache = FALSE}

#process: 
#create tc ratio of pathways after TSS transform
#then clr transform in ps object
#then pathway table with common names for analysis

#Across both soils
physeq.pw.flt  <- prune_samples(sample_data(physeq.pw)$Farm != "C", physeq.pw)
physeq.pw.flt = filter_taxa(physeq.pw.flt, function(x) sum(x > 0) > (0.25*length(x)), TRUE)
#physeq.pw.flt <- microbiome::transform(physeq.pw.flt, "clr")

#normalisation
# each variable read count is divided by the total number of read counts
TSS.divide = function(x){
 x/sum(x)
}
x <- as.data.frame(t(otu_table(physeq.pw.flt)))
data.TSS = t(apply(x, 1, TSS.divide))
# ratio ####
TC <- sample_data(physeq.pw.flt) %>% data.frame %>% rownames_to_column("OTUID") %>% dplyr::select(OTUID, TC)
data.TSS.TC <- data.TSS %>% as.data.frame %>%  rownames_to_column("OTUID") %>% left_join(TC) %>% column_to_rownames("OTUID")
#then devide by TC or Dieldrin and remove TC or dieldrin
data.TSS.TC.ratio <- data.TSS.TC %>% rownames_to_column("OTUID") %>% mutate_at(vars(- TC, - OTUID), ~ . / TC) %>% column_to_rownames("OTUID") %>% dplyr::select(-TC)

data.TSS_TCratio.phyl <- data.TSS.TC.ratio %>% t
physeq.pw_TCratio <-phyloseq(otu_table( data.TSS_TCratio.phyl, taxa_are_rows = T),   tax_table(as.data.frame(pw.names) %>% as.matrix()), sample_data(metadata2 %>% as.data.frame() %>% column_to_rownames("#SampleID"))) 
ps_clr <- microbiome::transform(physeq.pw_TCratio, "clr")

#replace pw numbers with common name
taxtable <- data.frame(`COMMON.NAME` = (tax_table(ps_clr)@.Data[,c("COMMON-NAME")]))
taxa_names(ps_clr) <- taxtable$COMMON.NAME

#tables for analysis
x <- as.data.frame(t(otu_table(ps_clr)))
y <- data.frame(sample_data(physeq.pw.flt)[,c("HUM", "ROC", "POC", "D1517", "H")])
y$D1517 <- y$D1517 / 1000 #everything on same units (g/kg) 

#relative data
require(compositions)
y <- data.frame(clr(y))

pw.spls <- mixOmics::spls(x, y, ncomp =5,  mode = "regression", scale = FALSE, keepX = c(400, 375, 150))
#tune.spls <- mixOmics::perf(pw.spls, validation = "Mfold", folds = 20, progressBar = FALSE, nrepeat = 500)
#plot(tune.spls$Q2.total,main = "sPLS Q^2 Values by Principal Component")
#abline(h = 0.0975)

mixOmics::cim(pw.spls, comp = 1:2, xlab = "", title = "Across both soils", margins = c(5, 30), threshold = 0.4)

#cim does not output into markdown, export graph and link to mardown, or does it? sometimes it works
#knitr::include_graphics("./mixomics_heatmaps_regression_bothsoils_spls.png")

#tune.spls <- mixOmics::perf(pw.spls, validation = "Mfold", folds = 10, progressBar = FALSE, nrepeat = 1000)
#tune.spls$Q2.total #test 
#Tenenhaus, M. (1998) suggests using a cuttoff of 0.0975 for Q2 values, where any component with values lower than the cutoff are not included in the model.
#print(tune.spls$R2[,c(1:2)])   #Coefficient of Determination
#print(tune.spls$MSEP[,c(1:2)]) #MeanSquareError of predictions
#How can I calculate the coefficients of the linear combinations when using PLS?

pred <- predict(pw.spls, as.matrix(x))
test <- data.frame(pred$B.hat) %>% rownames_to_column("pathway")
test <- test %>% dplyr::select(pathway, D1517.dim1,D1517.dim2 ) %>% filter(D1517.dim1 != 0 | D1517.dim2 != 0 ) %>% arrange(D1517.dim1) %>% filter(D1517.dim1 >= 0.003 | D1517.dim1 <= -0.01)

kable(test, caption = "Top regression coefficients of sPLS analysis across both soils (n=33). Values are the predicted effect of metabolic pathway potentials on dieldrin concentrations") %>% kable_styling(latex_options="scale_down")
```

<br/>

```{r, tblemixomicsall, echo = FALSE, message=FALSE, warning=FALSE, include = FALSE, eval = FALSE}
#print the correlation coordinates
#bisect = pw.spls$variates$X[, 1:2] + pw.spls$variates$Y[, 1:2]
#cord.X = cor(pw.spls$X, bisect, use = "pairwise")
#cord.Y = cor(pw.spls$Y, bisect, use = "pairwise")
#simMat = as.matrix(cord.X %*% t(cord.Y))
#filter1
#simMat.flt <- round(simMat,2) %>% data.frame() %>% rownames_to_column("Pathway") %>%
#  filter(D1517 >= 0.6 |
#           D1517 <= -0.6) %>% 
#  arrange(D1517)

#kable(simMat.flt,  "latex", booktabs=TRUE, caption = "This is the table caption") %>% 
#  kable_styling(latex_options="scale_down") %>%
#  as_image()

#kable(simMat.flt, booktabs=TRUE, caption = "Similarities of pathway potentials and components one and two of the sparse partial least squares analysis. Only similarities >= 0.6 to dieldrin concentrations are shown.") %>% 
#  kable_styling(latex_options="scale_down")
#flextable(simMat.flt)
```


```{r plsheatmapsku, fig.cap = "Ward clustered heatmap of similarity scores obtained from sparse partial least squares analysis in regression mode (R package mixOmics) for pathway potentials (rows) and soil variables (columns) for Kurosol samples (n = 18). Soil variables included the average dieldrin concentrations from 2015 and 2017 (log D1517), C:N ratio (log CN), H:C ratio (log HC), ROC, HUM and POC. The pathway potentials and ROC, HUM and POC were clr transformed before analysis. Only associations scores >= 0.50 are shown.", message=FALSE, warning=FALSE, echo=FALSE, fig.width=10, fig.asp = 0.6, cache = TRUE}


#Kurosol
physeq.pw.flt <- prune_samples(sample_data(physeq.pw)$Soil == "Kurosol", physeq.pw)
physeq.pw.flt  <- prune_samples(sample_data(physeq.pw.flt)$Farm != "C", physeq.pw.flt)
physeq.pw.flt = filter_taxa(physeq.pw.flt, function(x) sum(x > 0) > (0.25*length(x)), TRUE)
#physeq.pw.flt <- microbiome::transform(physeq.pw.flt, "clr")

#normalisation
# each variable read count is divided by the total number of read counts
TSS.divide = function(x){
 x/sum(x)
}
x <- as.data.frame(t(otu_table(physeq.pw.flt)))
data.TSS = t(apply(x, 1, TSS.divide))
# ratio ####
TC <- sample_data(physeq.pw.flt) %>% data.frame %>% rownames_to_column("OTUID") %>% dplyr::select(OTUID, TC)
data.TSS.TC <- data.TSS %>% as.data.frame %>%  rownames_to_column("OTUID") %>% left_join(TC) %>% column_to_rownames("OTUID")
#then devide by TC or Dieldrin and remove TC or dieldrin
data.TSS.TC.ratio <- data.TSS.TC %>% rownames_to_column("OTUID") %>% mutate_at(vars(- TC, - OTUID), ~ . / TC) %>% column_to_rownames("OTUID") %>% dplyr::select(-TC)

data.TSS_TCratio.phyl <- data.TSS.TC.ratio %>% t
physeq.pw_TCratio <-phyloseq(otu_table( data.TSS_TCratio.phyl, taxa_are_rows = T),   tax_table(as.data.frame(pw.names) %>% as.matrix()), sample_data(metadata2 %>% as.data.frame() %>% column_to_rownames("#SampleID"))) 
ps_clr <- microbiome::transform(physeq.pw_TCratio, "clr")

#replace pw numbers with common name
taxtable <- data.frame(`COMMON.NAME` = (tax_table(ps_clr)@.Data[,c("COMMON-NAME")]))
taxa_names(ps_clr) <- taxtable$COMMON.NAME

#tables for analysis
x <- as.data.frame(t(otu_table(ps_clr)))
y <- data.frame(sample_data(physeq.pw.flt)[,c("HUM", "ROC", "POC", "D1517", "H")])
y$D1517 <- y$D1517 / 1000 #everything on same units (g/kg) 

#relative data
require(compositions)
y <- data.frame(clr(y))


pw.spls <- mixOmics::spls(x, y, ncomp =5,  mode = "regression", scale = FALSE, keepX = c(5,10,5,5))
#tune.spls <- mixOmics::perf(pw.spls, validation = "Mfold", folds = 10, progressBar = FALSE, nrepeat = 500)
#plot(tune.spls$Q2.total,main = "sPLS Q^2 Values by Principal Component")
#abline(h = 0.0975)

mixOmics::cim(pw.spls, comp = 1:2, xlab = "", title = "Kurosol", margins = c(5, 25))
#cim does not output into markdown, export graph and link to mardown
#knitr::include_graphics("./mixomics_heatmaps_regression_KUROSOL_spls.png")

#tune.spls <- mixOmics::perf(pw.spls, validation = "Mfold", folds = 10, progressBar = FALSE, nrepeat = 1000)
#test how many components are meaningful 
#data.frame(tune.spls$Q2.total)
#Tenenhaus, M. (1998) suggests using a cuttoff of 0.0975 for Q2 values, where any component with values lower than the cutoff are not included in the model.
#print(tune.spls$R2[,c(1:2)])   #Coefficient of Determination
#print(tune.spls$MSEP[,c(1:2)]) #MeanSquareError of predictions

pred <- predict(pw.spls, as.matrix(x))
test <- data.frame(pred$B.hat) %>% rownames_to_column("pathway")
test <- test %>% dplyr::select(pathway, D1517.dim1,D1517.dim2 ) %>% filter(D1517.dim1 != 0 | D1517.dim2 != 0 ) %>% arrange(D1517.dim1)

kable(test, booktabs=TRUE, caption = "Regression coefficients of sPLS analysis across in the Kurosol (n=18). Values are the predicted effect of the metabolic pathway potentials on dieldrin concentrations") %>% kable_styling(latex_options="scale_down")

```

```{r, tblemixomicskuNOTINCLUDE, echo = FALSE, message=FALSE, warning=FALSE, include=FALSE, eval=FALSE }
#print the correlation coordinates
#bisect = pw.spls$variates$X[, 1:2] + pw.spls$variates$Y[, 1:2]
#cord.X = cor(pw.spls$X, bisect, use = "pairwise")
#cord.Y = cor(pw.spls$Y, bisect, use = "pairwise")
#simMat = as.matrix(cord.X %*% t(cord.Y))
#filter1
#simMat.flt <- round(simMat,2) %>% data.frame() %>% rownames_to_column("Pathway") %>%
#  filter(D1517 >= 0.65 |
#           D1517 <= -0.65) %>% 
#  arrange(D1517)

#kable(simMat.flt,  "latex", booktabs=TRUE, caption = "This is the table caption") %>% 
#  kable_styling(latex_options="scale_down") %>%
#  as_image()

#kable(simMat.flt, booktabs=TRUE, caption = "Kurosol only: Similarities of pathway potentials and components one and two of the sparse partial least squares analysis. Only similarities >= 0.65 to dieldrin concentrations are shown.") %>% 
#  kable_styling(latex_options="scale_down")
#flextable(simMat.flt)
```


```{r plsheatmapsch,fig.cap = "Ward clustered heatmap of similarity scores obtained from sparse partial least squares analysis in regression mode (R package mixOmics) for pathway potentials (rows) and soil variables (columns) for Chromosol samples (n = 15). Soil variabels included the average dieldrin concentrations from 2015 and 2017 (log D1517), C:N ratio (log CN), H:C ratio (log HC), ROC, HUM and POC. The pathway potentials and ROC, HUM and POC were clr transformed before analysis. Only associations scores >= 0.50 are shown.", message=FALSE, warning=FALSE,echo=FALSE, fig.width=10, fig.asp = 0.6, cache = TRUE }

#Chromosol
physeq.pw.flt <- prune_samples(sample_data(physeq.pw)$Soil == "Chromosol", physeq.pw)
physeq.pw.flt  <- prune_samples(sample_data(physeq.pw.flt)$Farm != "C", physeq.pw.flt)
physeq.pw.flt = filter_taxa(physeq.pw.flt, function(x) sum(x > 0) > (0.25*length(x)), TRUE)
#physeq.pw.flt <- microbiome::transform(physeq.pw.flt, "clr")

#normalisation
# each variable read count is divided by the total number of read counts
TSS.divide = function(x){
 x/sum(x)
}
x <- as.data.frame(t(otu_table(physeq.pw.flt)))
data.TSS = t(apply(x, 1, TSS.divide))
# ratio ####
TC <- sample_data(physeq.pw.flt) %>% data.frame %>% rownames_to_column("OTUID") %>% dplyr::select(OTUID, TC)
data.TSS.TC <- data.TSS %>% as.data.frame %>%  rownames_to_column("OTUID") %>% left_join(TC) %>% column_to_rownames("OTUID")
#then devide by TC or Dieldrin and remove TC or dieldrin
data.TSS.TC.ratio <- data.TSS.TC %>% rownames_to_column("OTUID") %>% mutate_at(vars(- TC, - OTUID), ~ . / TC) %>% column_to_rownames("OTUID") %>% dplyr::select(-TC)

data.TSS_TCratio.phyl <- data.TSS.TC.ratio %>% t
physeq.pw_TCratio <-phyloseq(otu_table( data.TSS_TCratio.phyl, taxa_are_rows = T),   tax_table(as.data.frame(pw.names) %>% as.matrix()), sample_data(metadata2 %>% as.data.frame() %>% column_to_rownames("#SampleID"))) 
ps_clr <- microbiome::transform(physeq.pw_TCratio, "clr")

#replace pw numbers with common name
taxtable <- data.frame(`COMMON.NAME` = (tax_table(ps_clr)@.Data[,c("COMMON-NAME")]))
taxa_names(ps_clr) <- taxtable$COMMON.NAME

#tables for analysis
x <- as.data.frame(t(otu_table(ps_clr)))
y <- data.frame(sample_data(physeq.pw.flt)[,c("HUM", "ROC", "POC", "D1517", "H")])
y$D1517 <- y$D1517 / 1000 #everything on same units (g/kg) 

#relative data
require(compositions)
y <- data.frame(clr(y))

pw.spls <- mixOmics::spls(x, y, ncomp =5,  mode = "regression", scale = FALSE, keepX = c(100,10,10))
#tune.spls <- mixOmics::perf(pw.spls, validation = "Mfold", folds = 10, progressBar = FALSE, nrepeat = 1000)
#plot(tune.spls$Q2.total,main = "sPLS Q^2 Values by Principal Component")
#abline(h = 0.0975)

mixOmics::cim(pw.spls, comp = 1:2, xlab = "", title = "Chromosol", margins = c(5, 25))

#mixOmics::cim(pw.spls, comp = 1:2, xlab = "", title = "Chromosol", threshold = 0.5, margins = c(5, 15))
#cim does not output into markdown, export graph and link to mardown
#knitr::include_graphics("./mixomics_heatmaps_regression_CHROMOSOL_spls.png")

#tune.spls$Q2.total #test how many components are meaningful 
#Tenenhaus, M. (1998) suggests using a cuttoff of 0.0975 for Q2 values, where any component with values lower than the cutoff are not included in the model.
#print(tune.spls$R2[,c(1:2)])   #Coefficient of Determination
#print(tune.spls$MSEP[,c(1:2)]) #MeanSquareError of predictions

pred <- predict(pw.spls, as.matrix(x))
test <- data.frame(pred$B.hat) %>% rownames_to_column("pathway")
test <- test %>% dplyr::select(pathway, D1517.dim1,D1517.dim2 ) %>%
  filter(D1517.dim1 != 0 | D1517.dim2 != 0 ) %>% arrange(D1517.dim1) %>% filter(D1517.dim1 >= 0.01 | D1517.dim1 <= -0.005)

kable(test, booktabs=TRUE, caption = "Top regression coefficients of sPLS analysis across in the Chromosol (n=15). Values are the predicted effect of the metabolic pathway potentials on dieldrin concentrations") %>% kable_styling(latex_options="scale_down")

```

```{r, tblemixomicsch, echo = FALSE, message=FALSE, warning=FALSE, include= FALSE, eval=FALSE }
#print the correlation coordinates
#bisect = pw.spls$variates$X[, 1:2] + pw.spls$variates$Y[, 1:2]
#cord.X = cor(pw.spls$X, bisect, use = "pairwise")
##cord.Y = cor(pw.spls$Y, bisect, use = "pairwise")
#simMat = as.matrix(cord.X %*% t(cord.Y))
#filter1
#simMat.flt <- round(simMat,2) %>% data.frame() %>% rownames_to_column("Pathway") %>%
#  filter(D1517 >= 0.65 |
#           D1517 <= -0.65) %>% 
#  arrange(D1517)

#kable(simMat.flt,  "latex", booktabs=TRUE, caption = "This is the table caption") %>% 
#  kable_styling(latex_options="scale_down") %>%
#  as_image()

#kable(simMat.flt, booktabs=TRUE, caption = "Chromosol only: Similarities of pathway potentials and components one and two of the sparse partial least squares analysis. Only similarities >= 0.65 to dieldrin concentrations are shown.") %>% 
#  kable_styling(latex_options="scale_down")
#flextable(simMat.flt)
```

<br/>
When both soils were included in sPLS analysis the strongest associations of metabolic potentials to dieldrin concentrations were negative, meaning that pathway potentials were predictive of lower dieldrin concentrations rather than higher. In general, when pathway potentials predicted lower dieldrin concentrations, they also predicted a lower C:N ratio and ROC proportions and higher POC proportions (Fig. \@ref(fig:plsheatmapsall). 
  

Some general info on highly associated metacyc pathways:  
  
- Anaerobic metabolism
  - Coenzyme B and M biosynthesis
    - required for methanogenesis in anaerobic respiration. 
  - Reductive TCA cycle
    - by anoxic photosynthetic bacteria and sulfur reducing bacteria
  - L-isoleucine biosynthesis IV
    - is a non-polar and uncharged molecule (amino acid)
    - biosynthesis by anaerobic bacteria and archaea including chlostridium and methanobacteria
  - pyruvate fermentation 
    - central to anaerobic energy production
  - 4-coumarate degradation (anaerobic)
    - phenylpropanoid (aromatic plant compound)
  - purine nucleobases degradation I (anaerobic)
  
- Ruderal traits, see @Wood2018
  - pyrimidine deoxyribonucleosides salvage
    - related to potential of ribosome production
    - "The de novo synthesis of ribonucleotides is very expensive, and organisms have adapted to salvage pyrimidine deoxyribonucleosides salvagepotential precursors from their environment"
  - glycogen degradation I
    - The glycogen is broken down and utilized when carbon sources become limiting
  - superpathway of L-aspartate and L-asparagine biosynthesis
    - "This pathway is common in both prokaryotes and eukaryotes, and provides a link between amino acid and carbohydrate metabolism"
  - Enterobactin biosynthesis
    - siderophore to utilise the otherwise insoluble Fe^3+^
    - almost exclusively produced by enterobacteria but also some Streptomyses sp. 
    - produced extracellular and utilised by many other bacteria  

<br/>

Figure \@ref(fig:plsheatmapsku) shows that most of the metabolic pathway potentials in the Kurosol coincided with increased ROC proportions. In samples that contained a higher proportion of ROC the potential of x (number of pathways) pathways increased. Overall, this conicided with lower HUM proportion in those samples.  
  
<br/>


### Partial least squares discriminant analysis (PLS-DA)
  
Note: The following pathways were selected by PLS-DA to be key predictors for dielrin loss (dieldrin loss in four factors)
```{r plsdakurNOTINCLUDE, fig.cap = "Kurosol: Potentials of metabolic pathways which were predicted to be different between samples with low and high dieldrin loss (%) by partial least squares discriminant anaylysis (PLS-DA).  Samples are grouped by long-term dielrin loss (%) where the loss is either below or above the median loss in each soil type. Significance of global Kruskal-Wallis tests and Wilcoxon tests for each soil type are shown.", message=FALSE, warning=FALSE, echo= FALSE, fig.width=8, fig.asp = 0.45, cache = TRUE, include= FALSE, eval=FALSE}

ps_clr <- microbiome::transform(physeq.pw, "compositional")
physeq.pw.melt.comp <- psmelt(ps_clr)
my_comparisons <- list( c("<=43%", ">43%"), c("<72%", ">=72%") )
p1 <- physeq.pw.melt.comp   %>% filter(OTU %in% c("PWY-7332","PWY-5392")) %>%
ggboxplot(., x = "Dloss_fct2", y = "Abundance", add = c("jitter"), scales = "free", facet.by = "CLASS3", fill = "Soil", ylab = "Metacyc pathway (Relative abundance)", xlab = "Dieldrin loss") + stat_compare_means( method = "kruskal",label = "p.signif") + stat_compare_means(comparisons = my_comparisons)
p1

#Figure \@ref(fig:plsdakur) shows that the genetic potential for the reductive TCA-cycle and the synthesis of membrane components (UDP-N-acetylglucosamine-derived O-antigen building blocks) was significantly different between samples of the Kurosol which had low and high dieldrin losses.  
#In the Chromosol these pathways were also present but mean potential of these pathways was similar between low and high-loss samples.  
```


```{r plsdakurTCratioNOINCLUDE, fig.cap = "Kurosol: The same graph as before but here the metabolic potentials are shown relative to total carbon (the ratio of pathway abundance and total carbon). This demonstrates the effect of normalising the genetic potential to the total carbon and energy sources in both soils.", message=FALSE, warning=FALSE, echo=FALSE, fig.width=8, fig.asp = 0.45, cache = TRUE,include= FALSE, eval=FALSE}

x <- as.data.frame(t(otu_table(physeq.pw))) 
#normalisation
# each variable read count is divided by the total number of read counts
TSS.divide = function(x){
 x/sum(x)
}
# function is applied to each row (i.e. each sample)
data.TSS = t(apply(x, 1, TSS.divide)) %>% as.data.frame()
#extract Dieldrin
TC <- sample_data(physeq.pw) %>% data.frame %>% rownames_to_column("OTUID") %>% dplyr::select(OTUID, TC)
#add to TSS
data.TSS <- data.TSS %>% rownames_to_column("OTUID") %>% left_join(TC) %>% column_to_rownames("OTUID")
#then devide by Dieldrin and remove Dieldrin
data.TSS_TCratio <- data.TSS %>% rownames_to_column("OTUID") %>% 
  mutate_at(vars(- TC, - OTUID), ~ . / TC) %>% column_to_rownames("OTUID") %>% dplyr::select(-TC)

data.TSS_TCratio.phyl <- data.TSS_TCratio %>% t

physeq.pw_TCratio <-phyloseq(otu_table( data.TSS_TCratio.phyl, taxa_are_rows = T),   tax_table(as.data.frame(pw.names) %>% as.matrix()), sample_data(metadata2 %>% as.data.frame() %>% column_to_rownames("#SampleID"))) 

ps_clr <- microbiome::transform(physeq.pw_TCratio, "log10p")
physeq.pw.melt.TCratio <- psmelt(ps_clr)
my_comparisons <- list( c("<=43%", ">43%"), c("<72%", ">=72%") )

p1 <- physeq.pw.melt.TCratio   %>% filter(OTU %in% c("PWY-7332","PWY-5392")) %>%
ggboxplot(., x = "Dloss_fct2", y = "Abundance", add = c("jitter"), scales = "free", facet.by = "COMMON.NAME", fill = "Soil", ylab = "Metacyc pathway (Logratio to total carbon)", xlab = "Dieldrin loss") + stat_compare_means( method = "kruskal",label = "p.signif") + stat_compare_means(comparisons = my_comparisons)
p1
```


```{r plsdachNOTINCLUDE, fig.cap = "Chromosol: Potentials of metabolic pathways which were predicted to be different between samples with low and high dieldrin loss (%) by partial least squares discriminant anaylysis (PLS-DA). Samples are grouped by long-term dielrin loss (%) where the loss is either below or above the median loss in each soil type. Significance of global Kruskal-Wallis tests and Wilcoxon tests for each soil type are shown.", message=FALSE, warning=FALSE, echo=FALSE, fig.width=15, fig.asp = 0.7, cache = TRUE, include= FALSE, eval=FALSE}
  
my_comparisons <- list( c("<=43%", ">43%"), c("<72%", ">=72%") )
#ps_clr <- microbiome::transform(physeq.pw, "compositional")
#physeq.pw.melt.comp <- psmelt(ps_clr)

p1 <- physeq.pw.melt.comp   %>% filter(OTU %in% c("PWY-5430","PWY-5178","PWY-1882","HCAMHPDEG-PWY","PWY-6690","PWY-6397","PWY-6404","PWY0-1277","PWY-6948","PWY-7007","PWY-5654","PWY-7376")) %>%
ggboxplot(., x = "Dloss_fct2", y = "Abundance", add = c("jitter"), scales = "free", facet.by = "COMMON.NAME", fill = "Soil", ylab = "Metacyc pathway (relative abundance)", xlab = "Dieldrin loss") + stat_compare_means( method = "kruskal",label = "p.signif") + stat_compare_means(comparisons = my_comparisons)
p1


```


```{r plsdach2NOTINCLUDE, fig.cap = "Chromosol: The same graph as before but here the metabolic potentials are shown relative to total carbon (the ratio of pathway abundance and total carbon). This demonstrates the effect of normalising the genetic potential to the total carbon and energy sources in both soils.", message=FALSE, warning=FALSE,echo=FALSE, fig.width=15, fig.asp = 0.7, cache = TRUE,include=FALSE, eval=FALSE }
p2 <- physeq.pw.melt.TCratio   %>% filter(OTU %in% c("PWY-5430","PWY-5178","PWY-1882","HCAMHPDEG-PWY","PWY-6690","PWY-6397","PWY-6404","PWY0-1277","PWY-6948","PWY-7007","PWY-5654","PWY-7376")) %>%
ggboxplot(., x = "Dloss_fct2", y = "Abundance", add = c("jitter"), scales = "free", facet.by = "COMMON.NAME", fill = "Soil", ylab = "Metacyc pathway (Logratio to total carbon)", xlab = "Dieldrin loss") + stat_compare_means( method = "kruskal",label = "p.signif") + stat_compare_means(comparisons = my_comparisons)
p2
```


```{r plsdaall, fig.cap = "Across all 36 samples: Potentials of metabolic pathways which were predicted to be different between samples with low and high dieldrin loss (%) by partial least squares discriminant anaylysis (PLS-DA). Samples are grouped by long-term dielrin loss (%) where the loss is either below or above the median loss in each soil type. Significance of global Kruskal-Wallis tests and Wilcoxon tests for each soil type are shown.", message=FALSE, warning=FALSE, echo=FALSE, fig.width=15, fig.asp = 0.5, cache = TRUE,  include= FALSE, eval=FALSE}
  
my_comparisons <- list( c("<=43%", ">43%"), c("<72%", ">=72%") )

p1 <- physeq.pw.melt.comp   %>% filter(OTU %in% c("PWY-5392","PWY-7255", "PWY-6562","SUCSYN-PWY","PPGPPMET-PWY","CODH-PWY","PWY-7347","PWY-5198","PWY-7392","PWY-6167","PWY-6654","CATECHOL-ORTHO-CLEAVAGE-PWY","PWY-5656","NAD-BIOSYNTHESIS-II,PWY-5417","PWY-6182","PWY-6185","PWY-7295","P261-PWY","ARG+POLYAMINE-SYN")) %>%
ggboxplot(., x = "Dloss_fct2", y = "Abundance", add = c("jitter"), scales = "free", facet.by = "COMMON.NAME", fill = "Soil", ylab = "Metacyc pathway (relative abundance)", xlab = "Dieldrin loss") + stat_compare_means( method = "kruskal",label = "p.signif") + stat_compare_means(comparisons = my_comparisons)
p1
```

```{r plsdall2NOTINCLUDE, fig.cap = "Across all 36 samples: The same graph as before but here the metabolic potentials are shown relative to total carbon (the ratio of pathway abundance and total carbon). This demonstrates the effect of normalising the genetic potential to the total carbon and energy sources in both soils.", message=FALSE, warning=FALSE,echo=FALSE, fig.width=15, fig.asp = 0.7, cache = TRUE, include= FALSE, eval=FALSE}
p2 <- physeq.pw.melt.TCratio   %>% filter(OTU %in% c("PWY-5392","PWY-7255", "PWY-6562","SUCSYN-PWY","PPGPPMET-PWY","CODH-PWY","PWY-7347","PWY-5198","PWY-7392","PWY-6167","PWY-6654","CATECHOL-ORTHO-CLEAVAGE-PWY","PWY-5656","NAD-BIOSYNTHESIS-II,PWY-5417","PWY-6182","PWY-6185","PWY-7295","P261-PWY","ARG+POLYAMINE-SYN")) %>%
ggboxplot(., x = "Dloss_fct2", y = "Abundance", add = c("jitter"), scales = "free", facet.by = "COMMON.NAME", fill = "Soil", ylab = "Metacyc pathway (Logratio to total carbon)", xlab = "Dieldrin loss") + stat_compare_means( method = "kruskal",label = "p.signif") + stat_compare_means(comparisons = my_comparisons)
p2
```


```{r plsdaratiocomp1to3, fig.cap = "Pathway potentials which were predicted to be different between samples with low and high dieldrin loss (%) by partial least squares discriminant anaylysis (PLS-DA). Pathway potentials were transformed into **log carbon ratios** before analysis. Samples are grouped by long-term dielrin loss (%) where the loss is either below or above the median loss in each soil type. Significance of global Kruskal-Wallis tests and Wilcoxon tests for each soil type are shown.", message=FALSE, warning=FALSE, echo=FALSE, fig.width=15, fig.asp = 1.2, cache = TRUE}
require(mixOmics)
#plsda  again this time with pathway converted to TC log ratios instead of centred log ratio

#physeq.pw.flt <- prune_samples(sample_data(physeq.pw)$Soil == "Kurosol", physeq.pw)
physeq.pw.flt  <-   prune_samples(sample_data(physeq.pw)$Farm != "C", physeq.pw)
physeq.pw.flt = filter_taxa(physeq.pw.flt , function(x) sum(x > 0) > (0.25*length(x)), TRUE)
#replace pw numbers with common name
#taxtable <- data.frame(`COMMON.NAME` = (tax_table(physeq.pw.flt)@.Data[,c("COMMON-NAME")]))
#taxa_names(physeq.pw.flt) <- taxtable$COMMON.NAME
x <- as.data.frame(t(otu_table(physeq.pw.flt))) 
TSS.divide = function(x){
 x/sum(x)
  }
data.TSS = t(apply(x + 0.65, 1, TSS.divide))

# ratio ####
TC <- sample_data(physeq.pw.flt) %>% data.frame %>% rownames_to_column("OTUID") %>% dplyr::select(OTUID, TC)
#add to TSS
data.TSS.TC <- x %>% as.data.frame %>%  rownames_to_column("OTUID") %>% left_join(TC) %>% column_to_rownames("OTUID")
#then devide by TC or Dieldrin and remove Dieldrin
data.TSS.TC.ratio <- data.TSS.TC %>% rownames_to_column("OTUID") %>% 
  mutate_at(vars(- TC, - OTUID), ~ . / TC) %>% column_to_rownames("OTUID") %>% dplyr::select(-TC)
data.TSS.TC.ratio <- log1p(data.TSS.TC.ratio)

data.TSS_TCratio.phyl <- data.TSS.TC.ratio %>% t
physeq.pw_TCratio <-phyloseq(otu_table(
            data.TSS_TCratio.phyl, taxa_are_rows = T), 
              tax_table(as.data.frame(pw.names) %>% as.matrix()),
             sample_data(metadata2 %>% as.data.frame() %>% column_to_rownames("#SampleID"))) 

# select variables to predict 
y <- data.frame(sample_data(physeq.pw.flt)[,c("Dloss_fct2")]) 
y <- y$Dloss_fct2


dloss.plsda <- splsda(data.TSS.TC.ratio+0.65, y, ncomp = 5)  # set ncomp to 10 for performance assessment later
#plotIndiv(dloss.plsda , comp = 1:2,
#          group = sample_data(physeq.pw.flt)$Dloss_fct2, ind.names = FALSE, 
#          ellipse = TRUE, legend = TRUE, title = 'PLSDA on dieldrin loss')

#perfomance
# takes a couple of minutes to run
#set.seed(2543) # for reproducibility, only when the `cpus' argument is not used
#perf.plsda.dloss <- perf(dloss.plsda, validation = "Mfold", folds = 5, 
#                 progressBar = TRUE, auc = TRUE, nrepeat =  20, cpus = 2) 
#perf.plsda.dloss$choice.ncomp
#perf.plsda.dloss$error.rate  # error rates
#plot(perf.plsda.dloss, col = color.mixo(5:7), sd = TRUE, legend.position = "horizontal")

# grid of possible keepX values that will be tested for each component
#list.keepX <- c(1:10,  seq(15, 30, 20))
#tune.splsda.dloss <- tune.splsda(data.TSS.TC.ratio, y, ncomp = 3, validation = 'Mfold', folds = 5, progressBar = TRUE, dist = 'max.dist', measure = "BER", test.keepX = list.keepX, nrepeat = 25, cpus = 2)
#saveRDS(tune.splsda.dloss, "~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/R_FieldSurvey16s_M2/tune.splsda.dlossTCratio_25pctpresence21march")
tune.splsda.dloss <- readRDS("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/R_FieldSurvey16s_M2/tune.splsda.dlossTCratio_25pctpresence21march")
#tune.splsda.dloss <- readRDS('~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/R_FieldSurvey16s_M2/tune.splsda.dlossTCratio')
#tune.splsda.dloss <- readRDS('~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/R_FieldSurvey16s_M2/tune.splsda.dlossTCratio_25pctpresence')
#error <- tune.splsda.dloss$error.rate  # error rate per component for the keepX grid
ncomp <- tune.splsda.dloss$choice.ncomp$ncomp # optimal number of components based on t-tests
#ncomp
select.keepX <- tune.splsda.dloss$choice.keepX[1:ncomp]  # optimal number of variables to select
#select.keepX
#plot(tune.splsda.dloss, col = color.jet(4))

##Final model and sample representation
#Our final model includes 1 components and 2 selected variables o.
splsda.dloss2 <- splsda(data.TSS.TC.ratio, y, ncomp = ncomp, keepX = select.keepX) 
#plotIndiv(splsda.dloss2, comp = c(1,2),
#          group = sample_data(physeq.pw.flt )$Dloss_fct2, ind.names = FALSE, 
#          ellipse = TRUE, legend = TRUE,
#          title = 'sPLS-DA on dloss, comp 1 & 2')
#plotIndiv(splsda.dloss2, comp = c(3,4),
#          group = sample_data(physeq.pw.flt )$Dloss_fct2, ind.names = FALSE, 
#          ellipse = TRUE, legend = TRUE,
#          title = 'sPLS-DA on dloss, comp 1 & 3')
#auc.dloss= auroc(splsda.dloss2, roc.comp = 2)

#do another performence test 
# for reproducibility, only when the `cpus' argument is not used
#splsda.dloss2.perf <- perf(splsda.dloss2, validation = "Mfold", folds = 6,
#                   dist = 'max.dist', nrepeat = 25,
#                   progressBar = TRUE, cpus = 2) 
# perf.srbct  # lists the different outputs
#splsda.dloss2.perf$error.rate
#plot(splsda.dloss2.perf, col = color.mixo(5))

splsda_comp1vec <- as.data.frame(selectVar(splsda.dloss2, comp = 1))
splsda_comp2vec <- as.data.frame(selectVar(splsda.dloss2, comp = 2))
splsda_comp3vec <- as.data.frame(selectVar(splsda.dloss2, comp = 3))
#splsda_comp4vec <- selectVar(splsda.dloss2, comp = 4)$name %>% as.vector()
splsda_compvec <- rbind(splsda_comp1vec,splsda_comp2vec)


# here we match the selected variables to the stable features comp1
#ind.match = match(selectVar(splsda.dloss2, comp = 1)$name, 
 #                 names(splsda.dloss2.perf$features$stable[[1]]))
#extract the frequency of selection of those selected variables
#Freq = as.numeric(splsda.dloss2.perf$features$stable[[1]][ind.match])
#data.frame(selectVar(splsda.dloss2, comp = 1)$value, Freq)

# here we match the selected variables to the stable features comp2
#ind.match = match(selectVar(splsda.dloss2, comp = 2)$name, 
#                  names(splsda.dloss2.perf$features$stable[[2]]))
#extract the frequency of selection of those selected variables
#Freq = as.numeric(splsda.dloss2.perf$features$stable[[2]][ind.match])
#data.frame(selectVar(splsda.dloss2, comp = 2)$value, Freq)

# here we match the selected variables to the stable features comp3
#ind.match = match(selectVar(splsda.dloss2, comp = 3)$name, 
#                  names(splsda.dloss2.perf$features$stable[[3]]))
#extract the frequency of selection of those selected variables
#Freq = as.numeric(splsda.dloss2.perf$features$stable[[3]][ind.match])
#data.frame(selectVar(splsda.dloss2, comp = 3)$value, Freq)


# here we match the selected variables to the stable features comp3
#ind.match = match(selectVar(splsda.dloss2, comp = 4)$name, 
 #                 names(splsda.dloss2.perf$features$stable[[4]]))
#extract the frequency of selection of those selected variables
#Freq = as.numeric(splsda.dloss2.perf$features$stable[[4]][ind.match])
#data.frame(selectVar(splsda.dloss2, comp = 4)$value, Freq)


#plotLoadings(splsda.dloss2, comp = 1, title = 'Loadings on comp 1', 
#             contrib = 'max', method = 'mean')
#plotLoadings(splsda.dloss2, comp = 2, title = 'Loadings on comp 2', 
#             contrib = 'max', method = 'mean')
#plotLoadings(splsda.dloss2, comp = 3, title = 'Loadings on comp 3', 
#             contrib = 'max', method = 'mean')
#plotLoadings(splsda.dloss2, comp = 4, title = 'Loadings on comp 4', 
#             contrib = 'max', method = 'mean')

physeq.pw.melt.TCratio <- psmelt(physeq.pw_TCratio)
my_comparisons <- list( c("<=43%", ">43%"), c("<72%", ">=72%") )
#figure                
p2 <- physeq.pw.melt.TCratio   %>% filter(OTU %in% splsda_compvec$name) %>% filter(Abundance != 0) %>% ggboxplot(., x = "Dloss_fct2", y = "Abundance", add = c("jitter"), scales = "free", facet.by = "COMMON.NAME", fill = "Soil", ylab = "Metacyc pathway (Logratio to total carbon)", xlab = "Dieldrin loss", nrow = 10, ncol = 4) + stat_compare_means( method = "kruskal",label = "p.signif") + stat_compare_means(comparisons = my_comparisons)
p2
```

```{r plsdatable, message=FALSE, warning=FALSE,echo=FALSE}
#table with pw names instead of numbers
require(mixOmics)
#physeq.pw.flt <- prune_samples(sample_data(physeq.pw)$Soil == "Kurosol", physeq.pw)
physeq.pw.flt  <-   prune_samples(sample_data(physeq.pw)$Farm != "C", physeq.pw)
physeq.pw.flt = filter_taxa(physeq.pw.flt , function(x) sum(x > 0) > (0.25*length(x)), TRUE)
#replace pw numbers with common name
taxtable <- data.frame(`COMMON.NAME` = (tax_table(physeq.pw.flt)@.Data[,c("COMMON-NAME")]))
taxa_names(physeq.pw.flt) <- taxtable$COMMON.NAME
x <- as.data.frame(t(otu_table(physeq.pw.flt))) 
TSS.divide = function(x){
 x/sum(x)
  }
data.TSS = t(apply(x + 0.65, 1, TSS.divide))

# ratio ####
TC <- sample_data(physeq.pw.flt) %>% data.frame %>% rownames_to_column("OTUID") %>% dplyr::select(OTUID, TC)
#add to TSS
data.TSS.TC <- x %>% as.data.frame %>%  rownames_to_column("OTUID") %>% left_join(TC) %>% column_to_rownames("OTUID")
#then devide by TC or Dieldrin and remove Dieldrin
data.TSS.TC.ratio <- data.TSS.TC %>% rownames_to_column("OTUID") %>% 
  mutate_at(vars(- TC, - OTUID), ~ . / TC) %>% column_to_rownames("OTUID") %>% dplyr::select(-TC)
data.TSS.TC.ratio <- log1p(data.TSS.TC.ratio)
# select variables to predict 
y <- data.frame(sample_data(physeq.pw.flt)[,c("Dloss_fct2")]) 
y <- y$Dloss_fct2

tune.splsda.dloss <- readRDS("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/R_FieldSurvey16s_M2/tune.splsda.dlossTCratio_25pctpresence21march")
ncomp <- tune.splsda.dloss$choice.ncomp$ncomp # optimal number of components 
select.keepX <- tune.splsda.dloss$choice.keepX[1:ncomp]  # optimal number of 
splsda.dloss2 <- splsda(data.TSS.TC.ratio, y, ncomp = ncomp, keepX = select.keepX) 

splsda_comp1vec <- as.data.frame(selectVar(splsda.dloss2, comp = 1))
splsda_comp2vec <- as.data.frame(selectVar(splsda.dloss2, comp = 2))
splsda_comp3vec <- as.data.frame(selectVar(splsda.dloss2, comp = 3))
splsda_compvec <- rbind(splsda_comp1vec,splsda_comp2vec,splsda_comp3vec)

kable(splsda_compvec %>% arrange(value.var), booktab = TRUE ) %>% kable_styling(latex_options="scale_down")
```


## Visual comparison of phylogeny and phylofactor analysis
```{r treesnotinclude,fig.cap = "Comparison of the phylogeney of all ASVs present in the Kurosol and the Chromosol. Tips represent individual ASVs and their colours indicate their phylum membership. Unique ASVs are shown in the outer ring where red indicates if ASVs are unique to a high-loss environment. Samples where determined to be a high-loss environment where the loss was above the median loss of each soil type. Three outlier samples were removed prior to analysis (Kurosol n = 18, Chromosol n = 15). Phylofactorisation was performed with the R package phylofactor and polygons highlight phylogenetic clades with increased presence in high loss samples. Prior to analysis ASVs were filted to those with a minimum of 10 reads", message=FALSE, warning=FALSE,echo=FALSE, fig.width=12, fig.asp = 0.75, cache = TRUE }
library(ggtree)
library(ggnewscale)
#create prevalance table in separate file and determine which phyla to filter out beforehand. 
#https://ucdavis-bioinformatics-training.github.io/2017-September-Microbial-Community-Analysis-Workshop/friday/MCA_Workshop_R/phyloseq.html
```

### Phylogenetic tree 
```{r trees,fig.cap = "Comparison of the phylogeney of all ASVs present in the Kurosol and the Chromosol. Tips represent individual ASVs and their colours indicate their phylum membership. Unique ASVs are shown in the outer ring where red indicates if ASVs are unique to a high-loss environment. Samples where determined to be a high-loss environment where the loss was above the median loss of each soil type. Three outlier samples were removed prior to analysis (Kurosol n = 18, Chromosol n = 15). Phylofactorisation was performed with the R package phylofactor and polygons highlight phylogenetic clades with increased presence in high loss samples. Prior to analysis ASVs were filted to those with a minimum of 10 reads", message=FALSE, warning=FALSE,echo=FALSE, fig.width=12, fig.asp = 0.75, cache = TRUE }
# To annotate tree with significant clades I used phylofactor mixed algorithm with presence absence of ASVs as response variable to dieldrin loss. In other words i am modelling the effect of the soil environment of a low or high dieldrin-loss on clades in the bacterial phylogeny. 
#https://docs.wixstatic.com/ugd/0119a1_099ae20df8424af9a38585dcebc0d45a.pdf

#########################################################
## the following is code used to create the phylofactors

#physeq.B.flt <- prune_samples(sample_data(physeqB)$Soil == "Kurosol", physeqB) #filtering to one soiltype
#alternatively use both soil types and compare results: either
physeq.B.flt <- prune_samples(sample_data(physeqB)$Farm != "C", physeqB) 
#or
#physeq.B.flt <- prune_samples(sample_data(physeq.B.flt)$Farm != "C", physeq.B.flt) 
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) != 0, physeq.B.flt)
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) > 25, physeq.B.flt) #must have at least 11 reads
physeq.B.flt <- subset_taxa(physeq.B.flt, !is.na(Phylum) & !Phylum %in% c("", " p__")) 
physeq.B.flt = phyloseq::subset_taxa(physeq.B.flt, !Phylum %in% c(" p__[Thermi]"," p__FBP"," p__Fusobacteria"," p__MVP-21"," p__OP11"," p__SR1", " p__FCPU426", " p__Euryarchaeota", " p__Lentisphaerae")  )
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) != 0, physeq.B.flt)
taxadf <- as.data.frame(tax_table(physeq.B.flt)@.Data)
taxadfpf <- taxadf  %>% rownames_to_column("OTU")
#or
#taxadfku <- as.data.frame(tax_table(physeq.B.flt)@.Data)
#taxadfkupf <- taxadfku  %>% rownames_to_column("OTU")
#prepare otutable
#Z <- as.data.frame(otu_table(physeq.B.flt))
#Zpa <- decostand(Z, method="pa", MARGIN, range.global, na.rm=FALSE) %>% as.matrix()
#PA_Data <- list('Successes'=Zpa,'Failures'=1-Zpa)

#prepare metadata
#meta.df <- data.frame(sample_data(physeq.B.flt)) %>% rownames_to_column("Sample")

#preare tree
#tree.df <- phyloseq::phy_tree(physeq.B.flt)
#tree_ur <- ape::unroot(tree.df)
#is.rooted(tree_ur)
#all(rownames(Z) == tree_ur$tip.label)

#have a look at everything
#pf.heatmap(tree=tree_ur,Data=Zpa)

#to mix algorithm with presence absence and binomial distribution and dloss as either high or low factor
#PA_Data2 <- matrix.to.phyloframe(Zpa,meta.df,data.name = 'Successes') 
#PA_Data2[,Failures:=1-Successes]
#pf_gpf_mix <- gpf(PA_Data2,tree_ur,frmla.phylo = cbind(Successes,Failures)~phylo*Dloss, 
#                  family=binomial, nfactors=10, alpha = 0.2, ncores = 4)

#pf_gpf_mix$factors
#pf_gpf_mix$models
#pf_gpf_mix$tree


##################################################3


library(ggtree)
library(ggnewscale)
#phylavector for colouring
physeq.B.flt <- prune_samples(sample_data(physeqB)$Soil == "Kurosol", physeqB) 
physeq.B.flt <- prune_samples(sample_data(physeq.B.flt)$Farm != "C", physeq.B.flt) 
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) != 0, physeq.B.flt)
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) > 25, physeq.B.flt) #must have at least 11 reads
physeq.B.flt <- subset_taxa(physeq.B.flt, !is.na(Phylum) & !Phylum %in% c("", " p__")) 

#now filter out as much rubbish as possible
#physeq.B.flt <- subset_taxa(physeq.B.flt, !is.na(Species) & !Species %in% c("", "uncharacterized"))
#phyla2Filter = c("D_1__Fusobacteria","D_1__Spirochaetes","D_1__BRC1","D_1__Dependentiae", "D_1__Epsilonbacteraeota") #Filter whole phyla that have low abundance
#phyla2Filtergg = c(" p__[Thermi]"," p__FBP"," p__Fusobacteria"," p__MVP-21"," p__OP11"," p__SR1", " p__FCPU426", " p__Euryarchaeota", " p__Lentisphaerae")
physeq.B.flt = phyloseq::subset_taxa(physeq.B.flt, !Phylum %in% c(" p__[Thermi]"," p__FBP"," p__Fusobacteria"," p__MVP-21"," p__OP11"," p__SR1", " p__FCPU426", " p__Euryarchaeota", " p__Lentisphaerae")  )
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) != 0, physeq.B.flt)
#use this same filtered data also for phylofactor

Z <- as.data.frame(otu_table(physeq.B.flt))
#Kurosol tree
taxadfku <- tax_table(physeq.B.flt)@.Data %>% as.data.frame

phyla <- taxadfku %>% rownames_to_column("OTUID") %>% dplyr::select(OTUID, Phylum) %>% column_to_rownames("OTUID")
phyla.list <- split(rownames(phyla), phyla$Phylum, drop = TRUE)
#adding that to tree
tree.df <-  phy_tree(physeq.B.flt)
ggtree_gps <- groupOTU(tree.df, phyla.list, "Phylum")  #create phyla.list above
#tree graphing with colours for phyla
colours <- c("grey29", "tomato1","gray","gray", "tan4",
             "blue4","pink","turquoise3", "aquamarine4", "cadetblue4", "darkgoldenrod4", "gold","dodgerblue2","grey55","orange","deeppink","grey10", "grey69", "grey52", "darkorchid", "darksalmon", "seagreen3", "darkred", "yellowgreen","seagreen3", "gray", "orange") # "seagreen3" "darksalmon" "yellowgreen","seagreen3","tomato1""cadetblue4"
ggtree_phyla2 <- ggtree(ggtree_gps, aes(color=Phylum, alpha = 0.5), layout = 'circular', branch.length = 'none') +  theme(legend.position="right") + scale_colour_manual(values = colours) + guides(color = guide_legend(override.aes = list(size=5)))
p1 <- ggtree_phyla2 + ggtitle("Kurosol") + guides(alpha = F)

#add the heatmap around it indicating presence of taxa unique to high / low loss
physeqB.lowlossK <- prune_samples(sample_data(physeq.B.flt)$Dloss_fct2 == ">=72%", physeq.B.flt)
physeqB.lowlossK <- prune_taxa(taxa_sums(physeqB.lowlossK) == 0, physeqB.lowlossK)
taxadflowlossK <- tax_table(physeqB.lowlossK)@.Data %>% as.data.frame %>% rownames_to_column("OTUID")
# xtaxa not present in the HIGH LOSS part of the Kurosol - ONLY present in the low-loss Kurosol, label = "low"

physeqB.highlossK <- prune_samples(sample_data(physeq.B.flt)$Dloss_fct2 != ">=72%", physeq.B.flt)
physeqB.highlossK <- prune_taxa(taxa_sums(physeqB.highlossK) == 0, physeqB.highlossK)
taxadfhighlossK <- tax_table(physeqB.highlossK)@.Data  %>% as.data.frame %>% rownames_to_column("OTUID")
#x taxa not present in the LOW LOSS part of the Kurosol - ONLY present in the HIGH-loss, label = "high"

Z <- as.data.frame(otu_table(physeq.B.flt)) %>% rownames_to_column("OTUID") %>% dplyr::select(OTUID)
Z1 <- as.data.frame(otu_table(physeqB.lowlossK)) %>% rownames_to_column("OTUID") %>% mutate(presence = "low") %>% dplyr::select(OTUID, presence)
Z2 <- as.data.frame(otu_table(physeqB.highlossK )) %>% rownames_to_column("OTUID")%>% mutate(presence= "high")%>% dplyr::select(OTUID, presence)
Z3 <- rbind(Z1,Z2)%>% as.data.frame()
Z <- Z  %>% left_join(Z3) %>%  mutate_each(funs(replace(., which(is.na(.)), "both"))) %>% column_to_rownames("OTUID")

#%>% column_to_rownames("OTUID")
print(paste("On average", round(sum(Z$presence == "low") / nrow(data.frame(sample_data(physeq.B.flt)$Paddock)),2),
            "ASVs were unique per sample in the 'low' dieldrin loss samples of the Kurosol and", 
            round(sum(Z$presence == "high") / nrow(data.frame(sample_data(physeq.B.flt)$Paddock)),2),
            "ASVs were unique in the 'high' dieldrin loss samples of the Kurosol"))


p1.1 <-gheatmap(p1,Z, offset=.4, width=.1, colnames = FALSE,
         colnames_angle=95, colnames_offset_y = .25)+
        scale_fill_manual(values=c("white","tomato1", "white"),labels = c("", "Unique ASVs in high-loss", "")) + labs(fill = "Outer Ring")
p1.1 <- p1.1 + new_scale_fill()
#identify node numbers from ASVids. Separate r document used. 
p1.1 <- p1.1 +  geom_balance(node = 4967,alpha =0.4, color = "red") +  geom_balance(node = 7584,alpha =0.2, color = "red") +  geom_balance(node = 5796, alpha =0.2, color = "red") +  geom_balance(node = 5225, alpha =0.2, color = "red")  +  geom_balance(node = 6869,alpha =0.2, color = "red")#as identified with phylofactor




#Chromosol
physeq.B.flt <- prune_samples(sample_data(physeqB)$Soil == "Chromosol", physeqB)
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) != 0, physeq.B.flt)
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) > 25, physeq.B.flt) #present only in this soil and have at least 11 reads
physeq.B.flt <- subset_taxa(physeq.B.flt, !is.na(Phylum) & !Phylum %in% c("", " p__")) #filter out uncategorised classes
#physeq.B.flt <- subset_taxa(physeq.B.flt, !is.na(Species) & !Species %in% c("", "uncharacterized"))
#phyla2Filter = c("D_1__Fusobacteria","D_1__Spirochaetes","D_1__BRC1","D_1__Dependentiae", "D_1__Epsilonbacteraeota") #Filter whole phyla that have low abundance
#phyla2Filtergg = c(" p__[Thermi]"," p__FBP"," p__Fusobacteria"," p__MVP-21"," p__OP11"," p__SR1", " p__FCPU426", " p__Euryarchaeota", " p__Lentisphaerae", " p__Tenericutes", " p__GAL15")
physeq.B.flt = phyloseq::subset_taxa(physeq.B.flt, !Phylum %in% c(" p__[Thermi]"," p__FBP"," p__Fusobacteria"," p__MVP-21"," p__OP11"," p__SR1", " p__FCPU426", " p__Euryarchaeota", " p__Lentisphaerae", " p__Tenericutes", " p__GAL15")  )
#physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) != 0, physeq.B.flt)
#physeq.B.flt = phyloseq::subset_taxa(physeq.B.flt, !Phylum %in% phyla2Filtergg)

taxadfch <- tax_table(physeq.B.flt)@.Data %>% as.data.frame

phyla <- taxadfch %>% rownames_to_column("OTUID") %>% dplyr::select(OTUID, Phylum) %>% column_to_rownames("OTUID")
phyla.list <- split(rownames(phyla), phyla$Phylum, drop = TRUE)
#adding that to tree
tree.df <-  phy_tree(physeq.B.flt)
ggtree_gps <- groupOTU(tree.df, phyla.list, "Phylum")  #create phyla.list above
#tree graphing with colours for phyla
colours <- c("grey29", "tomato1", "gray","gray", "tan4",
             "pink","turquoise3", "aquamarine4", "cadetblue4", "darkgoldenrod4", "gold", "dodgerblue2", "grey55", "orange", "deeppink", "grey10", "grey69", "seagreen3", "darkred", "yellowgreen", "seagreen3", "tomato1") # "pink", "seagreen3" "darksalmon" "yellowgreen","seagreen3","tomato1"
ggtree_phyla2 <- ggtree(ggtree_gps, aes(color=Phylum,alpha = 0.5), layout = 'circular', branch.length = 'none') +  theme(legend.position="right") + scale_colour_manual(values = colours) + guides(color = guide_legend(override.aes = list(size=5)))
p2 <- ggtree_phyla2 + ggtitle("Chromosol")+ guides(alpha = F)

#add the heatmap around it indicating presence of taxa unique to high / low loss
physeqB.lowlossC <- prune_samples(sample_data(physeq.B.flt)$Dloss_fct2 == ">43%", physeq.B.flt)
physeqB.lowlossC <- prune_taxa(taxa_sums(physeqB.lowlossC) == 0, physeqB.lowlossC)
# xtaxa not present in the HIGH LOSS part of the Kurosol - ONLY present in the low-loss Kurosol, label = "low"
physeqB.highlossC <- prune_samples(sample_data(physeq.B.flt)$Dloss_fct2 != ">43%", physeq.B.flt)
physeqB.highlossC <- prune_taxa(taxa_sums(physeqB.highlossC) == 0, physeqB.highlossC)
#x taxa not present in the LOW LOSS part of the Chromosol - ONLY present in the HIGH-loss, label = "high"
Z <- as.data.frame(otu_table(physeq.B.flt))%>% rownames_to_column("OTUID") %>% dplyr::select(OTUID)
Z1 <- as.data.frame(otu_table(physeqB.lowlossC)) %>% rownames_to_column("OTUID") %>% mutate(presence = "low") %>% dplyr::select(OTUID, presence)
Z2 <- as.data.frame(otu_table(physeqB.highlossC)) %>% rownames_to_column("OTUID")%>% mutate(presence= "high")%>% dplyr::select(OTUID, presence)
Z3 <- rbind(Z1,Z2)%>% as.data.frame()
Z <- Z  %>% left_join(Z3) %>%  mutate_each(funs(replace(., which(is.na(.)), "both"))) %>% column_to_rownames("OTUID")

print(paste("On average", round(sum(Z$presence == "low") / nrow(data.frame(sample_data(physeq.B.flt)$Paddock)),2),
            "ASVs were unique per sample in the 'low' dieldrin loss samples of the Chromosol and", 
            round(sum(Z$presence == "high") / nrow(data.frame( sample_data( physeq.B.flt)$Paddock)), 2),
            "ASVs were unique in the 'high' dieldrin loss samples of the Chromosol"))

p2.2 <-gheatmap(p2,Z, offset=.4, width=.1, colnames = FALSE,
         colnames_angle=95, colnames_offset_y = .25)+
        scale_fill_manual(values=c("white","tomato1", "white"),labels = c("", "Unique ASVs in high-loss", "")) + labs(fill = "Outer Ring")

p2.2 <- p2.2 + new_scale_fill()
#p2.2 <- p2.2 + geom_tippoint(size = 4, shape = 19, aes(subset=grepl(c("2c5fb317b6f53363fb9599d1564fcf4d"), label)))+ 
#  geom_tippoint(size = 4, shape = 19, aes(subset=grepl(c("54bd158743bf59519f9cea2c53bb3e59"), label)))+
#  geom_tippoint(size = 4, shape = 19, aes(subset=grepl(c("52920af771b65f5dde536e57ec110664"), label)))+
#  geom_tippoint(size = 4, shape = 19, aes(subset=grepl(c("ba3e6a798853b51979db3c9b168fd3ed"), label)))+
#  geom_tippoint(size = 4, shape = 19, aes(subset=grepl(c("4a223d68fca635b88e4f1a7b95b40b42"), label)))

p3 <- ggarrange(p1.1, p2.2, common.legend = TRUE)
#ggsave("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/Figures/phylotrees_comparison_uniquetaxainhighloss.pdf",height=8, width=15, units='in', dpi=600)
p3

pf_gpf_mix_Kurosol10factorsDloss <- readRDS("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/phylofactorization/2020_0320_pf_gpf_mix_kurosol_Dloss_alpha0.2" )


print("Model of factor 1")
pf_gpf_mix_Kurosol10factorsDloss$models[[1]]
```
  


(Fig \@ref(fig:trees)) indicates that the phylogenetic ASV composition of the Kurosol and the Chromosol was similar. However, the outer rings show that the Kurosol contained more unique ASVs in high-loss samples.  
Moreover, generalised linear models (glm) in the R package 'phylofactor', with presence/absence of ASVs as response and dieldrin loss (%) as predictor, indicated that there were phylogentic clades that had a significantly higher chance to be found in high-loss samples (shown as polygons on phylogenetic tree). In some instances, these phylogenetic clades coincided with higher clustering of unique ASVs.  
For example the presence of a clade of Firmicutes and Bacteriodetes and the presence of the phyla Chloroflexi and Actinobacteria were associated with increased dieldrin loss. Moreover, the model identified a group of ASVs that belong to the genus Geobacter, which also were overrepresented in samples with highest dieldrin losses (Fig \@ref(fig:pfmix5)).  
  
In the Chromosol, no such clade-associations to dieldrin loss could be identified from the glms.  
    
  
Note: See example of model output. Need to clarify significance calculations. Deviance is huge but nonetheless seems to match the high density of presence of unique ASVs in outer ring. 
  
  
### Phylogenetic clades that were associated to dieldrin loss
  
Note: The following graphs are filtered ASVs of clades that were identified to be more or less likely to be present in high dieldrin-loss environments. Phylofactor modelled the aggregated presence/absences (not abundances) along edges of a phylogenetic tree.

#### Across both soils 
```{r pfmixall, eval=TRUE, include=TRUE, fig.cap = "Result of phylofactor (mixed algorithm) on kurosol (n = 18). Selection of ASVs that had a higher chance to be present in a high loss sample than the remainder of ASVs.", message=FALSE, warning=FALSE,echo=FALSE, fig.width=15, fig.asp = 1, cache = TRUE }
require(metagMisc)

physeq.B.flt <- prune_samples(sample_data(physeqB)$Farm != "C", physeqB) 
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) != 0, physeq.B.flt)
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) > 25, physeq.B.flt) #must have at least 11 reads
physeq.B.flt <- subset_taxa(physeq.B.flt, !is.na(Phylum) & !Phylum %in% c("", " p__")) 
physeq.B.flt = phyloseq::subset_taxa(physeq.B.flt, !Phylum %in% c(" p__[Thermi]"," p__FBP"," p__Fusobacteria"," p__MVP-21"," p__OP11"," p__SR1", " p__FCPU426", " p__Euryarchaeota", " p__Lentisphaerae")  )
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) != 0, physeq.B.flt)
taxadf <- as.data.frame(tax_table(physeq.B.flt)@.Data)
taxadfpf <- taxadf  %>% rownames_to_column("OTU")

#for plotting relative abundances
ps_clr <- microbiome::transform(physeq.B.flt, "compositional")
physeqB.melt.comp <- psmelt(ps_clr)
# for plotting Presence-absences (0/1)
ps_trans <- phyloseq_standardize_otu_abundance(physeq.B.flt, method = "pa")
physeqB.melt.pa <- psmelt(ps_trans)

#load the phylofactor model object (run beforehand) large file >500MB
#pf_gpf_mix_33spls_Dloss_alpha0.2 <- readRDS("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/phylofactorization/2020_0320_pf_gpf_mix_33spls_Dloss_alpha0.2")

#extracting ASV ids from phylofactor object for plotting
#s <- summary(pf_gpf_mix_33spls_Dloss_alpha0.2, taxadfpf, factor=1)
#pf.otus1 <- s$species.list[[1]]
pf.otus1 <- c("c59d5f191c2dbba4a6374a05a495ce46", "072d9131812cd222ac93161f2b692a40", "d3d9c3d9c7a18a09654ebca556d0b670", "3e823ae79fbe71b4454d36ac4e66115a", "5ba5672ee7106fc71aeeee5bbec347fa", "46a600b56ca3d2b3b4bf220dfdbaf3d0")
pf.list1 <- taxadfpf %>% filter(OTU %in% pf.otus1)

pf.otus2 <- c("2cbbbb80bd16248dc853cafb03c1ebd6", "7b578895875774a641054b390e77197c", "40d085450cb0eeca3dafc26ab0f82f40", "4a6a00c55fa8f3ec4224a1cc1ea34b0f", "99a58583df7daa792179254b4f91590f", "339854682b7247d656ab9a3951a390e4", "966c812043622fdd7e4b16c6af56d0e7", "0955fea8a7707cbf9d3861d32e752555", "baa823b7f7abe6beb615fefa030cf324", "48c408c142647159744b8bc59bcc0989", "cf1892c079dbbf0a09c314017e49623c", "34a05c58b7d3c5e49d36c5cbba957889", "267bf03d9c1674abc1f10186732e1dfd", "c0f8ae82831053e3549c3266b70f8f5a", "252e53634b6ac76e9f3c45b5e2401d1b", "8406012e4840f08a52136251f8a92b1b", "f4e1e094741c1835422b4b05ba89f3e2")
pf.list2 <- taxadfpf %>% filter(OTU %in% pf.otus2) #%>% filter(Phylum == " p__Firmicutes")

#s <- summary(pf_gpf_mix_33spls_Dloss_alpha0.2, taxadfpf, factor=3)
#pf.otus3 <- s$species.list[[1]]
pf.otus3 <- c("697a7ee3b337e8d62bb1f7a16cd02700", "1792a58617f48c817ae56ac89d5c17b9", "00030dba364df8c7c5a7659e605c1597", "14a8276f9ad71a2f1faa7a74d90abacf", "34dad192b776e361809cc560b3ec543c", "93076cc0def279709eb6bf1dec583223", "ee20187e2b6c9f0c71ead1f15ee86187", "5d93f81b3d7be0dc23a6cdaf758c18f6", "ca373a4791ebf956b0016d1241bcfc6a", "1a0f9c983a25c608d11acac096f52dd7", "6bdbd7db1942d234aa16f82567ff21bc", "ce2de9f6b5ce0e7c3431ae78037ba327", "b5be660f49ceae47a6e19f40b5b8701b", "1da4a0ec5bb136570a9fc52d503b55b0", "164b4b1b6d1a6c2e218b9e067048c729", "854080deaa8d5312c3c9640817c8e55d", "e9cd0cf93cd22e2caab41996f312888f", "937210de243a043bd9f99727394d3ce3")
pf.list3 <- taxadfpf %>% filter(OTU %in% pf.otus3)

#s <- summary(pf_gpf_mix_33spls_Dloss_alpha0.2, taxadfpf, factor=4)
#pf.otus4 <- s$species.list[[1]]
pf.otus4 <- c("10314554e4084eea00195ecc46b80912", "e3d02d819cb84eb2b5dfcfd5c038d130", "b95977c62e79f6dffa645e08e8a065c1", "c397fba4a5116bfffd331070e7d648c6", "eae2dc0f6d173165e1acd84835560bbf", "2e632098f84552281c4531e2dd167247", "aa3b41b24244cc8474902d5d45bc1fcb", "d6e7d8c817641416095c7ad8e613fbf1", "cb28a26147f093d70b9d62a56af2b059", "65bb54a56f66d8fa680fcb68724291b6", "992978c5059b98ba456ebf04c1c533db", "c59cb7469d9e86e36978c8e4336fae11", "7ae920f7d2076b2495bddf73a4c3c2c3", "bcb49a27c176a8864bdd67bb1d115779", "d81e5bd2bffe7aa18dc7d91c1c00366b", "4773993c3ad17dbdb37844d73794159f", "b259dc8d4e2afeec4ee7848c3e7c5cbc", "0819914bf2153508b14501a977297eed", "bc69b34909134f33bfa7071227725c11", "1c8e19fbe0ee138be7586c817c890dd4", "7163ba11df9223437b828e71246ade21", "3ac70ae1cc07d788cf2fd5595d5acd96", "28071ca47afd087bc9eac0fcd441e97f", "a644044d11ba18bfa4265ff1002f2069", "f707644b431278632b41ee32604d67cd", "5c2c5d1df27950fb2654eebcb4fb546a", "21264115d21b0f7e14e1aa64942b05b8", "ccb9054822edc284b9b1fd58ad1d932c", "b76c970561ce4b9d6dc3f0faccd03563")
pf.list4 <- taxadfpf %>% filter(OTU %in% pf.otus4)

#s <- summary(pf_gpf_mix_33spls_Dloss_alpha0.2, taxadfpf, factor=5)
#pf.otus5 <- s$species.list[[1]]
pf.otus5 <- c("18419c156d2015945854ee3d9dfaa77b", "8d56f5e75c25e75b224256414226fa67", "c80bcf0be6ec210a82af3477b30c588f", "e9ab82fb0ab69ce9454508986dcac942", "a235fc54b0eee76ca8bdb42143d79192", "1159b974d4095ac28646aa301721c07a", "3ae730cbe95dd7bd0e2abe51dffa630a", "d3abbf160e82ffb4a7b534199b3ed3f6", "ceb50bde5414eadb67fc14ca82dc7be9", "99eb487221a17a9869184d2354e4e9d2", "c899d6ba51d8a7175c6501f0b43e1d6b", "47a6e4b11fd2ff9fe2172515bca3e34c", "95e7f835068a9acd712f02de5a796a59", "0d6f684e91d0f0c71959f9066acf478a", "2ef6ba8090bb34dace7c078942ab57a2", "5ee886b4f1563058a4c470a348534ac6", "d725b88353734981da919e5ad0eba821")
pf.list5 <- taxadfpf %>% filter(OTU %in% pf.otus5)

pf.list <- rbind(pf.list1, pf.list2, pf.list3, pf.list4, pf.list5)


#for mean differences by dieldrin loss in each soil
my_comparisons <- list( c("<=43%", ">43%"), c("<72%", ">=72%") )
p1 <- physeqB.melt.pa  %>% filter(OTU %in% pf.list$OTU) %>% filter(Abundance > 0) %>% group_by(Phylum, Class, Order,Sample,Soil, Dloss_fct2, Abundance)  %>% summarise(ASVs = sum(Abundance)) %>% 
ggbarplot(., x = "Dloss_fct2", y = "ASVs", facet.by = "Phylum", fill = "Order", ylab = "Number of ASVs", xlab = "Dieldrin loss", width = 0.5, scales = "free", ncol = 1, legend = "right") 


p2 <- physeqB.melt.comp  %>% filter(OTU %in% pf.list$OTU) %>% filter(Abundance > 0)  %>% 
ggboxplot(., x = "Dloss_fct2", y = "Abundance", facet.by = "Phylum", fill = "Soil", ylab = "Relative abundances", xlab = "Dieldrin loss", scales = "free", ncol = 1, legend = "right") + stat_compare_means( method = "kruskal",label = "p.signif") + stat_compare_means(comparisons = my_comparisons)  

ggarrange(p1, p2)
```

#### Phylofactors in Kurosol samples only
```{r pfmixKU, eval=TRUE, include=TRUE, fig.cap = "Result of phylofactor (mixed algorithm) on kurosol (n = 18). Selection of ASVs that had a higher chance to be present in a high loss sample than the remainder of ASVs.", message=FALSE, warning=FALSE,echo=FALSE, fig.width=15, fig.asp = 1, cache = TRUE }
require(metagMisc)

#physeq.B.flt <- prune_samples(sample_data(physeqB)$Soil == "Kurosol", physeqB) 
#physeq.B.flt <- prune_samples(sample_data(physeq.B.flt)$Farm != "C", physeqB.flt) 

physeq.B.flt <- prune_samples(sample_data(physeqB)$Farm != "C", physeqB) 
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) != 0, physeq.B.flt)
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) > 25, physeq.B.flt) #must have at least 11 reads
physeq.B.flt <- subset_taxa(physeq.B.flt, !is.na(Phylum) & !Phylum %in% c("", " p__")) 
physeq.B.flt = phyloseq::subset_taxa(physeq.B.flt, !Phylum %in% c(" p__[Thermi]"," p__FBP"," p__Fusobacteria"," p__MVP-21"," p__OP11"," p__SR1", " p__FCPU426", " p__Euryarchaeota", " p__Lentisphaerae")  )
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) != 0, physeq.B.flt)
taxadf <- as.data.frame(tax_table(physeq.B.flt)@.Data)
taxadfpf <- taxadf  %>% rownames_to_column("OTU")

#load the phylofactor model object (run beforehand) large file >500MB
#pf_gpf_mix_Kurosol10factorsDloss <- readRDS("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/phylofactorization/2020_0320_pf_gpf_mix_kurosol_Dloss_alpha0.2")

#extracting ASV ids from phylofactor object for plotting
#s <- summary(pf_gpf_mix_Kurosol10factorsDloss, taxadfpf, factor=1)
#pf.otus1 <- s$species.list[[1]]
pf.otus1 <- c("5ad4ffad545af8e279101d52bd189173", "ffd660f96ba6668b2d8d86fc4e150862", "fadc1fce43422756177ad41317c72a37", "556d2892f2a8b8847a3247fcb0841b53", "e3adf5070a4f0bc621b5be1a54fc2cf1", "df5e86acd9c690a8cecde8ebf6b8d790", "07ea90d3cba0e63c62b638d6af347390", "4b4c0434a713ad91f7a80fd1fdfe5f99", "e60538d8e1abfba8ffb1a4d5e2e2fb5e", "8aef22ece6d171d112484d481fe5082d", "9c4fa3b761fb41dbe1410c278b45c74a", "18419c156d2015945854ee3d9dfaa77b", "8d56f5e75c25e75b224256414226fa67", "c80bcf0be6ec210a82af3477b30c588f", "e9ab82fb0ab69ce9454508986dcac942", "a235fc54b0eee76ca8bdb42143d79192", "1159b974d4095ac28646aa301721c07a", "3ae730cbe95dd7bd0e2abe51dffa630a", "d3abbf160e82ffb4a7b534199b3ed3f6", "ceb50bde5414eadb67fc14ca82dc7be9", "99eb487221a17a9869184d2354e4e9d2", "c899d6ba51d8a7175c6501f0b43e1d6b", "47a6e4b11fd2ff9fe2172515bca3e34c", "95e7f835068a9acd712f02de5a796a59", "0d6f684e91d0f0c71959f9066acf478a", "2ef6ba8090bb34dace7c078942ab57a2", "5ee886b4f1563058a4c470a348534ac6", "d725b88353734981da919e5ad0eba821", "8c042751eef9a748126821dc2eb71f58", "790ca784035a19e10a0509645d3b648b", "c92de82fa0cffa371b75660ee82302d8", "6e144f5ad124bc193910a6659e13b2b6", "52f00b06dd9754298ed46da86a57d7dd", "de339ab18eb3fee188a3a44dbc63ae12", "6f2eb7a81076c9c21a71115b8403a43a", "289978a37701e7631ee98a932b56fa3b", "17c05ec7364b9898eeb15037cffae69e", "dac473d7560f1d9853ae3940e601aeca", "a19c8d48be8866755022b879409e43b7", "272280f610946388bdd29586e5b4b364", "5519378454cb181510a7fb7a3316da55", "59d2a4f1118ae8646c2099a0642a9905", "def7773dc2a67bb61aacd71dff9d92cf", "133460606a1d392d2513de52ec4eccba", "236eae2c1dea0ccf849a1d0208bf74a3", "1d5ca33e318e687a714b388c349095d4", "8a4bb6ff54c2b0ee0156a66d357723e1", "80c8ce7e33216db7ee92a9e5440ef07d", "79198483b26980b015690f6afd391a4e", "977eb9c07094fa63a147e2ff482724b2", "f5444f5e73860fcd01b96f937a6a3f35", "e898b9985e0ce22a35beea531fa0bda4", "92172b7231563e4a055d3a499816e8be", "c8d733b428ceaa73567f88305dbb2e1b", "14cd3ed54c43adf204fdbff9ff6f2cc2")
pf.list1 <- taxadfpf %>% filter(OTU %in% pf.otus1)

#s <- summary(pf_gpf_mix_Kurosol10factorsDloss, taxadfpf, factor=2)
#pf.otus2 <- s$species.list[[1]]
pf.otus2 <- c("5ddf1b529d459dfe19ce54177585ffce", "a8d9d70cd3c7980f14f3040f601aca87", "c345b0731eb6c74adba28bea8dd32b55", "95ff523ceb726ac494a9c103673699fa", "89d0504a6a08666616f3e754d4ba27dd", "449ef06487ae4b90a81689ad39599421", "e54913821c1063477298c3d31a1788e1", "3185c326b7772d3219c2e3d8ac6e2980", "115853ae362603c1dff568d7b527326f", "bb2bc36b6f4585ce4c55a7db45e728c3", "20b8f0cab122c89cec080d922b9d6dfb", "9b9fe5825488ce94c5c9ff2b8ad24666", "8b09259fd36a75bb5ceaa0438eb0aece", "df7067a5ff09d53b89a9ab2e8bba84c7", "ee22f3905326e2bb8b8b6b051caf4c8b", "68a415975541cc38e4ac1e436c7c2804", "bf32d6987fcff7e68a6eac74d38cdd1a", "aba4ca428dffeee87b284c7246c62cc4", "f8167ab050d2c358ffb3396b84e84972", "eccaed506fe45eb1a28acef651a58312", "28618eacca5bd8c553f4a4a4b3c82d73", "8c3567b97df73b16e59849aabdd6d8fb", "c65fcca0047a98ed6e7d29ca539145df", "c973e687a7befb9ba59a4245c59fe1ef", "e335f74033bc634af43ee6baa84fa247", "d241d6109cf25ac144ba599a1f42250b", "00b40c3daf546070efc4866bd5301b14", "5547a07702b4018c260d3e7afd0401ad", "3cd41e80d2af05390f06f43a6f45a0d6", "8f0fb68673a8b3c26f3fd210e29b7916", "82a260faafef55efd1b8176ecb781ecf", "cc03d62983df544cb020c242efc47b49", "161dc394f3b786b397aba9ae7844ce48", "c62f3d2a2cf7024d7d6f5eb9661051b7", "26bd732f73005e8b7453ffb0dc361274", "858603b5b6c7332924623a52faa10212", "7e82f96f26cbf00eccdf6fd9c66fecc5", "e9ec6848fecbc33744c2ac8dd9043716", "18c95fb5b9dbfd87d20f1dcdc8488cba", "de0130b6f676a0a43f61a651102bad3d", "8c1551e60b9316e2142225cbac302639", "e50ebd040d11a8b99803a803d02bc445", "6626f9c2e3859382d416f81cb71595bb", "081031aaf6bdc4d9be62ba995ecf2df0")
pf.list2 <- taxadfpf %>% filter(OTU %in% pf.otus2)  %>% filter(Phylum == " p__Firmicutes")

#s <- summary(pf_gpf_mix_Kurosol10factorsDloss, taxadfpf, factor=3)
#pf.otus3 <- s$species.list[[1]]
pf.otus3 <- c("47d7dc383ccfd52f4c8df83b3374f560", "a8550770fff1fcf623a35cae2c98501f", "46fecc3edfcef852e8d2041233d6c01a", "73b562e3dc8fed1c357b0b217683955e", "4dbfac465a3c6dfc88347d5476b310a9", "1f0310c46a263d377697d616cb75e1ca", "98d80f77cb53b487ef191153592cd83a", "20a7bbfb651729f19b8fe812920d2b63", "cad1370803f52804cc72719431b62a39", "ed40a833cc3a774e0928fca39ec0ae6e", "c0109362d8122af7ac60c7d7ffb381dc", "6fd54f7b91b29ba462c7e32149a05b3b", "6d21ddaf67273d0affb077e2f28939d1", "7390ee520df787315776a3a5135fd8b1", "7d1e8a93eee5a48747aebbc674fe0a83", "33ebf2c4c7abebb209c6206d361dcc12", "461491cf7df2f47ea953575ff3d3a907", "145dc6c11fc1fdd2fcc7f7faf752c071", "2297089420e0dd89adaf674cbedc9e29", "9d106d518be52183901285260f860636", "60d36801acbb99378e1cf411735c6d75", "2ed2a4952e113369ef17e15cd4e3dcf3", "35f23ca925e88b47f5d3ec9f1c689432", "2bfe34a2e0671db75c6931f067cac8a3", "3a54d4e72af90b9c2fd50d7d1bb0336b", "65378d6ae212a29cec4ad66af64ffc93", "07dbbd807a7d3516091361cf41dc4352", "caa7b297eced442bcfb1fc53ce34f892", "615d643a35dafca756da7452502ece1a", "3048d4495220e3f17bbda0ae111028e7", "84162050f70da817d35e41f0cc56ed4d", "260150b550b9a32cf978f5f35fcd7fc2", "653e681f224b494b4f2c1b48e6a67ec5", "349908812769e7007d9ea2f862515a65", "14f9da4a1a2c94f184e1432177b7915e", "5d6311ba6ea17efd55c635c5b2083785", "7865b8cfb47bab238f259c642e584f92", "12dd8c8b64b2df22369472badd68a4fb", "178d9842b3737606e60aaac4d44a5a77", "4a56cc868f07ebd09e10d845e128b47f", "f0f7cf633b6961ee9bd5b703b6217eaf", "19e3b88f4d45f6dbb17aecbc02130b99", "d1b91928d8ce732e40e5e8f93f65697d", "21a0412a444cedcf4b7f42bbbc5ca701", "d619ecfb9a3c486817c9d2ad54708066", "9283c7fcf595c5a15d33919d657cc638", "80012c24fd3a4c399825236c0ebb7ab5", "15fb2aeb2f0c1e73efe4abbda23067ba", "1342917b2615f413518bb866b8abaa7d", "163076c2d7e10152bb3d0e2f4b28df75", "5df3c6a24bc4d4b4decf3b795a3dfa7d", "8ef70315873216d86cba28c975f2fb98", "05cc7bd092ff1d7a7340408244768494", "b7ac0bc559a12538548ef7ce2f485586", "3e0849fce8ca14b26ea9712b15b77375", "c43a7bccd7137cd970c4c48aec07c05c", "6eb2886281282d90abb2f2c0fadf83c6", "d35c40f5f91618d28959738fc966ba3a", "285a94ca8bff8375aa5a8e782e18a112", "6d499832735c90f679b055f545829977", "e0fada5fd884e14bf866c99a1f6805b6", "c4def24d4e9cea12f3f0a8a0ca43afda", "d017c08a86b77d93441e37b6d6707218", "2c5b68e70ee7bba06a8e39823d788277", "cfb07959a1cadbe4cfbbaa991e1f43dc", "7f625400e357bbd3023e39ec8583b464", "9341b8bdaf26236af77e6e025b883bc2", "395c21f4c5fa51be1d56f7dcb4b85f3a", "60b6c50b7fd0967e90e1f1a92d63fcf4", "c7c40b0f480f3edee216585ec048011d", "1935b9726fc8e67ef0b72ec5208097ce", "ce6dbec6348b779290f7a72f3512b4c2", "b5509b1c77f95aaafdb48c603dae4b02", "f3a5ae0536b2dbb121495fb4467de53a", "ad7139df8222e23682bac217ebcdb8ac", "2929ef6bd4f4f68c6809dd899d6dca7e", "371c9f9bbb6a63cbb3b4c4b316d85056", "37c2a27940c57ba9871b734f57e1b51e", "9d2c7e547a61784a327ee16d604583e4", "95d3a29ba30d468e191284b7403d4563", "f176b480e226999dae41925009f09fa3", "f8810aeb3e8df892657b0686a204e0fd", "1c291d1bef6103f57f0b7fbf4bb9ece7", "72f9e9afcc03ad4daa440ceae7b26211", "9ab31c9eaf9842ad0d65c524a57933dc", "7f690a3bf1568a579303d3e7c4b6c7b9", "7789a99e360388313085539ee5765e33", "047f2ccc4375cf7bd5aee60dd4bd5d75", "17487e45339a26cb73bac87b5bc33d1f", "fe0ee07c8a03dcc118f7d3ceb7ae8f47", "4d1db4837d84ba18c8258db07b824923", "8687cc49cdac1adda44effe1e7a18e13", "9bd27563a32c9a898cbedc3c626f2f41", "7ddb617321622a7b4a25b4c840b679e5", "485c749e5b8a7469fb9b634f6205865b", "68a7d89446d8e68464bd0ba7d6b84d5f", "a8a9fc697b23198b78c80d04fb99c99a", "289992b3e3a25deb59d0bd7ebf44b237", "d70c6bbb78496e3471f9ea4015e39795", "aa65318f0500b048ecb4de66286d06b7", "62903f2744d8e4b22bf69ae1859b90de", "83c1d94509ea8f01b8c2096ebfe4cc82", "1e369974f3404e4c9c1881fcb5e93629", "e7e48d453f6e828dd21b976cafb4c070", "61deeae909d4265a8f564935033241b2", "2eda2e9da69274745be6fa6121d49cdf", "d988f7f6e8393c170990e6ca2f2bf42c", "02b0b89ab1b53f85cbdd5165c181a7c2", "0381a6df7b683bef751301cbd7b98827", "0a982a31dd66a4c972a8dccb143a132a", "e2f70c4068224dbf44dda69f3f0f2666", "fb02b2e4a964734e916fba014c935c93", "bfa47912543eb8bf66baa63dcc994755", "8ba70a8dab6f6174cd1a3af37ad251ff", "3c28b15405ef7cdaa083a4cc6987d0ae", "b3950c3c190149777ff628625ac4d6d2", "98c5ddeac2912b69d39054fa750c25db", "410aac80975bbc739a4a360c29ad9f60", "a816754e186cd12adb656e3eb19670e3", "c2728516d6804dfe5e6afb79582f7d31", "120eba657e42a11a5c29f97b90f02035", "57830e5be12e987d05b95d88a99f1b12", "a4d0c75ed2fb0119581ecde7127d35c3", "0dbf3aec3a34b218a94919344c9110ad", "afab652223907a261807ec755bf2d0c5", "2e55ec639999a5f78b2ad9c1a83cb5e3", "e4cf87f4a8916131be5147cb8aea6227", "857127c611ccdd3dd80440af8e027ccf", "12e2bb64d262590c8c32d2b090882e42", "7f7eeebabad4374ab1366337f7e4063d", "d90581f2ec69e041afdc4a85e6e2e019", "25bee06e9f26ee749b6bd48ef93b6a8e", "889f1bc31887efea2354ba099342a203", "3bed507c2cb7458e3bd9b0ee3692fecb", "f9721c7e46f9c0e47fdd0a605b0def58", "24d55b003b1abc84e15ab4534be999de", "dfd42bc974d222dd5ad90c5cb821ea9f", "7280c84ede9ad2567c04914e8832d719", "26b4b526e1e97e0a1322abc26264cfea", "db52e1be4ef9e236bbbb0f32d952ca1e", "b8c4ed03d7d91546b9f6ad80b80135a3", "66db13fd736eff683066e4f1c3bb7068", "d3230d8cb50a36a9b678382b8d256b04", "101982ee6204355a54d11d127824a796", "aef33a1267fec79905cf8f2d0eb78e4a", "0cec1c5bb0cda4e9664aa34cb4403d96", "e7b2dea799ec7d376d2a8c7e20ef6dc3", "595d49421ec4827d0ec22b1e5890c4c9", "eb28b1a40981d38e6a0aab251174dae1", "6c985b74c53c123c4cc19938a3f4d074", "dbdf2bcf79be268ab72bcaebeb27b4c3", "94210859de228a4d2fdfc7db06096608", "7ff346973a282aa55de296afdb5d74af", "5b41766efceecce581e4148788f37846", "9b4be26e7bb3a23d25e080a3bba619f6", "bcc6da5f621cbdfc1f0c9becbac6cdff", "bdbdb4a39e3433bcdab5de2db131d9d6", "af9853ec545f456df6343210748eabe6", "4922eb95c3994f40d0784f2cfbf7ede5", "875dc0da5f66b1b5644788543a07544f", "efe02f94259793ac14b19101d99f83b7", "453cf07d3e96e304f23fbde7b355fe70", "f6d4f12f5952bf76014386202c1f6574", "7c9260cb39c10fef45b09ad77d5adb8f", "6c304c2e67bd20752506d156aaff7530", "d892d40bc79d0c356bd2886ce8d120ee", "0278639f012e21f07140177e64a3cd7c", "44c2295d0af606917cf7eace3e7e7441", "a7da93a9744a7863292bcf97d47b6a10", "93a299b4f0a27d63080dedea3a7d049d", "225671ed33a06c9e372cb09428c37ff1", "f527af6b382d2df2e1ba7a1abec8e04e", "b17a2f19f4c913ea1af58c2cf5b3abbe", "27fa10fa9d28d303d1d3b695f24e9076", "7bf78221e41aba341193c6f004811ccd", "58e1986d6ed9177ec034b5f415b6d51d", "5af4ee4046d4f95f881bf89d99abe432", "ea50ab99242e77fd8d897c2c43449f84", "3b38999bdbf762d48005d1e4f7a5de40", "435fd033e4772ad97cecd035c9aceba5", "8cb4ccd83cb9625c4d095d86751ca598", "74a26e97b02fcab82b0d346de4920f75", "b17d556c8987b5826efe6369ec757ae6", "af6dd6d5fa8cecb850bafe9eb10f5de5", "bca92bacb095b7b7038fa9db51eecb3a", "956290465e6b3f3c2559cfd56d7a4536", "2e62f39d6a7c47247244e3d243283855", "cff60bed359051dd65fe850fd0bd07e1", "ee68bd141d0efc556ef3599d9d58b13f", "dc25688e851516d309fd96a7c99fbd3e", "549eaf62d30be324c460979871cae405", "70742388b793fe05ea7ca716a8ee7f4d", "1a8064b2892a4e826de2fa1be6c72282", "084d48e1ad0e24dd051956000a9c9868", "db33f340c7381bf8a96d6556ae78e669", "5159c4aeac82d0e9f127eeed70c00897", "fe170a37c40648f3cd117b40946280fc", "e1bff1e92e335118fa84309d5b489759", "0ee75360a42819b650232dd28425849c", "19c0764f72978daf1802f53eb836d3ee", "916b76917fe917b2c2fbb0946e866734", "5466b3856ae57ada02118bdfd2263957", "b23e5e01ae73bece5480fdd1c0d4429a", "64c36c9eba141cc15ef72464407c09d7", "f754b1a0b919457a55f67bb23df3836e", "5e870796a4ae6f9eeca4d5da33425985", "0435511639a585c9bd711a606b0a5cb8", "995dbe5af52cdc52f805bbe796ec6277", "1644bac83434fbff42aee3b9328d91b0", "93b487e7f52d6775d6e11bd03884e55f", "7df872e2df311782400a19bbb5688bd6", "fcd80f0cf279eff3c50b66a78d98beeb", "97716c2d9a13f6461607f86c7742e48f", "668db00250908b84ac960ca6e4af76c4", "42157b0c82513d9c13f29b75a1b79612", "2f81b394ff0c14ed70c1c7511e60666e", "7ce227c0eb2c227bd2c489d64e140a8c", "39635132fddd5dcab4f1ae60151c286a", "2a39f0b75d31d00b3136b2edbe82962e", "bf65f5b650980048e374167ba9104f1b", "aaaa0571a2364056ef10bac816f66b06", "39c47f3d76baee36a286c74330d36b6f", "ba5e71a6657f3220ac4faa3b079c9ba7", "53e00b8a5b24686587f7eefd169074b3", "d95952e95e9eed3bd8972d84c80bfb26", "886cb574c709969a1046d567703a292e", "cc60312357314937af544b9333c06feb", "7a3a2cc68e767dd8ec93bb44f935a3fa", "71b158f33f6e5593f0d08f95907f45b8", "51cfe7da16a41b6edc6103997dc3ed64", "0645be7998c6aa77cdeec8befd9428c9", "35d20da789dde8d76e4389fd6d30cc9d", "a87b7e02daaa828c6dc11fbcba68b61c", "6c453b63639d6690d92398db921a2cb9", "3b5434192d56f4d413fbb780c177a8fb", "5d9180880af9854c6372832cdeb3d320", "7c0e08a6c157cd08fae06d44f58927e8", "d9e5f3cd149edbf0a00b2e6682c9198e", "a29a7b752dc92ee0b624dc42ae3940ac", "18182eae32424d7287051cc6cc3e9a9a", "87f7dd1dd0dae67a29196521c5d0cf94", "03fd1e4bb2c31d364b57a4ae059b4513", "16bcf61bb4358fd60fdbfd40e5414d65", "ca1a227ac5c68101cfa7240d6a3e8264", "1706d5bce341d7bdcc3bf7f0829a28e2", "2d9f50c27a2afea9ff78b7d0a0bdfc5e", "6b5fd8c1dfb75856fc5fcf8e005dab9b", "0b159a7df415aa58b5b151e50b633b73", "e3edad3597c2a2972305ce44c54c6668", "cf64d5f5f2af5b65fc8c6f3f2f45613f", "32a4daa2b4524743a79a090e3481f451", "54287ac1661d418a85f47e6917a3a1c5", "ecb9c44ebcd643c85759d200ac897938", "655c4e26812b8a7e6fdf8d39bacae072", "11118d0ef7f7b766ff3e3512a38996fb", "7880e3ecae745501db60342adc312d6d", "8218f9e60bb78cefabf99ff94525a3fb", "1c0a3725f25027e98ff6aea763fbb4d2", "b9bc2762d1e85ec8666bbfe9983254fe", "5fa05c77cf6d6af3ba6540c482ea1210", "3897547f390856761676eb05c2112d64", "80173d92470805fcc91904c0690775e9", "8fddd1adc40af61f2cc83f55d7672718", "e79674f72e97101da48162b868097efb", "d4b9bf333f77ada53b29eb52267ff4d1", "7ecec3b254f495be476f5319f9089c79", "b3fe77bd4d27e30779be9b5fbdcd84bd", "fc4d567d1d0828e1fdc36916f0d53d15", "525a9c0735fca04fa60bfe1c478c34c3", "572b96fefec73aa11fc6628597853ed7", "e8ccf9dcc883d1d3cef7bb69235bfdda", "d42f426a26e68b57cf748d00b74e91cc", "1dd424fb216e9e26ef5ac44539c49666", "4061b28878bd89cd9be90bc34313197e", "f871ad6969eaec7c83554d951260d49b", "512363e25502450663c97faf494bbef8", "90c9ab785a5a9756f23fa6f12d2af33a", "f8e966fd6a44aecf3991a7dd167fca57", "32ecb6f6dab80358c09c1ca3271d42f5", "6e0c277dda36291c48b724da6edc7297", "fe07121590990da9ae93cf25bab75c24", "9a3ba86c5593a9698b414749847973c1", "8a6431bb8aa6282533385965b048380a", "d3ac14e193d870746f08f2e205a904d2", "f0f78b43f98e5a1ef6c88bba3f1cfd9d", "58a737429655104c69ab1a500332e9bb", "701da47a92f65f64945ec79cd0072b36", "bc90812855f63cf160933a30b91e2c2b", "6facd4d5be71a00342dc0ec368e5f797", "0903befdaca784d168779ae069d383e2", "fd3ea30106ce56cccb2cf62abd5649cc", "c31e610bf4ff9ae457cda7eff957848c", "4b830e302e5777a049cd6a92d0cb93d1", "6c85039a40caae325fdc2e27e24fbe38", "373a977997ea4c45439ca2f3ab99c354", "09cbbb4209431da3b43e9c0011538488", "2b7a78605ba04395e4fc7b93d0c6153b", "452b5ca26484303e7c4f476b7a49e6db", "ef80c03af75a7a4d9616cedf24999c26", "0800e87c60880878ae03e5d9bed6c3ae", "05de42b6fe4358bb0722769756b9ee16", "9d3ece8e55c96872bfa3c988609a7e0c", "61ccfed0cba1de69b0ee0b08f957e52f", "0b1d7b58e9e29dc178603b3377b5282e", "7604395b6d7124ea37b90f95996b62af", "e77e56eed9d0b5099a1a9512f3617591", "212f4f641d045f595bd563c17c755d25", "b4304b9875bbacce972515a3732e95e3", "ee6db47c50b8801e91ca422483843e86", "749bdfd49d5482e24016ed5eef1cd9e2", "0cfcfdad40d45940cc335baae298f406", "527a034e0467ac58568b6aca73a7aacd", "f8ecf9e0686f47a1f27485655e885265", "0942485cbc5b777afbba1b4d0e7b22a1", "35c6c32787fb62a51edd4a227190ab21", "12edeeaa6fa8fe857bb3effb1d1ce6a5", "fd961c9e1cbd988f504737057da84c79", "9b4475d25b4b2fc17552121a5a4ff7ea", "1e92f445cd391a546c9b0ff8d50d525a", "5e61953549ce7f1712e09acf257cd735", "bb7fc6ce6a36c31fa5e9cc00dddc72c4", "1077618b1e9b8959a4f4205101434fdc", "0556821be2064d55de4d36e6791889a3", "8f5302500e0704c35b33782743dc34a1", "a2ba4d847ac8834dae3b86cb98f4bafb", "2615c3169a5882072cff5ec7d35d0eb1", "31007730baa70d749fa552104d14c408", "b6bc20bb59d886062d9bc50117471041", "fc54ee2f4202a56b734a886e87aeaeec", "f310f85488de561487552ce337c75a46", "8ea2e3c4dd1518d8f78a16d8a7a08071", "6c5c80f2bae6fbb63b58016c6acf16cb", "60bf3014a98a7aa1672ddf5abb14f8d0", "8f34495997ad5939f50140851e10a21a", "8c7333785c789ce94d103c0f56d1b79d", "a3b7b867cce0dce4abd46b1beee56799", "804b0287cd9b127e24e76cef0a49801e", "cb1fc617676485ba261ff932ff5cbb32", "9dbf505399b5b9c5378a8180dc87e7dc", "d8f5f8ae874388510e15158ca2c202b2", "f2ab406d7b97bee8eda6dec7e35c0026", "f5a7ac58df99234556bae311b2749b72", "a47870a1f4fe1dabf25a4926b1f6e2ec", "1975f0f2b6531e29f1c84e99f1b51ef8", "6d830eb09572ff090b8f56a902a7a7c9", "8c8c7713e00e457f0d2e75674a77bdbd", "dae81946136e5ff59492bb6e43c803ae", "50dcb728c67166ba82dcfc503a9eae8a", "233f74db7a5fd1446f2c0eb224121e80", "bed9383d567006dcde20251349808016", "619b70cca49db6867c9fc0c0f9bdae2f", "7ffeca597d6944bc2ce127831c942786", "de7adc9d2a7affe70dc71db090536ab7", "e8a10c963300811f6263d38decbf3e44", "d887d7d2fad39b026b871d751ab8dd6f", "ae727b8ffadd52f91920c1bd93c73035", "c4272a1c4fc3df3033ffd5e71a787ec6", "8cc6479ecbe45c24701c7e4ca741bb0a", "0717f64b1acc58505c85e9958d2fddcc", "037fa556f40d2933afd17ab9305022ec", "8eb6132e2a35ac36eb9ba852bb10ec6e", "21e1eb034bae9cdb38a39fbc53ada64b", "20442f59b9097b0c924bbbaf871014cc", "a51af6f7d3369f355257160b33da3cff", "9854f77fda179fb2bcb329bcc1476afc", "ca4283eb765c661054735b529ff8bda0", "3784b88b479ae425f4d9074d67c6d000", "68c56896f754db932a51a88ebad5bc6a", "b8f4b792a7569c5f07c33e036d449dc4", "40fe1d46fd880457e79f55916db36cdb", "6c33785c46c3fef68941d9addceaf948", "50fb93dad525b440dc193bc631872eba", "cd74dff9536eba82bac8c6d71a8eea45", "048b262ba1724685477d2fe19f0fe261", "4004fe18facf483745348a3f301f44c5", "6ee21b96cc19c3c2492c5d85401e7056", "d0ae1ef03cfbb31cff15224f63481f38", "4f942911cd36301547e4989a4fa0256a", "e9925ddf0f2fa8e613431309665887cd", "9cc237727e3a014e57d2ea87c27c0a71", "34a0b8183d81e2e0c97e7172e21fa001", "13e8fcfaf49430ef8b38ec77ae44ae56", "b8652132753aeb381794c3f8eef30132", "1ddf107cade31427779ef3e27fdd5509", "449e9aea10b13a4768a34f9ca2789272", "f1cbd59dc1ad9fd54bdc7c3c75ba28e9", "6b4f8e26c98c54b2e764dc07f58e6920", "e4498ed89ef8112715d1c26a160a013f", "c7730b483e5a9b4111139103248601f3", "1fdca9e3d3a113642d2aa0539bab8d1c", "82dfb759f8bebd89d69492cb8edaa16a", "6fb47f54b46ab0ba081da1a9db371e23", "30cc97f8612e753f1d413b0a8b0dccee", "b48a188a24ed126894db7d73bd6617cc", "a14e6fb98dfdb0c8bb6403538c4feaae", "d3eb884fcb74b91d9d18da117f2b26de", "c41352ec9dd9bd9cf859fa5a9092010f", "b77f959ead75ef6ce090abfc83fbae4a", "30bad02560941827a722720c6c3b2859", "545fa0468d02d2352ef9299ee7be672c", "a55990b64a885b064a75c159d4086dd9", "0c4b1917e29117cdab7e6e4ed274d517", "0fa81c435d101860ccd8eabc60819afc", "0f212dc35d89f613fd3a0ba4e842d0fe", "b53612074f9d8b6727c3fe08650f31b9", "f3ab46eb643f9fd49253881533af6c9c", "9094f39bc33a26e3c004e464482fdec1", "493663cf346beea69c1e92f38266b0ea", "b389980947a2056ef179d48a2b8c0ac9", "f4a8aff56ada61ec5fcd8223b4bdc289", "7fe5c10c4b8476b4c9bf4b979c497a3f", "a75b8b7a25390763ec9a75f71e384834", "349835c24847ea6874ccbc4e5f9b2e03", "3b670a23ac9f2700b32fa5e42fbb93e9", "e84e1abc1f4520d5271f46bce5620be3", "1712d57186ccaeae1ef8d9af84b94d81", "6a767ad602e8751369cc0ef1402a03cd", "3cf7cf277daac885d04fc0371aecd9d1", "7de7f8dad384f30b92b817c97f167a20", "9b88153beff9b818b131a44f0d7e01eb", "99d60d151d66b662a78406dfab5fe1b6", "80578c9061f6f4c671c8cfe20ca00cc1", "e1421633678325bd8fb2e7140865921b", "506f77350a89ec1d8b87deb44afb8068", "1b81c2882d136c97dd642176ad58da7a", "a15e27542c2a4360d425d67efd91b91a", "97a7fce8cdd13b1e08878a12b1ece4fd", "fec75ad0243d644f96c60039ac145489", "ac2f06c8daff8192c08455e73507b5c6", "5d97c2826467c49675c276e6eb8ed407", "9cdce1ef15eee5acdb70fb0f9d6af991", "f84afaeb053c48a50ca9ff89752ad5d0", "1e09a9c32ddb08b7c17ec5f97e96c5ae", "29905f1e97fdd23914047be14624d264", "c2fcf84369d7c0b01c1319abca68f357", "10de0eba546c09f457b88d5524e68a2f", "a18c57c9b518b57af3f6e877796dd9ec", "acbd9af25075285c382477086e0e6560", "925e5a29d399ee56af359cb4b99e7cd0", "9ca78c21c596098629bd469639b06119", "83f01ce21031a408f4ba5078928ec128", "ab29a2f6b67a7f0f3e60025ef4e1752d", "494aa8af4c2562dcdd13726a5c5cf76c", "73c71bc7c47b2ceeca8f9864d33e12f8", "56706e878bbf127a79b764d7a1bed9bd", "862971eb63545671fb5d7472a43397af", "8dc5a59a66ace394a584b255c782895b", "293d25f4f3d78ee9bb3ec278d1287b37", "e3d9a80f7426f8c931b45920c15b0dcb", "fc02d45daaf8b1d3a9b0e356f10f4de7", "f6522cce3512344188512b7698249221", "ebd706681db876d3a27e2e31e4c74bdc", "9f1a379ea8b6b9df04d771548c20d37e", "89588c8f7b791f2745dd7dee951c0de8", "be720cdfc6f9b61a4df42bd6b89d424f", "5d39e52740e6c4af88e7b649c600ad79", "52a2cd8cae143aba227e0b63c3824896", "3fc2a2b4b5c8d7c48d8444824d711b8b", "6e918d0bf159b773121abfeccb844145", "735a34530e1dd2ede72d29fc30982807", "86e14dd85367bf944f87fb172a7697ea", "2385181f70524d74f77ef2c22e952f10", "6683e63a84cd77cbdfc095d998eb519f", "4906aae94509b34858054883defc917d", "ebdc2615b61fe628b9ce6252f7465d9d", "5ad73395b821ef906a29c1a6c0c9c5b3", "73423811e40645097420ca56fa82b638", "40798e0e99bc0f77f8d313622dff05d4", "3ff3ba360df8d3d755e8b846c7307423", "89c652bc58330c7523e838ec8975c627", "7546e75a37c0086b0775d5de581bd4c8", "d9875087f8e1729d025b0182f84f1d4f", "c6aa199d6bedab4aa85a309890be172a", "a6fb21b58a7483e49338bc06e4721900", "0d6d4c7642fcda0f4a6e1fc454b50b39", "1a4d7d865a219ff8d59b6cf32811cfe9", "0c09f30ad2b6472225c5bb25c44f8038", "b6e947680030d053d077e212c2f68b13", "1fa4aecbb95f7fee5facfcbe397fb379", "6be01b304ffd87213eb490e18acdcec4", "410e3e240c6ecd1d330041aad1645c61", "9d127ac8ec1a7b03befe92229847b811", "ca92bdf271282ba65ab50c35dd6cad8b", "7997386ba2220d045f0c4c8d2070d451", "8a646c7e71ccdca9acf6838403bfe927", "28637d233b792c45de49cc4c6b3cea8f", "808769f1c8bf563febe6835d5d0b2ad9", "6d2d0089782d95d17414727cdd233a79", "8840b8e5d2c22dcc6b6345890c720a79", "b60da980776eff920fc0e8e4394f7f0d", "a12b6952051e3db9b86a69871f0320fe", "4ca99a10cdab7680132143e0a5bb4ac1", "226387656cbbecd1e0ec701cb96f854a", "f6d110e275879580f221d9e52a2d0fa2", "1d415637a8c699c4e38ac37a4a3cecd8", "8b22648cc665d7d807f66c17c50c0a2d", "cb80be4ac2def4c41b4338fe839038be", "2ad1d8060211283d4fe5f42d13b38dff", "8c767535f6a3bc003d4d39de24fc0639", "817725950d1e7e63b3d8d62ea796d24e", "fa114591ef7c62a2b0587e4222c183e6", "372e046694421d59e383fb3e99f7db2d", "c3f493cf4b5e966fdba990b0663c9efb", "9172b9fba100663e14d586b09278122c", "1d4ad093916c8ad38d3d4f5c171045ed", "4661b16d8f7889c9ed43dc8a6d273113", "a2c180bef96af0003a554e8ed56aa90b", "a2fa64eb258002a8282b83b5bda61f85", "32e35cc8a10dc12bb73acf0c612784a8", "a767ef0731668fa4127e737312962d4b", "6ca4558d86bb3870baa3984e8798cf8d", "876e399b617588621a102613a90e17ea", "9cff2f4656ee7086baf5c4bf113f36c9", "07491cb8d9c59452c9f37f33f3971883", "faa8cf6b147e0eedf68c8f4621e326ef", "c0bed8d87ea9837ca55eb90515920054", "5ec68dc0a7530a7d6a4bde31be6e45ec", "81ab64fc4dbb5f0726916f70a83a225f", "9ae326cda0c7be2d14b592ddc9c056fb", "a88d3cea93a71b09ba3f353671f5651e", "2c630111255d2dfc7d7fb60a95db9cd8", "f74a23038095f558d209d451c03c9b7e", "c938c4ceac4c09d1270d8be976a6ccde", "99d6e0f1bc5339630906f04aff5817c1", "970c8f87acc7bcc89b2f6dee934a355c", "ec45f93d921a1fedd423af619069b295", "c1088372397e839874f8fa6aef9ea1fc", "08b58e5bc0ac453d01bc015207ec1d9d", "71fdd57fd409d130c028b79a4658d52d", "0422647ef6eff7c6bb336bf4e2a4f695", "752a698aaed087f7454b737773a5a395", "9287e86e0083e5f9a299d7edb6dba9a9", "7aad72deec0f9fcdb8e22b1c95a9c9d1", "442a58d6759aed21cb8a8787ff6f2fb1", "e5ca3227c5826ace939e7f3455b8e676", "3cf7ac567d3e9cc9bb134a8ad6f7aea9", "75f6885c6d315b0c673490851b142381", "3ac7aa1ed7b363df4d599cdec7e02790", "1dea32b097ae513191118a21b453abc6", "bfd357f356ee840f71cc8ad1b3a24077", "eccd4ec473687cb840159f8d4036ca15", "992264d4b385a138704065b4fd30693a", "82a97987ae06230f2baa86c3e6a944cc", "788ba0be6a018f46ec3672a4ff545cf1", "0fb2b0be41d80d3273795b15f6cf9a79", "b86c762bd0cae2776073bd1d89b9d016", "6f8d677ff5906b103cf327e3ebf770d4", "36d5b11cbf757e4cf78cb3aaabee0973", "584afd94877f5a843754ef60eb0f3d8e", "7f40e20d5130fdcac48b8bf1cb6be985", "10f872bc3e780f506b2375ef562c2d03", "e92b9f1dc385fd1253ae32feb4a4758d", "6727bb2c91a7a6b0489e814af3bb9cbc", "01fc9e801582d9ed412677d2a85e5190", "f179023b9983476c2848d385886b9940", "8b6d329370fc378b460362f38126fde0", "ae433d02fb66bf798adb50321abdbecb", "5fafdfebee94c707ffd8c2edfc4a26e2", "d594219c7e58b9213a2cfe8f076d557f", "c309aef7b6abaa62cc4b81130261d724", "8100d2962cb4532282d053c8239a2da1", "fcd5e9883d687addc9384b071e8b5da1", "ab82627e3e67b1b80c7154ca2b462940", "2d30894e63ea50593524f82c639c665f", "34db7453e20dd3c340542b97cec8b306", "b32c31cdf2e8499f2dcf74dc1dca50df", "a7e8c2058587b1a2bb353abcdeb3574d", "ad744414d1f7bc63a6307fd399fffdc5", "8206db4b8b8bbd572d04ab96cb720f52", "f0209b011ea3d144789d7bfed5baf58a", "beef6c71f8ac5750d2f297519a38364c", "d98297e8bf1f8d019e868c17639f621d", "697a7ee3b337e8d62bb1f7a16cd02700", "1792a58617f48c817ae56ac89d5c17b9", "00030dba364df8c7c5a7659e605c1597", "14a8276f9ad71a2f1faa7a74d90abacf", "34dad192b776e361809cc560b3ec543c", "93076cc0def279709eb6bf1dec583223", "ee20187e2b6c9f0c71ead1f15ee86187", "ca373a4791ebf956b0016d1241bcfc6a", "1a0f9c983a25c608d11acac096f52dd7", "6bdbd7db1942d234aa16f82567ff21bc", "ce2de9f6b5ce0e7c3431ae78037ba327", "b5be660f49ceae47a6e19f40b5b8701b", "1da4a0ec5bb136570a9fc52d503b55b0", "164b4b1b6d1a6c2e218b9e067048c729", "854080deaa8d5312c3c9640817c8e55d", "e9cd0cf93cd22e2caab41996f312888f", "937210de243a043bd9f99727394d3ce3")
pf.list3 <- taxadfpf %>% filter(OTU %in% pf.otus3)

#s <- summary(pf_gpf_mix_Kurosol10factorsDloss, taxadfpf, factor=4)
#pf.otus4 <- s$species.list[[1]]
#pf.list4 <- taxadfpf %>% filter(OTU %in% pf.otus4)
pf.otus4 <- c("358441dbfb2b4f0501d02e2abd15b897", "bed41edee98c558ca706dba424650bc2", "ef15c7f5d470031babed578766b6ac8a", "e88db068f2878a6f240d2900a69ef30a", "2c89ec929fb40576d230b94528fea531", "a178226adeb61937e5663ab13ecb57a5", "e2a35867731fb073463f823bb3f063d2", "056506831842ffb7833d7e2322104476", "54311577cdb92cb7c122ad2aed3f84b2", "ad8ba027253669137be3ba7f000b7104", "c32f0d0de1108bf5680348e909460149", "8ebfdf9021d59861294cb4ae7646bcd6", "5a9d266eef2b61b3ae44cc4e943ff270", "afbe37728a2be9af9b7d20093495ee35", "68a30390c8b32234e8b5807a39fbd507", "d7aa0ab571f8947d3cf2f2dfea9196b6", "2a6a51b8fbc08281eff3acadf1b48826", "f361563edffa4ed6ba4323812ab7d8a0", "dff0025a13f34f236ee63d5b21114616", "36bc3f60ab46488d36d6fe76081e9b0b", "52a530354718d199a57ac959a7109782", "d469ae4fba1540265aeb97e55034248b", "c2c03088d38918a020912b6b2852a084", "90cae6bcc608562a4fc411f3ebd47e65")
pf.list4 <- taxadfpf %>% filter(OTU %in% pf.otus4)

#s <- summary(pf_gpf_mix_Kurosol10factorsDloss, taxadfpf, factor=5)
#pf.otus5 <- s$species.list[[1]]
pf.otus5 <- c("c59d5f191c2dbba4a6374a05a495ce46", "072d9131812cd222ac93161f2b692a40", "d3d9c3d9c7a18a09654ebca556d0b670", "3e823ae79fbe71b4454d36ac4e66115a", "5ba5672ee7106fc71aeeee5bbec347fa", "46a600b56ca3d2b3b4bf220dfdbaf3d0", "d1eb65053ebe9d75e1f95f492ddf5296", "4e4b529118ac55e8b7126c884489036f", "193d2682d8dfbedcd57dd91b114a4b22", "53f8766d19b208dd0acb79a17b1405f5", "a07cbd5e6446949db9e540d55ab4ad36", "f5d29f959d3ed64ff26825d02cf989de", "e7e1ee152e23f9493040fca32897300c", "f7d41b9b17bb0b52ed44e291e07a1368", "a18e3f041a1bbbc222a9e118c28d678e", "9de69da6948781d78ddd94b648b616ba", "60f7edeb50b6638704de4382b0b52ab0", "d44f86d1b528e9a16754deaa60f70d1c", "ffe6730810121d8c089417793e0f3ad4", "83dbe4c7dba1f142bc89ec11aa7a0d25", "3b5457e06aa339fe4d60ce7e3e40b433", "6642f823c5b43386617ee633cb19a3d1", "bd689359864d95f42d2b3d11152ba27e", "7e1a6a91cd83e035e35331dff8248b82", "f8091be82c58a71ffe220c30e6c5eb45", "3a5a12eed60717fa194a68657fcc5c5d", "e1ce903808bf8ef598176107d3947a20")
pf.list5 <- taxadfpf %>% filter(OTU %in% pf.otus5)

pf.list <- rbind(pf.list1, pf.list2, pf.list3, pf.list4, pf.list5)

#for mean differences by dieldrin loss in each soil, pa and abundances for comparison
my_comparisons <- list( c("<=43%", ">43%"), c("<72%", ">=72%") )
p1 <- physeqB.melt.pa  %>% filter(OTU %in% pf.list$OTU) %>% filter(Abundance > 0) %>% group_by(Phylum, Class, Order,Sample,Soil, Dloss_fct2, Abundance)  %>% summarise(ASVs = sum(Abundance)) %>% 
ggbarplot(., x = "Dloss_fct2", y = "ASVs", facet.by = "Phylum", fill = "Order", ylab = "Number of ASVs", xlab = "Dieldrin loss", width = 0.5, scales = "free", ncol = 1, legend = "right") 


p2 <- physeqB.melt.comp  %>% filter(OTU %in% pf.list$OTU) %>% filter(Abundance > 0)  %>% 
ggboxplot(., x = "Dloss_fct2", y = "Abundance", facet.by = "Phylum", fill = "Soil", ylab = "Relative abundances", xlab = "Dieldrin loss", scales = "free", ncol = 1, legend = "right") + stat_compare_means( method = "kruskal",label = "p.signif") + stat_compare_means(comparisons = my_comparisons)  

ggarrange(p1, p2)
```


#### Phylofactors in Chromosol samples only
```{r pfmixCH, eval=TRUE, include=TRUE, fig.cap = "Result of phylofactor (mixed algorithm) on kurosol (n = 18). Selection of ASVs that had a higher chance to be present in a high loss sample than the remainder of ASVs.", message=FALSE, warning=FALSE,echo=FALSE, fig.width=15, fig.asp = 0.5, cache = TRUE }
require(metagMisc)

physeq.B.flt <- prune_samples(sample_data(physeqB)$Farm != "C", physeqB) 
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) != 0, physeq.B.flt)
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) > 25, physeq.B.flt) #must have at least 11 reads
physeq.B.flt <- subset_taxa(physeq.B.flt, !is.na(Phylum) & !Phylum %in% c("", " p__")) 
physeq.B.flt = phyloseq::subset_taxa(physeq.B.flt, !Phylum %in% c(" p__[Thermi]"," p__FBP"," p__Fusobacteria"," p__MVP-21"," p__OP11"," p__SR1", " p__FCPU426", " p__Euryarchaeota", " p__Lentisphaerae")  )
physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) != 0, physeq.B.flt)
taxadf <- as.data.frame(tax_table(physeq.B.flt)@.Data)
taxadfpf <- taxadf  %>% rownames_to_column("OTU")

#load the phylofactor model object (run beforehand) large file >500MB
#pf_gpf_mix_Chromosol5factorsDloss <- readRDS("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/phylofactorization/2020_0320_pf_gpf_mix_Chromosol_Dloss_alpha0.2" )

#extracting ASV ids from phylofactor object for plotting
#s <- summary(pf_gpf_mix_Chromosol5factorsDloss, taxadfpf, factor=1)
#pf.otus1 <- s$species.list[[1]]
pf.otus1 <- c("3642fe640791878128d438e533b2468b", "6bb5b0fd998444a0b9350e82fe477bf2")
pf.list1 <- taxadfpf %>% filter(OTU %in% pf.otus1)


#s <- summary(pf_gpf_mix_Chromosol5factorsDloss, taxadfpf, factor=2)
#pf.otus2 <- s$species.list[[1]]
pf.otus2 <- c("6d9ae5499cc60ed21dc03ccbe6219b7f", "987869ff61a2f9aa291a016392a0b72d", "6e4b50a611f333bfb12f3b9a4a9e8b61", "83e3a0e4bca3d83683e9f8c817f74e40", "88fb15f05df086348963d416fa3f3077", "40e57dc1b1360d39f529b23f435779b7", "896ca370df8961584843f1f95d9ccfeb", "39db6b75da4732e5101290af4d9c9695", "5c35ddec67b4553780c8a35ebcbc1d38", "0efd2cbf2fa941eae017e610871db1ec", "6627cdb617ff2365d3c4fdff45b18fe5", "057fd715d71a7c861d3de3c1838057af", "c0bcf7e96430d61108868a152d0d7ff0", "54e920999a65a173d3fc598d9df4097f", "717e6182253f059237eb5caacd914ba4", "831a3542182c46cb28137c1b658dfb62", "0622ff99e9372331d72daf50fcd2b31c", "8d2d173519ea87b14b962a604338468c", "2646c4dab73ce671da28bc8479a3450b")
pf.list2 <- taxadfpf %>% filter(OTU %in% pf.otus2)

#s <- summary(pf_gpf_mix_Chromosol5factorsDloss, taxadfpf, factor=3)
#pf.otus3 <- s$species.list[[1]]
pf.otus3 <-  c("735a34530e1dd2ede72d29fc30982807", "6683e63a84cd77cbdfc095d998eb519f", "2e90df0823c6ae9c8dbdb4cb1b13278b", "4906aae94509b34858054883defc917d", "ebdc2615b61fe628b9ce6252f7465d9d", "5ad73395b821ef906a29c1a6c0c9c5b3", "73423811e40645097420ca56fa82b638", "1613297d7039651ed6c9c367ea48ff11")
pf.list3 <- taxadfpf %>% filter(OTU %in% pf.otus3)

#s <- summary(pf_gpf_mix_Chromosol5factorsDloss, taxadfpf, factor=4)
#pf.otus4 <- s$species.list[[1]]
pf.otus4 <- c("a14a490c6cb323860a11c730c485f1f7", "642bd307e39ffe1b22265c1e7a53a760", "384cc1ed47f9717cbaf2e9985e2576dc", "501e9087834537141a581f02974745c3", "45b555b4a8af5ad63bcb0b776e11557f", "bdcea03c7d0ba0978427a0d40661723e", "3634fc139a15c55de5279f83a40cef78", "c631a7272770b4655892948977827814", "1f10163256b06a90de46a58958111b97", "097a52608f05927e7cefc1a9b22fb965", "4a9b466b731e474e1884ab0ca9b3683b", "be8cd51d2a9396ebdec859e56508117d", "e8e39dcf5a299670fed33c4ce6037cbc", "187e410c1dee927dc98406160040845a", "2d16f645c5eba407c1ee76adf2408dcd")
pf.list4 <- taxadfpf %>% filter(OTU %in% pf.otus4)

#s <- summary(pf_gpf_mix_Chromosol5factorsDloss, taxadfpf, factor=5)
#pf.otus5 <- s$species.list[[1]]
pf.otus5 <- c("d0ae1ef03cfbb31cff15224f63481f38", "4f942911cd36301547e4989a4fa0256a")
pf.list5 <- taxadfpf %>% filter(OTU %in% pf.otus5)

pf.list <- rbind(pf.list1, pf.list2, pf.list3, pf.list4, pf.list5)


#for mean differences by dieldrin loss in each soil, pa and abundances for comparison
my_comparisons <- list( c("<=43%", ">43%"), c("<72%", ">=72%") )
p1 <- physeqB.melt.pa  %>% filter(OTU %in% pf.list$OTU) %>% filter(Abundance > 0) %>% group_by(Phylum, Class, Order,Sample,Soil, Dloss_fct2, Abundance)  %>% summarise(ASVs = sum(Abundance)) %>% 
ggbarplot(., x = "Dloss_fct2", y = "ASVs", facet.by = "Phylum", fill = "Order", ylab = "Number of ASVs", xlab = "Dieldrin loss", width = 0.5, scales = "free", ncol = 1, legend = "right") 


p2 <- physeqB.melt.comp  %>% filter(OTU %in% pf.list$OTU) %>% filter(Abundance > 0)  %>% 
ggboxplot(., x = "Dloss_fct2", y = "Abundance", facet.by = "Phylum", fill = "Soil", ylab = "Relative abundances", xlab = "Dieldrin loss", scales = "free", ncol = 1, legend = "right") + stat_compare_means( method = "kruskal",label = "p.signif") + stat_compare_means(comparisons = my_comparisons)  

ggarrange(p1, p2)
```



## Network analysis
```{r glassoallnodes , fig.cap = "", include = FALSE,  message=FALSE, warning=FALSE, echo=FALSE, fig.width=5, fig.asp = 0.8}

## spiec easi "glasso" bacteria
require(SpiecEasi)
library(phyloseq)
#cross domain (and with 4 cores)
#filtering
physeq.B.flt <- prune_samples(sample_data(physeqB)$Farm != "C", physeqB) #take out outlier paddock
physeq.F.flt <- prune_samples(sample_data(physeqF)$Farm != "C", physeqF) #take out outlier paddock

physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) != 0, physeq.B.flt) 
physeq.F.flt <- prune_taxa(taxa_sums(physeq.F.flt) != 0, physeq.F.flt)

physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) > 10, physeq.B.flt) #must have at least x reads
physeq.F.flt <- prune_taxa(taxa_sums(physeq.F.flt) > 10, physeq.F.flt) #must have at least x reads

physeq.B.flt = filter_taxa(physeq.B.flt , function(x) sum(x > 0) > (0.15*length(x)), TRUE) #must be present in x percent of samples
physeq.F.flt = filter_taxa(physeq.F.flt, function(x) sum(x > 0) > (0.25*length(x)), TRUE) #must be present in x percent of samples
physeq.B.flt
min(taxa_sums(physeq.B.flt))
physeq.F.flt
min(taxa_sums(physeq.F.flt))

#running the network analysis with spieceasi
#pargs2 <- list(rep.num=50, seed=10010, ncores=4,thresh = 0.05)
#t2 <- system.time(
#  sse.physeqBF <- spiec.easi(list(physeq.B.flt, physeq.F.flt), method='glasso', nlambda=40,
#                             lambda.min.ratio=1e-2, sel.criterion='stars', pulsar.select=TRUE, pulsar.params = pargs2)
#)
#saveRDS(sse.physeqBF, file = "sse.physeqBF")
#sse.physeqBF <- readRDS("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/R_FieldSurvey16s_M2/sse.physeqBF")
#dtype <- c(rep(1,ntaxa(physeq.B.flt)), rep(2,ntaxa(physeq.F.flt)))
#plot(adj2igraph(getRefit(sse.physeqBF)),vertex.color=dtype+1, vertex.size=9) #quick look
#ig.glasso <- adj2igraph(getRefit(sse.physeqBF), 
#                        vertex.attr= list(name =c(taxa_names(physeq.B.flt), #taxa_names(physeq.F.flt))))
#getStability(sse.physeqBF) #check how far we are from target stability threshold 0.05
#sum(getRefit(sse.physeqBF))/2
require(gephi)
#ephi_write_edges(ig.glasso, "~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/gephi/sse.physeqBF.csv") #write csv to use for gephi

#add edgelabels to file 
#sse.physeqBF_toGephi <- read.csv("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/gephi/sse.physeqBF.csv")
taxaB <- tax_table(physeq.B.flt)@.Data %>% data.frame() %>% rownames_to_column("Target")
taxaF <- tax_table(physeq.F.flt)@.Data %>% data.frame() %>% rownames_to_column("Target")
taxaBF <- rbind(taxaB, taxaF) %>% dplyr::select(Target, Kingdom, Phylum)
#sse.physeqBF_toGephi_edgelabels <- sse.physeqBF_toGephi %>% left_join(taxaBF) 
#write.csv(sse.physeqBF_toGephi_edgelabels , "~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/gephi/sse.physeqBF_toGephi_edgelabels .csv", row.names = FALSE)

#node vectors
#create a list that defines an ASV as unique in each soil or present in both
#exported nodes from gephi , relabel here and reimport to gephi
nodes <- read.csv("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/gephi/nodes_download.csv") 

 #minimum presense
physeqB.uniqueK <- prune_samples(sample_data(physeq.B.flt)$Soil == "Chromosol", physeq.B.flt)
physeqB.uniqueK <- prune_taxa(taxa_sums(physeqB.uniqueK) == 0, physeqB.uniqueK)
physeqB.uniqueC <- prune_samples(sample_data(physeq.B.flt)$Soil == "Kurosol", physeq.B.flt)
physeqB.uniqueC <- prune_taxa(taxa_sums(physeqB.uniqueC ) == 0, physeqB.uniqueC)

physeqF.uniqueK <- prune_samples(sample_data(physeq.F.flt)$Soil == "Chromosol", physeq.F.flt)
physeqF.uniqueK <- prune_taxa(taxa_sums(physeqF.uniqueK) == 0, physeqF.uniqueK )
physeqF.uniqueC <- prune_samples(sample_data(physeq.F.flt)$Soil == "Kurosol", physeq.F.flt)
physeqF.uniqueC <- prune_taxa(taxa_sums(physeqF.uniqueC ) == 0, physeqF.uniqueC )

Z  <- nodes %>% rename(Target = Id) %>% left_join(taxaBF) %>% rename(OTUID = Target) %>% dplyr::select(OTUID,Kingdom, Phylum)
Z1 <- as.data.frame(otu_table(physeqB.uniqueK)) %>% rownames_to_column("OTUID") %>% mutate(presence = "unique Kurosol") %>% dplyr::select(OTUID, presence)
Z2 <- as.data.frame(otu_table(physeqB.uniqueC)) %>% rownames_to_column("OTUID")%>% mutate(presence= "unique Chromosol")%>% dplyr::select(OTUID, presence)
Z3 <- as.data.frame(otu_table(physeqF.uniqueK)) %>% rownames_to_column("OTUID") %>% mutate(presence = "unique Kurosol") %>% dplyr::select(OTUID, presence)
Z4 <- as.data.frame(otu_table(physeqF.uniqueC)) %>% rownames_to_column("OTUID")%>% mutate(presence= "unique Chromosol")%>% dplyr::select(OTUID, presence)
Z5 <- rbind(Z1,Z2,Z3,Z4)%>% as.data.frame()
Z <- Z  %>% left_join(Z5) %>%  mutate_each(funs(replace(., which(is.na(.)), "present in both"))) %>% rename(Id = OTUID)
#write.csv(Z, "~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/gephi/nodes.csv", row.names = TRUE)
```


```{r networkallpicture, fig.cap = "Network of cross-domain (fungi and bacteria together) co-occurances using the SpiecEasi package (glasso) and modified in gephi. Edge lengths are proportional to distance between nodes (Force Atlas). Size of nodes indicate Betweenness Centrality. Nodes are coloured by modules that cluster together more than can be explained by chance (gephi modularity); pink = module 0, jade green = module 1, blue = module 2, darkgrey = module 3, purple = module 4, orange = module 5 , moss green = module 6", include = FALSE, message=FALSE, warning=FALSE, echo=FALSE, fig.width=15, fig.asp = 1, cache = TRUE, eval=FALSE }
knitr::include_graphics("./glassonetwork_allsamples_modules_atlas.png")
```

```{r modulecomposition, include = FALSE, message=FALSE, warning=FALSE, echo=FALSE, cache = TRUE }
#check compostion of modules (fungi/bacteria or uniqueness) 
modules <- read.csv("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/gephi/nodes_modules.csv") 
modules <- modules %>% dplyr::select(Id, kingdom, modularity_class, presence) %>% rename(OTUID = Id)
#
sum <- count(modules %>% filter(modularity_class == 2) %>% filter(kingdom == "D_0__Bacteria")) + count(modules %>% filter(modularity_class == 2) %>% filter(kingdom == "k__Fungi")) 
bac <- count(modules %>% filter(modularity_class == 2) %>% filter(kingdom == "D_0__Bacteria")) / sum * 100
fun <-  count(modules %>% filter(modularity_class == 2) %>% filter(kingdom == "k__Fungi")) / sum * 100
sum <- count(modules %>% filter(modularity_class == 2) %>% filter(presence == "present in both")) + count(modules %>% filter(modularity_class == 2) %>% filter(presence == "unique Kurosol")) + count(modules %>% filter(modularity_class == 2) %>% filter(presence == "unique Chromosol")) 
uniqueK <- count(modules %>% filter(modularity_class == 2) %>% filter(presence == "unique Kurosol")) / sum * 100
uniqueC <- count(modules %>% filter(modularity_class == 2) %>% filter(presence == "unique Chromosol")) / sum * 100
print(paste("Module 2 consisted of ", round((bac$n),2),"% bacteria and ",round((fun$n),2),"% fungi and did not contain any ASVs that were unique to Chromosol. And there were", round((uniqueK$n),2),"% unique ASVs from the Kurosol"))

sum <- count(modules %>% filter(modularity_class == 4) %>% filter(kingdom == "D_0__Bacteria")) + count(modules %>% filter(modularity_class == 4) %>% filter(kingdom == "k__Fungi")) 
bac <- count(modules %>% filter(modularity_class == 4) %>% filter(kingdom == "D_0__Bacteria")) / sum * 100
fun <-  count(modules %>% filter(modularity_class == 4) %>% filter(kingdom == "k__Fungi")) / sum * 100
sum <- count(modules %>% filter(modularity_class == 4) %>% filter(presence == "present in both")) + count(modules %>% filter(modularity_class == 4) %>% filter(presence == "unique Kurosol")) + count(modules %>% filter(modularity_class == 4) %>% filter(presence == "unique Chromosol")) 
uniqueK <- count(modules %>% filter(modularity_class == 4) %>% filter(presence == "unique Kurosol")) / sum * 100
uniqueC <- count(modules %>% filter(modularity_class == 4) %>% filter(presence == "unique Chromosol")) / sum * 100
#module 4 consists of 44% bacteria and 56% fungi and contains almost no unique Kurosol ASVs. 30% of ASVs are unique to Chromosol. 
print(paste("Module 4 consisted of ", round((bac$n),2),"% bacteria and ",round((fun$n),2),"% fungi and and contained almost no unique Kurosol ASVs. In module 4 There were", round((uniqueC$n),2),"% unique ASVs from the Chromosol"))
```

```{r glassoallcor, eval=FALSE, include=FALSE, fig.cap = "", include = FALSE,  message=FALSE, warning=FALSE,echo=FALSE, fig.width=5, fig.asp = 0.8, cache = TRUE }
#create correlations of z-scores of the ASVs in each module to identify ecological preferences of each module
#modules was exported from gephi after running the algorithm there
modules <- read.csv("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/gephi/nodes_modules.csv") 
modules <- modules %>% dplyr::select(Id, kingdom, modularity_class) %>% rename(OTUID = Id)
otusB <- as.data.frame(otu_table(physeq.B.flt))
otusF <- as.data.frame(otu_table(physeq.F.flt))
otusBF <- rbind(otusB, otusF) %>% rownames_to_column("OTUID")
modules <-  modules %>% left_join(otusBF) %>% dplyr::select(-OTUID, -kingdom)
modules <-  modules %>% group_by(modularity_class) %>%  summarise_at(vars(`C01`:`C36`), base::sum) %>% column_to_rownames("modularity_class") 

metadf <- sample_data(physeq.B.flt) %>% data.frame()
physeqBF <- phyloseq(otu_table(modules, taxa_are_rows = T), 
             sample_data(metadata2 %>% as.data.frame() %>% column_to_rownames("#SampleID")))
ps_modulesZ <- microbiome::transform(physeqBF, "Z")
otu_clr <- as.data.frame(otu_table(ps_modulesZ)) %>% t %>% data.frame() %>% rownames_to_column("SampleId")
#correlations of modules to variables 
require(psych)
require(reshape2)
testdf <- data.frame(sample_data(ps_modulesZ))
testdf <- testdf %>% rownames_to_column("SampleId") %>% left_join(otu_clr)
correlation_matrix=corr.test(testdf[,c("D1517","ppDDE", "ppDDT", "DDT1517", "TC","TN","CN",  "HC", "P",   "CP" ,"pH" ,"b_copies_ngDNA" ,"f_copies_ngDNA","Dloss" ,"DDTloss","C_Sand","F_Sand" , "T_Sand","Silt_1", "Clay_1","Organic.Matter", "Field.Capacity", "Wilting.Point", "Kaolinite." ,"Illite.", "Smectite.", "Gibbsite." , "Clay_total","POC.clr","HUM.clr" ,"ROC.clr","POC","HUM" ,"ROC", "H", "X0","X1","X2","X3","X4","X5","X6","X7","X8","X9","X10","X11")], method="spearman", adjust="holm")
r_matrix=correlation_matrix$r
r_matrix[row(r_matrix)>col(r_matrix)]=0
diag(r_matrix)=0
p_matrix=correlation_matrix$p
p_matrix[row(p_matrix)>col(p_matrix)]=1
diag(p_matrix)=1
r_table=melt(r_matrix)
p_table=melt(p_matrix)
cortable <- data.frame(r_table$Var1, r_table$Var2, r_table$value, p_table$value) #creats the table with r and p values

module0_cor <- cortable %>% 
  filter(r_table.Var1 == "X0" | 
           r_table.Var2 == "X0") %>% 
  filter(r_table.value >= 0.6 |
           r_table.value <= -0.6) %>%
  arrange(p_table.value)

module1_cor <- cortable %>% 
  filter(r_table.Var1 == "X1" | 
           r_table.Var2 == "X1") %>% 
  filter(r_table.value >= 0.5 |
           r_table.value <= -0.5) 

module2_cor <- cortable %>% 
  filter(r_table.Var1 == "X2" | 
           r_table.Var2 == "X2") %>% 
  filter(r_table.value >= 0.5 |
           r_table.value <= -0.5) 

module3_cor <- cortable %>% 
  filter(r_table.Var1 == "X3" | 
           r_table.Var2 == "X3") %>% 
  filter(r_table.value >= 0.5 |
           r_table.value <= -0.5) 

module4_cor <- cortable %>% 
  filter(r_table.Var1 == "X4" | 
           r_table.Var2 == "X4") %>% 
  filter(r_table.value >= 0.5 |
           r_table.value <= -0.5)

module5_cor <- cortable %>% 
  filter(r_table.Var1 == "X5" | 
           r_table.Var2 == "X5") %>% 
  filter(r_table.value >= 0.5 |
           r_table.value <= -0.5)

module6_cor <- cortable %>% 
  filter(r_table.Var1 == "X6" | 
           r_table.Var2 == "X6") %>% 
  filter(r_table.value >= 0.5 |
           r_table.value <= -0.5)

module_cor <-  rbind(module1_cor,module2_cor,module3_cor,module4_cor,module5_cor,module6_cor) %>%  arrange(p_table.value)
module_cor %>% filter(p_table.value <= 0.001)
```

```{r networkallpictureunique, fig.cap = "Network of cross-domain (fungi and bacteria together) co-occurances using the SpiecEasi package (glasso) and modified in gephi. Edge lengths are proportional to distance between nodes (Force Atlas). Size of nodes indicate Betweenness Centrality. Green = ASVs unique to the Chromosol, orange = ASVs unique to the Kurosol, grey = ASVs present in both soils", message=FALSE, warning=FALSE, echo=FALSE, fig.width=15, fig.asp = 1, cache = TRUE, include=FALSE, eval=FALSE }
knitr::include_graphics("./glassonetwork_allsamples_modules_atlas_COLOURBYUNIQUEASVs.png")
```




### Kurosol
```{r glassoallKURnotinclud , fig.cap = "", include = FALSE, eval=FALSE, message=FALSE, warning=FALSE, echo=FALSE, fig.width=5, fig.asp = 0.8}

## spiec easi "glasso" bacteria
require(SpiecEasi)
library(phyloseq)
#cross domain (and with 4 cores)
#filtering
physeq.B.flt <- prune_samples(sample_data(physeqB)$Soil == "Kurosol", physeqB) #soil 
physeq.F.flt <- prune_samples(sample_data(physeqF)$Soil == "Kurosol", physeqF) #soil

physeq.B.flt <- prune_samples(sample_data(physeq.B.flt)$Farm != "C", physeq.B.flt) #take out outlier paddock
physeq.F.flt <- prune_samples(sample_data(physeq.F.flt)$Farm != "C", physeq.F.flt) #take out outlier paddock

physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) != 0, physeq.B.flt) 
physeq.F.flt <- prune_taxa(taxa_sums(physeq.F.flt) != 0, physeq.F.flt)

physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) > 10, physeq.B.flt) #must have at least x reads
physeq.F.flt <- prune_taxa(taxa_sums(physeq.F.flt) > 10, physeq.F.flt) #must have at least x reads

physeq.B.flt = filter_taxa(physeq.B.flt , function(x) sum(x > 0) > (0.25*length(x)), TRUE) #must be present in x percent of samples
physeq.F.flt = filter_taxa(physeq.F.flt, function(x) sum(x > 0) > (0.25*length(x)), TRUE) #must be present in x percent of samples
physeq.B.flt
min(taxa_sums(physeq.B.flt))
physeq.F.flt
min(taxa_sums(physeq.F.flt))

#running the network analysis with spieceasi
#pargs2 <- list(rep.num=50, seed=10010, ncores=4,thresh = 0.05)
#t2 <- system.time(
#  sse.physeqBF <- spiec.easi(list(physeq.B.flt, physeq.F.flt), method='glasso', nlambda=30, lambda.min.ratio=1e-2, sel.criterion='stars', pulsar.select=TRUE, pulsar.params = pargs2))
#saveRDS(sse.physeqBF, file = "~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/R_FieldSurvey16s_M2/sse.physeqBF_KUROSOL")
#sse.physeqBFK <- readRDS("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/R_FieldSurvey16s_M2/sse.physeqBF_KUROSOL")
##dtype <- c(rep(1,ntaxa(physeq.B.flt)), rep(2,ntaxa(physeq.F.flt)))
#plot(adj2igraph(getRefit(sse.physeqBFK)),vertex.color=dtype+1, vertex.size=9) #quick look
#ig.glasso <- adj2igraph(getRefit(sse.physeqBF), 
#                        vertex.attr= list(name =c(taxa_names(physeq.B.flt), taxa_names(physeq.F.flt))))
#getStability(sse.physeqBFK) #check how far we are from target stability threshold 0.05
#sum(getRefit(sse.physeqBF))/2
require(gephi)
#gephi_write_edges(ig.glasso, "~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/gephi/sse.physeqBFKUROSOL.csv") #write csv to use for gephi, then use gephi to and export node table 

#edge vectors
#sse.physeqBF_toGephi <- read.csv("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/gephi/sse.physeqBF.csv")
#taxaB <- tax_table(physeq.B.flt)@.Data %>% data.frame() %>% rownames_to_column("Target")
#taxaF <- tax_table(physeq.F.flt)@.Data %>% data.frame() %>% rownames_to_column("Target")
#taxaBF <- rbind(taxaB, taxaF) %>% dplyr::select(Target, Kingdom, Phylum)
#sse.physeqBF_toGephi_edgelabels <- sse.physeqBF_toGephi %>% left_join(taxaBF) 
#write.csv(sse.physeqBF_toGephi_edgelabels , "~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/gephi/sse.physeqBF_toGephi_edgelabels .csv", row.names = FALSE)\


#node vectors
#create a list that defines an ASV as unique in each soil or present in both
#exported nodes from gephi , relabel here and reimport to gephi
#nodes <- read.csv("~/Downloads/nodes_KUROSOL.csv") 

physeqB.lowlossK <- prune_samples(sample_data(physeq.B.flt)$Dloss_fct2 == ">=72%", physeq.B.flt)
physeqB.lowlossK <- prune_taxa(taxa_sums(physeqB.lowlossK) == 0, physeqB.lowlossK)
taxadflowlossK <- tax_table(physeqB.lowlossK)@.Data %>% as.data.frame %>% rownames_to_column("OTUID")
physeqF.lowlossK <- prune_samples(sample_data(physeq.F.flt)$Dloss_fct2 == ">=72%", physeq.F.flt)
physeqF.lowlossK <- prune_taxa(taxa_sums(physeqF.lowlossK) == 0, physeqF.lowlossK)
taxadflowF.lossK <- tax_table(physeqF.lowlossK)@.Data %>% as.data.frame %>% rownames_to_column("OTUID")

# xtaxa not present in the HIGH LOSS part of the Kurosol - ONLY present in the low-loss Kurosol, label = "low"
physeqB.highlossK <- prune_samples(sample_data(physeq.B.flt)$Dloss_fct2 != ">=72%", physeq.B.flt)
physeqB.highlossK <- prune_taxa(taxa_sums(physeqB.highlossK) == 0, physeqB.highlossK)
taxadfhighlossK <- tax_table(physeqB.highlossK)@.Data  %>% as.data.frame %>% rownames_to_column("OTUID")
physeqF.highlossK <- prune_samples(sample_data(physeq.F.flt)$Dloss_fct2 != ">=72%", physeq.F.flt)
physeqF.highlossK <- prune_taxa(taxa_sums(physeqF.highlossK) == 0, physeqF.highlossK)
taxadfhighF.lossK <- tax_table(physeqF.highlossK)@.Data  %>% as.data.frame %>% rownames_to_column("OTUID")
#x taxa not present in the LOW LOSS part of the Kurosol - ONLY present in the HIGH-loss, label = "high"

taxaB <- tax_table(physeq.B.flt)@.Data %>% data.frame() %>% rownames_to_column("Target")
taxaF <- tax_table(physeq.F.flt)@.Data %>% data.frame() %>% rownames_to_column("Target")
taxaBF <- rbind(taxaB, taxaF) %>% dplyr::select(Target, Kingdom, Phylum)

Z  <- nodes %>% rename(Target = Id) %>% left_join(taxaBF) %>% rename(OTUID = Target) %>% dplyr::select(OTUID,Kingdom, Phylum)
Z1 <- as.data.frame(otu_table(physeqB.lowlossK)) %>% rownames_to_column("OTUID") %>% mutate(presence = "unique in low loss") %>% dplyr::select(OTUID, presence)
Z2 <- as.data.frame(otu_table(physeqB.highlossK)) %>% rownames_to_column("OTUID")%>% mutate(presence= "unique in high loss")%>% dplyr::select(OTUID, presence)
Z3 <- as.data.frame(otu_table(physeqF.lowlossK)) %>% rownames_to_column("OTUID") %>% mutate(presence = "unique in low loss") %>% dplyr::select(OTUID, presence)
Z4 <- as.data.frame(otu_table(physeqF.highlossK)) %>% rownames_to_column("OTUID")%>% mutate(presence= "unique in high loss")%>% dplyr::select(OTUID, presence)
Z5 <- rbind(Z1,Z2,Z3,Z4)%>% as.data.frame()
Z <- Z  %>% left_join(Z5) %>%  mutate_each(funs(replace(., which(is.na(.)), "present in both"))) %>% rename(Id = OTUID)
#rename Kingdom vector 
level_key <- c(D_0__Archaea = "A", D_0__Bacteria = "B", k__Fungi = "F")
Z <- Z %>% mutate(Kingdom = recode_factor(Kingdom, !!!level_key)) 

#write.csv(Z, "~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/gephi/nodes_KUROSOL.csv", row.names = FALSE)
```

```{r networkallpictureKUROSOLlowhigh, fig.cap = "Network of cross-domain (fungi (F) and bacteria (B) together) co-occurances of the Kurosol using the SpiecEasi package (glasso) and modified in gephi. Edge lengths are proportional to distance between nodes (Force Atlas). Size of nodes indicate Betweenness Centrality. Red = ASVs unique to the high-loss samples, blue = ASVs unique to low-loss samples, grey = ASVs present in both. Prior to anaysis, ASVs were filtered to those that are present in at least 25% of samples with n = 18.", message=FALSE, warning=FALSE,echo=FALSE, fig.width=15, fig.asp = 1, cache = TRUE}
knitr::include_graphics("./glassonetwork_allsamples_modules_atlas_COLOURBYUNIQUEASVs_KUROSOL.png")
```

\s
The association network of bacteria and fungi in the Kurosol (Fig \@ref(fig:networkallpictureKUROSOLlowhigh)) shows a clear separation of associations that cluster around ASVs that were unique in the high-loss samples and ASVs that were unique in low-loss samples, indicating those unique ASVs were driven by different environmental conditions and were an integral part in mediating associations. 
\s

```{r networkKUROSOLmodules, fig.cap = "Network of cross-domain  (fungi (F) and bacteria (B) together) co-occurances of the Kurosol using the SpiecEasi package (glasso) and modified in gephi. Edge lengths are proportional to distance between nodes (Force Atlas). Size of nodes indicate Betweenness Centrality. Nodes are coloured by modules that cluster together more than can be explained by chance (gephi modularity). Prior to anaysis, ASVs were filtered to those that are present in at least 25% of samples with n = 18.", message=FALSE, warning=FALSE,echo=FALSE, fig.width=15, fig.asp = 1, cache = TRUE}
knitr::include_graphics("./glassonetwork_allsamples_modules_atlas_COLOURBYMODULES_KUROSOL.png")

```

\s
(Fig \@ref(fig:networkKUROSOLmodules))
\s

### Chromosol
```{r glassoallCHRnotinclud , fig.cap = "", include = FALSE,  eval = FALSE, message=FALSE, warning=FALSE,echo=FALSE, fig.width=5, fig.asp = 0.8}

## spiec easi "glasso" bacteria
require(SpiecEasi)
library(phyloseq)
#cross domain (and with 4 cores)
#filtering
physeq.B.flt <- prune_samples(sample_data(physeqB)$Soil == "Chromosol", physeqB) #soil 
physeq.F.flt <- prune_samples(sample_data(physeqF)$Soil == "Chromosol", physeqF) #soil

physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) != 0, physeq.B.flt) 
physeq.F.flt <- prune_taxa(taxa_sums(physeq.F.flt) != 0, physeq.F.flt)

physeq.B.flt <- prune_taxa(taxa_sums(physeq.B.flt) > 10, physeq.B.flt) #must have at least x reads
physeq.F.flt <- prune_taxa(taxa_sums(physeq.F.flt) > 10, physeq.F.flt) #must have at least x reads

physeq.B.flt = filter_taxa(physeq.B.flt , function(x) sum(x > 0) > (0.25*length(x)), TRUE) #must be present in x percent of samples
physeq.F.flt = filter_taxa(physeq.F.flt, function(x) sum(x > 0) > (0.25*length(x)), TRUE) #must be present in x percent of samples
physeq.B.flt
min(taxa_sums(physeq.B.flt))
physeq.F.flt
min(taxa_sums(physeq.F.flt))

#running the network analysis with spieceasi
#pargs2 <- list(rep.num=50, seed=10010, ncores=4,thresh = 0.05)
#t2 <- system.time(
#  sse.physeqBF <- spiec.easi(list(physeq.B.flt, physeq.F.flt), method='glasso', nlambda=30, lambda.min.ratio=1e-2, sel.criterion='stars', pulsar.select=TRUE, pulsar.params = pargs2))
#saveRDS(sse.physeqBF, file = "~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/R_FieldSurvey16s_M2/sse.physeqBF_CHROMOSOL")
#sse.physeqBFC <- readRDS("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/R_FieldSurvey16s_M2/sse.physeqBF_CHROMOSOL")
#dtype <- c(rep(1,ntaxa(physeq.B.flt)), rep(2,ntaxa(physeq.F.flt)))
#plot(adj2igraph(getRefit(sse.physeqBFC)),vertex.color=dtype+1, vertex.size=9) #quick look
#ig.glasso <- adj2igraph(getRefit(sse.physeqBFC), 
#                        vertex.attr= list(name =c(taxa_names(physeq.B.flt), taxa_names(physeq.F.flt))))
#getStability(sse.physeqBFC) #check how far we are from target stability threshold 0.05
#sum(getRefit(sse.physeqBF))/2
require(gephi)
#gephi_write_edges(ig.glasso, "~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/gephi/sse.physeqBFCHROMOSOL.csv") #write csv to use for gephi, then use gephi to and export node table 

#edge vectors
#sse.physeqBF_toGephi <- read.csv("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/gephi/sse.physeqBF.csv")
#taxaB <- tax_table(physeq.B.flt)@.Data %>% data.frame() %>% rownames_to_column("Target")
#taxaF <- tax_table(physeq.F.flt)@.Data %>% data.frame() %>% rownames_to_column("Target")
#taxaBF <- rbind(taxaB, taxaF) %>% dplyr::select(Target, Kingdom, Phylum)
#sse.physeqBF_toGephi_edgelabels <- sse.physeqBF_toGephi %>% left_join(taxaBF) 
#write.csv(sse.physeqBF_toGephi_edgelabels , "~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/gephi/sse.physeqBF_toGephi_edgelabels .csv", row.names = FALSE)\


#node vectors
#create a list that defines an ASV as unique in each soil or present in both
#exported nodes from gephi , relabel here and reimport to gephi
#nodes <- read.csv("~/Downloads/nodes_CHROMOSOL.csv") 

physeqB.lowlossK <- prune_samples(sample_data(physeq.B.flt)$Dloss_fct2 == ">43%", physeq.B.flt)
physeqB.lowlossK <- prune_taxa(taxa_sums(physeqB.lowlossK) == 0, physeqB.lowlossK)
taxadflowlossK <- tax_table(physeqB.lowlossK)@.Data %>% as.data.frame %>% rownames_to_column("OTUID")
physeqF.lowlossK <- prune_samples(sample_data(physeq.F.flt)$Dloss_fct2 == ">43%", physeq.F.flt)
physeqF.lowlossK <- prune_taxa(taxa_sums(physeqF.lowlossK) == 0, physeqF.lowlossK)
taxadflowF.lossK <- tax_table(physeqF.lowlossK)@.Data %>% as.data.frame %>% rownames_to_column("OTUID")

# xtaxa not present in the HIGH LOSS part of the CHromosol - ONLY present in the low-loss Chromsol, label = "low"
physeqB.highlossK <- prune_samples(sample_data(physeq.B.flt)$Dloss_fct2 != ">43%", physeq.B.flt)
physeqB.highlossK <- prune_taxa(taxa_sums(physeqB.highlossK) == 0, physeqB.highlossK)
taxadfhighlossK <- tax_table(physeqB.highlossK)@.Data  %>% as.data.frame %>% rownames_to_column("OTUID")
physeqF.highlossK <- prune_samples(sample_data(physeq.F.flt)$Dloss_fct2 != ">43%", physeq.F.flt)
physeqF.highlossK <- prune_taxa(taxa_sums(physeqF.highlossK) == 0, physeqF.highlossK)
taxadfhighF.lossK <- tax_table(physeqF.highlossK)@.Data  %>% as.data.frame %>% rownames_to_column("OTUID")
#x taxa not present in the LOW LOSS part of the Chromosol - ONLY present in the HIGH-loss, label = "high"

taxaB <- tax_table(physeq.B.flt)@.Data %>% data.frame() %>% rownames_to_column("Target")
taxaF <- tax_table(physeq.F.flt)@.Data %>% data.frame() %>% rownames_to_column("Target")
taxaBF <- rbind(taxaB, taxaF) %>% dplyr::select(Target, Kingdom, Phylum)

Z  <- nodes %>% rename(Target = Id) %>% left_join(taxaBF) %>% rename(OTUID = Target) %>% dplyr::select(OTUID,Kingdom, Phylum)
Z1 <- as.data.frame(otu_table(physeqB.lowlossK)) %>% rownames_to_column("OTUID") %>% mutate(presence = "unique in low loss") %>% dplyr::select(OTUID, presence)
Z2 <- as.data.frame(otu_table(physeqB.highlossK)) %>% rownames_to_column("OTUID")%>% mutate(presence= "unique in high loss")%>% dplyr::select(OTUID, presence)
Z3 <- as.data.frame(otu_table(physeqF.lowlossK)) %>% rownames_to_column("OTUID") %>% mutate(presence = "unique in low loss") %>% dplyr::select(OTUID, presence)
Z4 <- as.data.frame(otu_table(physeqF.highlossK)) %>% rownames_to_column("OTUID")%>% mutate(presence= "unique in high loss")%>% dplyr::select(OTUID, presence)
Z5 <- rbind(Z1,Z2,Z3,Z4)%>% as.data.frame()
Z <- Z  %>% left_join(Z5) %>%  mutate_each(funs(replace(., which(is.na(.)), "present in both"))) %>% rename(Id = OTUID)
#rename Kingdom vector 
level_key <- c(D_0__Archaea = "A", D_0__Bacteria = "B", k__Fungi = "F")
Z <- Z %>% mutate(Kingdom = recode_factor(Kingdom, !!!level_key)) 
#write.csv(Z, "~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/gephi/nodes_CHROMOSOL.csv", row.names = FALSE)
```


```{r networkCHROMOSOLunique, fig.cap = "Network of cross-domain  (fungi (F) and bacteria (B) together) co-occurances of the Chromosol using the SpiecEasi package (glasso) and modified in gephi. Edge lengths are proportional to distance between nodes (Force Atlas). Size of nodes indicate Betweenness Centrality. Red = ASVs unique to the high-loss samples, blue = ASVs unique to low-loss samples, grey = ASVs present in both. Prior to anaysis, ASVs were filtered to those that are present in at least 25% of samples with n = 15.", message=FALSE, warning=FALSE,echo=FALSE, fig.width=15, fig.asp = 1, cache = TRUE}
knitr::include_graphics("./glassonetwork_allsamples_modules_atlas_UNIQUEASVs_CHROMSOL1.png")
```

\s
(Fig \@ref(fig:networkCHROMOSOLunique))
\s

```{r networkCHROMOSOLmodule, fig.cap = "Network of cross-domain  (fungi (F) and bacteria (B) together) co-occurances of the Chromosol using the SpiecEasi package (glasso) and modified in gephi. Edge lengths are proportional to distance between nodes (Force Atlas). Size of nodes indicate Betweenness Centrality. Nodes are coloured by modules that cluster together more than can be explained by chance (gephi modularity). Prior to anaysis, ASVs were filtered to those that are present in at least 25% of samples with n = 15.", message=FALSE, warning=FALSE,echo=FALSE, fig.width=15, fig.asp = 1, cache = TRUE}
knitr::include_graphics("./glassonetwork_modules_atlas_COLOURBYMODULES_CHROMOSOL.png")

```

\s
(Fig \@ref(fig:networkCHROMOSOLmodule))
\s

# Acknowledgements
Josh Vido, Helen Hayden, Matt Kitching, Gene Drendle, Steven Batinovic, Steve Petrovski, Jen Wood, Sarah Knowler

# References

